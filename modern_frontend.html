<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiza Skladnosti s PIA</title>
    
    <!-- PDF.js knjižnica -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Light/Dark Mode Variables */
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #a5b4fc;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
        }
        
        body.dark-mode {
            --bg-main: #0f172a; --bg-card: rgba(30, 41, 59, 0.7);
            --bg-glass: rgba(51, 65, 85, 0.5); --text: #f1f5f9;
            --text-muted: #94a3b8; --border: rgba(148, 163, 184, 0.2);
            --input-bg: rgba(30, 41, 59, 0.5);
        }
        
        body.light-mode {
            --bg-main: #f8fafc; --bg-card: rgba(255, 255, 255, 0.9);
            --bg-glass: rgba(248, 250, 252, 0.8); --text: #0f172a;
            --text-muted: #64748b; --border: rgba(148, 163, 184, 0.3);
            --input-bg: rgba(255, 255, 255, 0.8);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text); min-height: 100vh; overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        body.dark-mode { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        body.light-mode { background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%); }
        
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%;
            width: 200%; height: 200%;
            animation: drift 20s ease-in-out infinite; pointer-events: none; z-index: 0;
        }
        
        body.dark-mode::before {
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
        }
        
        body.light-mode::before {
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
        }
        
        @keyframes drift { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(-10%, 10%) rotate(180deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .hidden { display: none !important; }
        .app-container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .header { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); animation: slideDown 0.6s ease-out; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem; }
        .logo-section h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .logo-section p { color: var(--text-muted); font-size: 0.95rem; }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }
        
        .theme-toggle { width: 50px; height: 50px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-glass); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: all 0.3s ease; }
        .theme-toggle:hover { transform: scale(1.1); background: var(--primary); }
        
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 12px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6); }
        .btn-secondary { background: var(--bg-glass); border: 1px solid var(--border); color: var(--text); backdrop-filter: blur(10px); }
        .btn-secondary:hover:not(:disabled) { border-color: var(--primary-light); background: rgba(99, 102, 241, 0.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.85rem; }
        
        .progress-steps { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); animation: fadeIn 0.8s ease-out 0.2s both; }
        .steps-container { display: flex; justify-content: space-between; position: relative; gap: 1rem; }
        .steps-container::before { content: ''; position: absolute; top: 30px; left: 60px; right: 60px; height: 2px; background: var(--border); z-index: 0; }
        .step { flex: 1; text-align: center; position: relative; z-index: 1; cursor: pointer; transition: transform 0.3s ease; }
        .step:hover { transform: scale(1.05); }
        .step.disabled { cursor: not-allowed; opacity: 0.5; }
        .step.disabled:hover { transform: none; }
        .step-circle { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem; transition: all 0.4s ease; background: var(--bg-card); border: 2px solid var(--border); color: var(--text-muted); }
        .step.active .step-circle { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-color: var(--primary); color: white; box-shadow: 0 0 30px rgba(99, 102, 241, 0.5); animation: pulse 2s ease-in-out infinite; }
        .step.completed .step-circle { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); border-color: var(--success); color: white; }
        .step.completed .step-circle::after { content: '✓'; font-size: 1.5rem; }
        .step-label { font-weight: 600; color: var(--text-muted); transition: color 0.3s ease; }
        .step.active .step-label, .step.completed .step-label { color: var(--text); }
        
        .content-card { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2.5rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.1); animation: fadeIn 0.8s ease-out 0.4s both; min-height: 400px; }
        .section-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text); }
        
        .upload-zone { border: 2px dashed var(--border); border-radius: 20px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.4s ease; background: var(--input-bg); margin: 1.5rem 0; }
        .upload-zone:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); transform: translateY(-5px); }
        .upload-zone.dragging { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); transform: scale(1.02); }
        .upload-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.6; }
        
        .file-list { margin-top: 2rem; display: grid; gap: 1rem; }
        .file-item { backdrop-filter: blur(10px); background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; animation: slideIn 0.4s ease-out; }
        .file-item:hover { border-color: var(--primary-light); transform: translateX(5px); }
        .file-info { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .file-meta { display: flex; flex-direction: column; gap: 0.25rem; flex: 1; }
        .file-actions { display: flex; gap: 0.5rem; align-items: center; }
        .remove-file { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--danger); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .remove-file:hover { background: var(--danger); color: white; }
        .preview-file { background: rgba(99, 102, 241, 0.2); border: 1px solid rgba(99, 102, 241, 0.3); color: var(--primary); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .preview-file:hover { background: var(--primary); color: white; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-size: 0.95rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.875rem 1.25rem; border: 1px solid var(--border); border-radius: 12px; background: var(--input-bg); color: var(--text); font-family: inherit; font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .form-input.error, .form-select.error, .form-textarea.error { border-color: var(--danger); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); animation: shake 0.5s ease; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-input:disabled { opacity: 0.7; cursor: not-allowed; background: var(--bg-alt); }
        .error-message { color: var(--danger); font-size: 0.85rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; animation: slideIn 0.3s ease; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .municipality-display { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .municipality-icon { font-size: 1.5rem; }
        .municipality-info { flex: 1; }
        .municipality-name { font-weight: 600; color: var(--text); font-size: 1.1rem; }
        .municipality-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem; }
        
        .key-data-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 2rem; }
        .key-data-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; transition: all 0.3s ease; }
        .key-data-item:hover { border-color: var(--primary-light); }
        .key-data-item textarea { min-height: 60px; resize: none; overflow: hidden; }
        
        .spinner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(99, 102, 241, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { padding: 1.5rem; border-radius: 16px; border: 1px solid; cursor: pointer; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
        .stat-card.success { background: rgba(16, 185, 129, 0.1); border-color: var(--success); }
        .stat-card.success:hover { background: rgba(16, 185, 129, 0.15); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.2); }
        .stat-card.danger { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); }
        .stat-card.danger:hover { background: rgba(239, 68, 68, 0.15); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.2); }
        .stat-card.info { background: rgba(59, 130, 246, 0.1); border-color: var(--info); }
        .stat-card.info:hover { background: rgba(59, 130, 246, 0.15); box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        
        .results-table { width: 100%; margin-top: 2rem; border-collapse: separate; border-spacing: 0 0.5rem; }
        .results-table thead th { background: var(--bg-card); padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.85rem; }
        .results-table tbody tr { background: var(--bg-card); transition: all 0.3s ease; }
        .results-table tbody tr:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .results-table tbody td { padding: 1rem; vertical-align: top; }
        .results-table tbody td:last-child { max-width: 500px; }
        
        .editable-cell { position: relative; }
        .editable-text { min-height: 60px; width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text); font-family: inherit; font-size: 0.9rem; line-height: 1.5; resize: none; overflow: hidden; }
        .editable-text:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .status-select { padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; border: 1px solid; background: var(--input-bg); color: var(--text); cursor: pointer; }
        .status-select:focus { outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .status-badge { display: inline-block; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        .status-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .status-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .status-info { background: rgba(59, 130, 246, 0.2); color: var(--info); border: 1px solid var(--info); }
        
        .requirement-text { cursor: pointer; color: var(--primary); text-decoration: underline; }
        .requirement-text:hover { color: var(--primary-dark); }
        .truncated { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        
        .actions-bar { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem 1.5rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.2); max-width: 400px; z-index: 1001; opacity: 0; transform: translateX(100px); transition: all 0.4s ease; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }
        
        /* Modal za shranjene seje */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.3); animation: slideDown 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .modal-close { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); transition: all 0.3s ease; }
        .modal-close:hover { color: var(--danger); transform: scale(1.2); }
        .sessions-list { display: grid; gap: 1rem; }
        .session-card { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease; cursor: pointer; }
        .session-card:hover { border-color: var(--primary); transform: translateX(5px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .session-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
        .session-title { font-weight: 600; font-size: 1.1rem; color: var(--text); }
        .session-date { font-size: 0.85rem; color: var(--text-muted); }
        .session-summary { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem; }
        .session-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        
        /* Filter modal */
        .filter-modal-content { max-width: 1000px; }
        .filter-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .filter-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 600; font-size: 1rem; }
        .filter-badge.success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .filter-badge.danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .filter-badge.info { background: rgba(59, 130, 246, 0.2); color: var(--info); border: 1px solid var(--info); }
        .filter-list { display: grid; gap: 1rem; max-height: 60vh; overflow-y: auto; }
        .filter-item { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
        .filter-item-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; }
        .filter-item-id { font-weight: 700; font-size: 1rem; color: var(--primary); }
        .filter-item-title { font-weight: 600; color: var(--text); margin-bottom: 0.5rem; line-height: 1.5; }
        .filter-item-explanation { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; }
        
        /* PDF Viewer Modal */
        .pdf-viewer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 3000; display: flex; flex-direction: column; }
        .pdf-viewer-header { background: var(--bg-card); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .pdf-viewer-title { font-size: 1.1rem; font-weight: 600; color: var(--text); max-width: 50%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pdf-viewer-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .pdf-zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .pdf-zoom-value { font-size: 0.9rem; color: var(--text-muted); min-width: 60px; text-align: center; }
        .pdf-page-nav { display: flex; gap: 0.5rem; align-items: center; }
        .pdf-page-info { font-size: 0.9rem; color: var(--text-muted); min-width: 120px; text-align: center; }
        .pdf-viewer-body { flex: 1; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 2rem; background: #1a1a1a; }
        .pdf-canvas-container { background: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); max-width: 100%; }
        #pdfCanvas { display: block; max-width: 100%; height: auto; }
        .pdf-loading { color: white; font-size: 1.1rem; text-align: center; }
        
        @media (max-width: 768px) {
            .app-container { padding: 1rem; }
            .header-content { flex-direction: column; text-align: center; }
            .steps-container { flex-direction: column; gap: 2rem; }
            .steps-container::before { display: none; }
            .key-data-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; padding: 1.5rem; }
            .pdf-viewer-controls { flex-direction: column; align-items: stretch; gap: 0.5rem; }
            .pdf-viewer-title { max-width: 100%; }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>🏛️ Analiza Skladnosti s PIA</h1>
                    <p>Inteligentna analiza projektne dokumentacije</p>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="app.toggleTheme()" title="Preklopi temo">
                        <span id="theme-icon">🌙</span>
                    </button>
                    <button class="btn btn-secondary" onclick="app.showSessionsModal()">📁 Shranjeno</button>
                    <button class="btn btn-primary" onclick="app.saveProgress()" id="save-btn" style="display: none;">💾 Shrani napredek</button>
                </div>
            </div>
        </div>

        <div class="progress-steps">
            <div class="steps-container">
                <div class="step active" id="step-1" onclick="app.goToStep(1)">
                    <div class="step-circle">1</div>
                    <div class="step-label">Nalaganje</div>
                </div>
                <div class="step disabled" id="step-2" onclick="app.goToStep(2)">
                    <div class="step-circle">2</div>
                    <div class="step-label">Pregled</div>
                </div>
                <div class="step disabled" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Analiza</div>
                </div>
                <div class="step disabled" id="step-4" onclick="app.goToStep(4)">
                    <div class="step-circle">4</div>
                    <div class="step-label">Rezultati</div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <!-- Step 1: Upload -->
            <div id="content-step-1">
                <h2 class="section-title">📤 Nalaganje Dokumentov</h2>
                <div class="form-group">
                    <label class="form-label">Občina</label>
                    <div class="municipality-display">
                        <span class="municipality-icon">🏛️</span>
                        <div class="municipality-info">
                            <div class="municipality-name">Občina Litija</div>
                            <div class="municipality-subtitle">Izbrana občina za analizo</div>
                        </div>
                    </div>
                </div>
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">📄</div>
                    <h3>Povleci datoteke sem ali klikni za izbiro</h3>
                    <p style="color: var(--text-muted); margin-top: 0.5rem;">PDF, Excel ali slike • Največ 50MB</p>
                    <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls,.png,.jpg,.jpeg" style="display: none" onchange="app.handleFileSelect(event)">
                </div>
                <div class="file-list" id="file-list"></div>
                <div class="actions-bar">
                    <button class="btn btn-primary" id="extract-btn" onclick="app.extractData()" disabled>🚀 Začni Analizo</button>
                </div>
            </div>

            <!-- Step 2: Review -->
            <div id="content-step-2" class="hidden">
                <h2 class="section-title">📋 Pregled in Potrditev Podatkov</h2>
                
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.25rem;">A. EUP in Namenska Raba *</h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">* Obvezna polja - brez njih analiza ne bo mogoča</p>
                <div id="eup-raba-container" style="margin-bottom: 2rem;"></div>
                <div id="validation-error" class="error-message" style="display: none;">
                    <span>⚠️</span>
                    <span>Prosimo izpolnite EUP in Namensko rabo za vse pare</span>
                </div>
                
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.25rem;">B. Ključni Podatki Projekta</h3>
                <div class="key-data-grid" id="key-data-grid"></div>
                
                <div class="actions-bar">
                    <button class="btn btn-secondary" onclick="app.previousStep()">← Nazaj</button>
                    <button class="btn btn-primary" onclick="app.confirmAndAnalyze()">Potrdi in Analiziraj →</button>
                </div>
            </div>

            <!-- Step 3: Analysis (prazno, samo loading) -->
            <div id="content-step-3" class="hidden"></div>

            <!-- Step 4: Results -->
            <div id="content-step-4" class="hidden">
                <h2 class="section-title">✅ Rezultati Analize</h2>
                <div class="stats-grid">
                    <div class="stat-card success" onclick="app.showFilteredResults('compliant')">
                        <div class="stat-value" style="color: var(--success);" id="compliant-count">0</div>
                        <div style="color: var(--text-muted);">Skladnih zahtev</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">👆 Klikni za prikaz</div>
                    </div>
                    <div class="stat-card danger" onclick="app.showFilteredResults('non-compliant')">
                        <div class="stat-value" style="color: var(--danger);" id="non-compliant-count">0</div>
                        <div style="color: var(--text-muted);">Neskladnih zahtev</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">👆 Klikni za prikaz</div>
                    </div>
                    <div class="stat-card info" onclick="app.showFilteredResults('not-relevant')">
                        <div class="stat-value" style="color: var(--info);" id="not-relevant-count">0</div>
                        <div style="color: var(--text-muted);">Ni relevantno</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">👆 Klikni za prikaz</div>
                    </div>
                </div>
                <table class="results-table">
                    <thead><tr><th style="width: 80px;">ID</th><th style="width: 250px;">Zahteva</th><th style="width: 150px;">Status</th><th>Obrazložitev</th></tr></thead>
                    <tbody id="results-tbody"></tbody>
                </table>
                <div class="actions-bar">
                    <button class="btn btn-secondary" onclick="app.resetAnalysis()">🔄 Nova Analiza</button>
                    <button class="btn btn-primary" onclick="app.downloadReport()">📥 Prenesi Poročilo</button>
                </div>
            </div>
        </div>

        <div class="spinner-overlay hidden" id="loading-overlay">
            <div><div class="spinner"></div><div style="color: var(--text); font-size: 1.1rem; font-weight: 600; text-align: center;" id="loading-message">Nalagam...</div></div>
        </div>

        <div class="toast" id="toast">
            <div style="font-weight: 600; margin-bottom: 0.25rem;" id="toast-title"></div>
            <div style="color: var(--text-muted); font-size: 0.9rem;" id="toast-message"></div>
        </div>
        
        <!-- Modal za shranjene seje -->
        <div class="modal-overlay" id="sessions-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">📁 Shranjene Analize</h2>
                    <button class="modal-close" onclick="app.closeSessionsModal()">✕</button>
                </div>
                <div id="sessions-list-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">📂</div>
                        <p>Nalagam shranjene analize...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal za filtriran prikaz zahtev -->
        <div class="modal-overlay" id="filter-modal">
            <div class="modal-content filter-modal-content">
                <div class="modal-header">
                    <div class="filter-header">
                        <h2 class="modal-title" id="filter-modal-title">Zahteve</h2>
                        <span class="filter-badge" id="filter-badge"></span>
                    </div>
                    <button class="modal-close" onclick="app.closeFilterModal()">✕</button>
                </div>
                <div class="filter-list" id="filter-list"></div>
            </div>
        </div>
        
        <!-- PDF Viewer Modal -->
        <div id="pdf-viewer-modal" class="pdf-viewer-modal hidden">
            <div class="pdf-viewer-header">
                <div class="pdf-viewer-title" id="pdf-viewer-title">PDF Predogled</div>
                <div class="pdf-viewer-controls">
                    <div class="pdf-zoom-controls">
                        <button class="btn btn-secondary btn-small" onclick="app.pdfZoomOut()" id="pdf-zoom-out">−</button>
                        <span class="pdf-zoom-value" id="pdf-zoom-value">100%</span>
                        <button class="btn btn-secondary btn-small" onclick="app.pdfZoomIn()" id="pdf-zoom-in">+</button>
                    </div>
                    <div class="pdf-page-nav" id="pdf-page-nav" style="display: none;">
                        <button class="btn btn-secondary btn-small" onclick="app.pdfPrevPage()" id="pdf-prev-page">← Prejšnja</button>
                        <span class="pdf-page-info" id="pdf-page-info">Stran 1 / 1</span>
                        <button class="btn btn-secondary btn-small" onclick="app.pdfNextPage()" id="pdf-next-page">Naslednja →</button>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="app.closePdfViewer()">Zapri</button>
                </div>
            </div>
            <div class="pdf-viewer-body" id="pdf-viewer-body">
                <div class="pdf-loading" id="pdf-loading">Nalagam PDF dokument...</div>
                <div class="pdf-canvas-container" id="pdf-canvas-container" style="display: none;">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const KEY_DATA_LABELS = {
            glavni_objekt: 'Objekt (Opis funkcije)',
            vrsta_gradnje: 'Vrsta gradnje',
            klasifikacija_cc_si: 'CC-SI Klasifikacija',
            nezahtevni_objekti: 'Nezahtevni objekti v projektu',
            enostavni_objekti: 'Enostavni objekti v projektu',
            vzdrzevalna_dela: 'Vzdrževalna dela / Manjša rekonstrukcija',
            parcela_objekta: 'Gradbena parcela (št.)',
            stevilke_parcel_ko: 'Vse parcele in K.O.',
            velikost_parcel: 'Skupna velikost parcel',
            velikost_obstojecega_objekta: 'Velikost obstoječega objekta',
            tlorisne_dimenzije: 'Nove tlorisne dimenzije',
            gabariti_etaznost: 'Novi gabarit/Etažnost',
            faktor_zazidanosti_fz: 'Faktor zazidanosti (FZ)',
            faktor_izrabe_fi: 'Faktor izrabe (FI)',
            zelene_povrsine: 'Zelene površine (FZP/m²)',
            naklon_strehe: 'Naklon strehe',
            kritina_barva: 'Kritina/Barva',
            materiali_gradnje: 'Materiali gradnje',
            smer_slemena: 'Smer slemena',
            visinske_kote: 'Višinske kote (k.p., k.s.)',
            odmiki_parcel: 'Odmiki od parcelnih mej',
            komunalni_prikljucki: 'Komunalni priključki/Oskrba'
        };

        const app = {
            currentStep: 1,
            files: [],
            filesMeta: {},
            results: [],
            sessionId: null,
            eupRabaPairs: [],
            keyData: {},
            expandedRows: new Set(),
            hasUnsavedChanges: false,
            saveTimeout: null,
            
            // PDF Viewer state
            pdfDoc: null,
            pdfCurrentPage: 1,
            pdfTotalPages: 0,
            pdfZoom: 1.5,
            pdfLoading: false,
            currentPdfFile: null,

            init() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.body.className = `${savedTheme}-mode`;
                document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '🌙' : '☀️';
                
                const uploadZone = document.getElementById('upload-zone');
                uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragging'); });
                uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragging'));
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragging');
                    this.addFiles(Array.from(e.dataTransfer.files));
                });
            },

            toggleTheme() {
                const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.body.className = `${newTheme}-mode`;
                document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '🌙' : '☀️';
                localStorage.setItem('theme', newTheme);
                this.showToast('success', 'Tema spremenjena', `Aktivirana ${newTheme === 'dark' ? 'temna' : 'svetla'} tema`);
            },

            goToStep(step) {
                if (step === 3) return;
                const stepEl = document.getElementById(`step-${step}`);
                if (stepEl.classList.contains('disabled')) return;
                this.currentStep = step;
                this.updateUI();
            },

            previousStep() { 
                if (this.currentStep > 1) { 
                    this.currentStep--; 
                    this.updateUI(); 
                } 
            },
            
            nextStep() { 
                if (this.currentStep < 4) { 
                    this.currentStep++; 
                    this.updateStepAccess();
                    this.updateUI(); 
                } 
            },

            updateStepAccess() {
                const step2 = document.getElementById('step-2');
                if (this.sessionId) {
                    step2.classList.remove('disabled');
                } else {
                    step2.classList.add('disabled');
                }
                
                const step4 = document.getElementById('step-4');
                if (this.results.length > 0) {
                    step4.classList.remove('disabled');
                } else {
                    step4.classList.add('disabled');
                }
            },

            updateUI() {
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`content-step-${i}`).classList.add('hidden');
                    const stepEl = document.getElementById(`step-${i}`);
                    stepEl.classList.remove('active', 'completed');
                    if (i < this.currentStep) stepEl.classList.add('completed');
                    if (i === this.currentStep) stepEl.classList.add('active');
                }
                document.getElementById(`content-step-${this.currentStep}`).classList.remove('hidden');
            },

            handleFileSelect(event) { this.addFiles(Array.from(event.target.files)); },

            addFiles(newFiles) {
                const validFiles = newFiles.filter(file => {
                    const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                                      'application/vnd.ms-excel', 'image/png', 'image/jpeg', 'image/jpg'];
                    const maxSize = 50 * 1024 * 1024;
                    if (!validTypes.includes(file.type)) { this.showToast('error', 'Napaka', `${file.name} ni podprt format`); return false; }
                    if (file.size > maxSize) { this.showToast('error', 'Napaka', `${file.name} je prevelik (max 50MB)`); return false; }
                    return true;
                });
                this.files.push(...validFiles);
                validFiles.forEach(file => { this.filesMeta[file.name] = { name: file.name, pages: '' }; });
                this.renderFileList();
                if (validFiles.length > 0) {
                    this.showToast('success', 'Datoteke dodane', `Dodanih ${validFiles.length} datotek`);
                    document.getElementById('extract-btn').disabled = false;
                }
            },

            removeFile(index) {
                const fileName = this.files[index].name;
                delete this.filesMeta[fileName];
                this.files.splice(index, 1);
                this.renderFileList();
                this.showToast('info', 'Datoteka odstranjena', fileName);
                if (this.files.length === 0) document.getElementById('extract-btn').disabled = true;
            },

            updatePages(fileName, pages) { if (this.filesMeta[fileName]) this.filesMeta[fileName].pages = pages; },

            renderFileList() {
                const container = document.getElementById('file-list');
                if (this.files.length === 0) { container.innerHTML = ''; return; }
                container.innerHTML = this.files.map((file, index) => `
                    <div class="file-item">
                        <div class="file-info">
                            <span style="font-size: 1.5rem;">📄</span>
                            <div class="file-meta">
                                <div style="font-weight: 600;">${file.name}</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">${this.formatFileSize(file.size)}</div>
                                ${file.type === 'application/pdf' ? `<input type="text" placeholder="Strani (npr. 1-3, 5)" style="margin-top: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 0.85rem;" onchange="app.updatePages('${file.name}', this.value)">` : ''}
                            </div>
                        </div>
                        <div class="file-actions">
                            ${file.type === 'application/pdf' ? `<button class="preview-file" onclick="app.openPdfViewer(${index})">👁️ Predogled</button>` : ''}
                            <button class="remove-file" onclick="app.removeFile(${index})">✕</button>
                        </div>
                    </div>
                `).join('');
            },

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            },

            // PDF Viewer Methods
            async openPdfViewer(fileIndex) {
                const fileItem = this.files[fileIndex];
                if (!fileItem) return;
                
                // fileItem ima strukturo: { id: ..., file: File }
                const file = fileItem.file;
                if (!file || file.type !== 'application/pdf') return;
                
                this.currentPdfFile = file;
                this.pdfCurrentPage = 1;
                this.pdfZoom = 1.5;
                this.pdfLoading = true;
                
                document.getElementById('pdf-viewer-modal').classList.remove('hidden');
                document.getElementById('pdf-viewer-title').textContent = file.name;
                document.getElementById('pdf-loading').style.display = 'block';
                document.getElementById('pdf-canvas-container').style.display = 'none';
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    this.pdfDoc = pdf;
                    this.pdfTotalPages = pdf.numPages;
                    
                    if (this.pdfTotalPages > 1) {
                        document.getElementById('pdf-page-nav').style.display = 'flex';
                    } else {
                        document.getElementById('pdf-page-nav').style.display = 'none';
                    }
                    
                    await this.renderPdfPage(1);
                    this.pdfLoading = false;
                    document.getElementById('pdf-loading').style.display = 'none';
                    document.getElementById('pdf-canvas-container').style.display = 'block';
                } catch (error) {
                    console.error('Napaka pri nalaganju PDF:', error);
                    this.showToast('error', 'Napaka', 'Ni mogoče naložiti PDF dokumenta');
                    this.closePdfViewer();
                }
            },

            async renderPdfPage(pageNum) {
                if (!this.pdfDoc || pageNum < 1 || pageNum > this.pdfTotalPages) return;
                
                this.pdfLoading = true;
                document.getElementById('pdf-zoom-out').disabled = true;
                document.getElementById('pdf-zoom-in').disabled = true;
                document.getElementById('pdf-prev-page').disabled = true;
                document.getElementById('pdf-next-page').disabled = true;
                
                try {
                    const page = await this.pdfDoc.getPage(pageNum);
                    const canvas = document.getElementById('pdfCanvas');
                    const context = canvas.getContext('2d');
                    
                    const viewport = page.getViewport({ scale: this.pdfZoom });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    this.pdfCurrentPage = pageNum;
                    document.getElementById('pdf-page-info').textContent = `Stran ${this.pdfCurrentPage} / ${this.pdfTotalPages}`;
                    document.getElementById('pdf-zoom-value').textContent = `${Math.round(this.pdfZoom * 100)}%`;
                    
                    this.pdfLoading = false;
                    document.getElementById('pdf-zoom-out').disabled = this.pdfZoom <= 0.5;
                    document.getElementById('pdf-zoom-in').disabled = this.pdfZoom >= 3;
                    document.getElementById('pdf-prev-page').disabled = this.pdfCurrentPage <= 1;
                    document.getElementById('pdf-next-page').disabled = this.pdfCurrentPage >= this.pdfTotalPages;
                } catch (error) {
                    console.error('Napaka pri prikazu strani:', error);
                    this.showToast('error', 'Napaka', 'Ni mogoče prikazati strani');
                    this.pdfLoading = false;
                }
            },

            closePdfViewer() {
                document.getElementById('pdf-viewer-modal').classList.add('hidden');
                this.pdfDoc = null;
                this.pdfCurrentPage = 1;
                this.pdfTotalPages = 0;
                this.pdfZoom = 1.5;
                this.currentPdfFile = null;
            },

            pdfPrevPage() {
                if (this.pdfCurrentPage > 1 && !this.pdfLoading) {
                    this.renderPdfPage(this.pdfCurrentPage - 1);
                }
            },

            pdfNextPage() {
                if (this.pdfCurrentPage < this.pdfTotalPages && !this.pdfLoading) {
                    this.renderPdfPage(this.pdfCurrentPage + 1);
                }
            },

            pdfZoomIn() {
                if (this.pdfZoom < 3 && !this.pdfLoading) {
                    this.pdfZoom += 0.25;
                    this.renderPdfPage(this.pdfCurrentPage);
                }
            },

            pdfZoomOut() {
                if (this.pdfZoom > 0.5 && !this.pdfLoading) {
                    this.pdfZoom -= 0.25;
                    this.renderPdfPage(this.pdfCurrentPage);
                }
            },

            async extractData() {
                if (this.files.length === 0) return;
                this.showLoading('Ekstrahiram podatke iz dokumentov...');
                
                try {
                    const formData = new FormData();
                    this.files.forEach(f => formData.append('pdf_files', f.file));
                    formData.append('municipality_slug', 'litija');
                    formData.append('files_meta_json', JSON.stringify(Object.values(this.filesMeta)));
                    
                    const response = await fetch('/extract-data', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('API napaka');
                    const data = await response.json();
                    
                    this.sessionId = data.session_id;
                    this.eupRabaPairs = (data.eup || []).map((eup, i) => ({ eup, raba: (data.namenska_raba || [])[i] || '' }));
                    if (this.eupRabaPairs.length === 0) this.eupRabaPairs = [{ eup: '', raba: '' }];
                    
                    this.keyData = {};
                    Object.keys(KEY_DATA_LABELS).forEach(key => {
                        this.keyData[key] = data[key] || 'Ni podatka v dokumentaciji';
                    });
                    
                    this.renderEupRabaPairs();
                    this.renderKeyData();
                    
                    this.hideLoading();
                    this.showToast('success', 'Podatki ekstrahirani', 'AI je uspešno ekstrahiral ključne podatke');
                    this.updateStepAccess();
                    this.nextStep();
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka', error.message);
                }
            },

            renderEupRabaPairs() {
                const container = document.getElementById('eup-raba-container');
                container.innerHTML = this.eupRabaPairs.map((pair, index) => `
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">EUP ${index + 1} *</label>
                            <input type="text" class="form-input" id="eup-input-${index}" value="${pair.eup}" onchange="app.eupRabaPairs[${index}].eup = this.value; app.clearValidationError();" placeholder="npr. LI-08">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Namenska raba ${index + 1} *</label>
                            <input type="text" class="form-input" id="raba-input-${index}" value="${pair.raba}" onchange="app.eupRabaPairs[${index}].raba = this.value; app.clearValidationError();" placeholder="npr. SSe">
                        </div>
                        ${this.eupRabaPairs.length > 1 ? `<button class="btn btn-secondary" onclick="app.removeEupRabaPair(${index})">✕</button>` : '<div></div>'}
                    </div>
                `).join('') + '<button class="btn btn-secondary" style="margin-bottom: 1.5rem;" onclick="app.addEupRabaPair()">+ Dodaj EUP/Rabo</button>';
            },

            validateEupRaba() {
                let isValid = true;
                const validationError = document.getElementById('validation-error');
                
                this.eupRabaPairs.forEach((pair, index) => {
                    const eupInput = document.getElementById(`eup-input-${index}`);
                    const rabaInput = document.getElementById(`raba-input-${index}`);
                    
                    if (!pair.eup || !pair.eup.trim()) {
                        if (eupInput) eupInput.classList.add('error');
                        isValid = false;
                    } else {
                        if (eupInput) eupInput.classList.remove('error');
                    }
                    
                    if (!pair.raba || !pair.raba.trim()) {
                        if (rabaInput) rabaInput.classList.add('error');
                        isValid = false;
                    } else {
                        if (rabaInput) rabaInput.classList.remove('error');
                    }
                });
                
                if (!isValid) {
                    validationError.style.display = 'flex';
                    validationError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    validationError.style.display = 'none';
                }
                
                return isValid;
            },

            clearValidationError() {
                document.getElementById('validation-error').style.display = 'none';
                this.eupRabaPairs.forEach((pair, index) => {
                    const eupInput = document.getElementById(`eup-input-${index}`);
                    const rabaInput = document.getElementById(`raba-input-${index}`);
                    if (eupInput) eupInput.classList.remove('error');
                    if (rabaInput) rabaInput.classList.remove('error');
                });
            },

            renderKeyData() {
                const container = document.getElementById('key-data-grid');
                container.innerHTML = Object.keys(KEY_DATA_LABELS).map((key, index) => `
                    <div class="key-data-item">
                        <label class="form-label">${KEY_DATA_LABELS[key]}</label>
                        <textarea class="form-input" id="keydata-textarea-${index}" oninput="app.autoResizeTextarea(this)" onchange="app.keyData['${key}'] = this.value">${this.keyData[key]}</textarea>
                    </div>
                `).join('');
                
                setTimeout(() => {
                    Object.keys(KEY_DATA_LABELS).forEach((_, index) => {
                        const textarea = document.getElementById(`keydata-textarea-${index}`);
                        if (textarea) this.autoResizeTextarea(textarea);
                    });
                }, 10);
            },

            addEupRabaPair() { this.eupRabaPairs.push({ eup: '', raba: '' }); this.renderEupRabaPairs(); },
            removeEupRabaPair(index) { this.eupRabaPairs.splice(index, 1); this.renderEupRabaPairs(); },

            async confirmAndAnalyze() {
                if (!this.validateEupRaba()) {
                    this.showToast('error', 'Manjkajoči podatki', 'Prosimo izpolnite EUP in Namensko rabo');
                    return;
                }
                
                this.showLoading('Analiziram skladnost z AI...');
                this.currentStep = 3;
                this.updateUI();
                
                try {
                    const payload = {
                        session_id: this.sessionId,
                        final_eup_list: this.eupRabaPairs.map(p => p.eup).filter(e => e.trim()),
                        final_raba_list: this.eupRabaPairs.map(p => p.raba).filter(r => r.trim()),
                        key_data: this.keyData,
                        selected_ids: [],
                        existing_results_map: {}
                    };
                    
                    const response = await fetch('/analyze-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Napaka pri analizi');
                    const data = await response.json();
                    
                    const resultsMap = data.results_map || {};
                    this.results = (data.zahteve || []).map(req => {
                        const result = resultsMap[req.id] || {};
                        const skladnost = (result.skladnost || '').toLowerCase();
                        
                        return {
                            id: req.id,
                            requirement: req.naslov || 'Neznana zahteva',
                            compliant: skladnost.includes('skladno') && !skladnost.includes('neskladno'),
                            notRelevant: skladnost.includes('ni relevantno'),
                            explanation: result.obrazlozitev || 'Ni obrazložitve',
                            evidence: result.evidence || '',
                            skladnost: result.skladnost || 'Neskladno'
                        };
                    });
                    
                    this.renderResults();
                    this.hideLoading();
                    this.updateStepAccess();
                    
                    const compliantCount = this.results.filter(r => r.compliant).length;
                    const nonCompliantCount = this.results.filter(r => !r.compliant && !r.notRelevant).length;
                    const notRelevantCount = this.results.filter(r => r.notRelevant).length;
                    this.showToast('success', 'Analiza končana', 
                        `${compliantCount} skladnih, ${nonCompliantCount} neskladnih, ${notRelevantCount} ni relevantno`);
                    this.nextStep();
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri analizi', error.message);
                    this.currentStep = 2;
                    this.updateUI();
                }
            },

            renderResults() {
                const compliantCount = this.results.filter(r => r.compliant).length;
                const nonCompliantCount = this.results.filter(r => !r.compliant && !r.notRelevant).length;
                const notRelevantCount = this.results.filter(r => r.notRelevant).length;
                
                document.getElementById('compliant-count').textContent = compliantCount;
                document.getElementById('non-compliant-count').textContent = nonCompliantCount;
                document.getElementById('not-relevant-count').textContent = notRelevantCount;
                
                const tbody = document.getElementById('results-tbody');
                tbody.innerHTML = this.results.map((result, index) => {
                    const isExpanded = this.expandedRows.has(index);
                    const truncatedText = result.requirement.length > 100 ? result.requirement.substring(0, 100) + '...' : result.requirement;
                    
                    return `
                    <tr>
                        <td style="font-weight: 600;">${result.id}</td>
                        <td>
                            <span class="requirement-text" onclick="app.toggleRequirement(${index})" title="Klikni za celoten tekst">
                                ${isExpanded ? result.requirement : truncatedText}
                            </span>
                        </td>
                        <td>
                            <select class="status-select" onchange="app.updateStatus(${index}, this.value)">
                                <option value="Skladno" ${result.compliant ? 'selected' : ''}>Skladno</option>
                                <option value="Neskladno" ${!result.compliant && !result.notRelevant ? 'selected' : ''}>Neskladno</option>
                                <option value="Ni relevantno" ${result.notRelevant ? 'selected' : ''}>Ni relevantno</option>
                            </select>
                        </td>
                        <td class="editable-cell">
                            <textarea class="editable-text" id="textarea-${index}" oninput="app.autoResizeTextarea(this)" onchange="app.updateExplanation(${index}, this.value)">${result.explanation}</textarea>
                        </td>
                    </tr>
                `}).join('');
                
                setTimeout(() => {
                    this.results.forEach((_, index) => {
                        const textarea = document.getElementById(`textarea-${index}`);
                        if (textarea) this.autoResizeTextarea(textarea);
                    });
                }, 10);
            },

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight + 4) + 'px';
            },

            toggleRequirement(index) {
                if (this.expandedRows.has(index)) {
                    this.expandedRows.delete(index);
                } else {
                    this.expandedRows.add(index);
                }
                this.renderResults();
            },

            updateStatus(index, newStatus) {
                this.results[index].skladnost = newStatus;
                this.results[index].compliant = newStatus === 'Skladno';
                this.results[index].notRelevant = newStatus === 'Ni relevantno';
                this.renderResults();
                this.markAsChanged();
                this.showToast('info', 'Status posodobljen', `Zahteva ${this.results[index].id}`);
            },

            updateExplanation(index, newExplanation) {
                this.results[index].explanation = newExplanation;
                this.markAsChanged();
                this.showToast('info', 'Obrazložitev posodobljena', `Zahteva ${this.results[index].id}`);
            },

            markAsChanged() {
                this.hasUnsavedChanges = true;
                this.showSaveButton();
                
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.autoSaveProgress();
                }, 3000);
            },

            showSaveButton() {
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) saveBtn.style.display = 'inline-block';
            },

            hideSaveButton() {
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) saveBtn.style.display = 'none';
            },

            async saveProgress() {
                if (!this.sessionId) return;
                
                this.showLoading('Shranjujem spremembe...');
                
                try {
                    const sessionData = {
                        results_map: {},
                        zahteve: this.results.map(r => ({
                            id: r.id,
                            naslov: r.requirement
                        })),
                        metadata: {},
                        key_data: this.keyData,
                        eup: this.eupRabaPairs.map(p => p.eup),
                        namenska_raba: this.eupRabaPairs.map(p => p.raba)
                    };
                    
                    this.results.forEach(r => {
                        sessionData.results_map[r.id] = {
                            skladnost: r.skladnost,
                            obrazlozitev: r.explanation,
                            evidence: r.evidence || ''
                        };
                    });
                    
                    const payload = {
                        session_id: this.sessionId,
                        data: sessionData,
                        project_name: `Analiza ${new Date().toLocaleDateString('sl-SI')}`,
                        summary: `${this.results.length} zahtev analiziranih`
                    };
                    
                    const response = await fetch('/save-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Napaka pri shranjevanju');
                    
                    this.hasUnsavedChanges = false;
                    this.hideSaveButton();
                    this.hideLoading();
                    this.showToast('success', 'Shranjeno', 'Spremembe so bile uspešno shranjene');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri shranjevanju', error.message);
                }
            },

            async autoSaveProgress() {
                if (!this.hasUnsavedChanges || !this.sessionId) return;
                await this.saveProgress();
            },

            resetAnalysis() {
                this.currentStep = 1;
                this.files = [];
                this.filesMeta = {};
                this.results = [];
                this.sessionId = null;
                this.eupRabaPairs = [];
                this.keyData = {};
                this.expandedRows.clear();
                document.getElementById('file-input').value = '';
                this.renderFileList();
                this.updateStepAccess();
                this.updateUI();
                document.getElementById('extract-btn').disabled = true;
                this.showToast('info', 'Resetirano', 'Začni novo analizo');
            },

            async downloadReport() {
                if (!this.sessionId) {
                    this.showToast('error', 'Napaka', 'Seja ni aktivna');
                    return;
                }
                
                if (this.hasUnsavedChanges) {
                    await this.saveProgress();
                }
                
                this.showLoading('Pripravljam poročilo z vašimi spremembami...');
                
                try {
                    const payload = {
                        session_id: this.sessionId,
                        excluded_ids: []
                    };
                    
                    const response = await fetch('/confirm-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Napaka pri generiranju poročila');
                    const data = await response.json();
                    
                    if (data.docx_path) {
                        const docxResponse = await fetch(`/${data.docx_path}`);
                        const blob = await docxResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.docx_path.split('/').pop();
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                    
                    if (data.xlsx_path) {
                        setTimeout(async () => {
                            const xlsxResponse = await fetch(`/${data.xlsx_path}`);
                            const blob = await xlsxResponse.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = data.xlsx_path.split('/').pop();
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 1000);
                    }
                    
                    this.hideLoading();
                    this.showToast('success', 'Poročilo pripravljeno', 'Word dokument vključuje vse vaše spremembe');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri prenosu', error.message);
                }
            },

            async showSessionsModal() {
                document.getElementById('sessions-modal').classList.add('show');
                await this.loadSessions();
            },

            closeSessionsModal() {
                document.getElementById('sessions-modal').classList.remove('show');
            },

            showFilteredResults(filterType) {
                let filteredResults = [];
                let title = '';
                let badgeClass = '';
                let badgeText = '';
                
                if (filterType === 'compliant') {
                    filteredResults = this.results.filter(r => r.compliant);
                    title = 'Skladne Zahteve';
                    badgeClass = 'success';
                    badgeText = `${filteredResults.length} Skladnih`;
                } else if (filterType === 'non-compliant') {
                    filteredResults = this.results.filter(r => !r.compliant && !r.notRelevant);
                    title = 'Neskladne Zahteve';
                    badgeClass = 'danger';
                    badgeText = `${filteredResults.length} Neskladnih`;
                } else if (filterType === 'not-relevant') {
                    filteredResults = this.results.filter(r => r.notRelevant);
                    title = 'Zahteve - Ni Relevantno';
                    badgeClass = 'info';
                    badgeText = `${filteredResults.length} Ni Relevantno`;
                }
                
                document.getElementById('filter-modal-title').textContent = title;
                const badge = document.getElementById('filter-badge');
                badge.className = `filter-badge ${badgeClass}`;
                badge.textContent = badgeText;
                
                const filterList = document.getElementById('filter-list');
                if (filteredResults.length === 0) {
                    filterList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><p>Ni zahtev v tej kategoriji</p></div>';
                } else {
                    filterList.innerHTML = filteredResults.map(result => `
                        <div class="filter-item">
                            <div class="filter-item-header">
                                <span class="filter-item-id">${result.id}</span>
                                <span class="status-badge status-${badgeClass}">${result.skladnost}</span>
                            </div>
                            <div class="filter-item-title">${result.requirement}</div>
                            <div class="filter-item-explanation">${result.explanation}</div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('filter-modal').classList.add('show');
            },

            closeFilterModal() {
                document.getElementById('filter-modal').classList.remove('show');
            },

            async loadSessions() {
                const container = document.getElementById('sessions-list-container');
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📂</div><p>Nalagam shranjene analize...</p></div>';
                
                try {
                    const response = await fetch('/saved-sessions');
                    if (!response.ok) throw new Error('Napaka pri nalaganju sej');
                    const data = await response.json();
                    
                    if (data.sessions && data.sessions.length > 0) {
                        container.innerHTML = '<div class="sessions-list">' + 
                            data.sessions.map(session => `
                                <div class="session-card">
                                    <div class="session-header">
                                        <div class="session-title">${session.project_name || 'Neimenovan projekt'}</div>
                                        <div class="session-date">${this.formatDate(session.updated_at)}</div>
                                    </div>
                                    <div class="session-summary">${session.summary || 'Brez povzetka'}</div>
                                    <div class="session-actions">
                                        <button class="btn btn-primary btn-small" onclick="app.loadSession('${session.session_id}')">📂 Odpri</button>
                                        <button class="btn btn-secondary btn-small" onclick="app.deleteSession('${session.session_id}')">🗑️ Izbriši</button>
                                    </div>
                                </div>
                            `).join('') + '</div>';
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📂</div><p>Trenutno ni shranjenih analiz</p></div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><p>Napaka pri nalaganju: ' + error.message + '</p></div>';
                }
            },

            async loadSession(sessionId) {
                this.closeSessionsModal();
                this.showLoading('Nalagam shranjeno analizo...');
                
                try {
                    const response = await fetch(`/saved-sessions/${sessionId}`);
                    if (!response.ok) throw new Error('Seja ne obstaja');
                    const data = await response.json();
                    
                    this.sessionId = sessionId;
                    const sessionData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;
                    
                    this.eupRabaPairs = (sessionData.eup || []).map((eup, i) => ({
                        eup,
                        raba: (sessionData.namenska_raba || [])[i] || ''
                    }));
                    if (this.eupRabaPairs.length === 0) this.eupRabaPairs = [{ eup: '', raba: '' }];
                    
                    this.keyData = sessionData.key_data || {};
                    
                    const resultsMap = sessionData.results_map || {};
                    this.results = (sessionData.zahteve || []).map(req => {
                        const result = resultsMap[req.id] || {};
                        const skladnost = (result.skladnost || '').toLowerCase();
                        
                        return {
                            id: req.id,
                            requirement: req.naslov || 'Neznana zahteva',
                            compliant: skladnost.includes('skladno') && !skladnost.includes('neskladno'),
                            notRelevant: skladnost.includes('ni relevantno'),
                            explanation: result.obrazlozitev || 'Ni obrazložitve',
                            evidence: result.evidence || '',
                            skladnost: result.skladnost || 'Neskladno'
                        };
                    });
                    
                    this.renderEupRabaPairs();
                    this.renderKeyData();
                    this.renderResults();
                    this.updateStepAccess();
                    
                    this.currentStep = 4;
                    this.updateUI();
                    
                    this.hideLoading();
                    this.showToast('success', 'Analiza naložena', 'Lahko nadaljujete z urejanjem');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri nalaganju', error.message);
                }
            },

            async deleteSession(sessionId) {
                if (!confirm('Ali ste prepričani, da želite izbrisati to analizo?')) return;
                
                try {
                    const response = await fetch(`/saved-sessions/${sessionId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Napaka pri brisanju');
                    
                    this.showToast('success', 'Izbrisano', 'Analiza je bila izbrisana');
                    await this.loadSessions();
                } catch (error) {
                    this.showToast('error', 'Napaka pri brisanju', error.message);
                }
            },

            formatDate(dateString) {
                if (!dateString) return 'Neznano';
                const date = new Date(dateString);
                return date.toLocaleDateString('sl-SI', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            showLoading(message) {
                document.getElementById('loading-message').textContent = message;
                document.getElementById('loading-overlay').classList.remove('hidden');
            },

            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            },

            showToast(type, title, message) {
                const toast = document.getElementById('toast');
                toast.className = `toast toast-${type}`;
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-message').textContent = message;
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => toast.classList.remove('show'), 4000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>