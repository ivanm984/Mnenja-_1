<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiza Skladnosti s PIA</title>
    
    <!-- PDF.js knji≈ænica -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Light/Dark Mode Variables */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --pdf-panel-width: 50vw;
            --pdf-panel-max-width: 900px;
        }
        
        body.dark-mode {
            --bg-main: #0f172a; --bg-card: rgba(30, 41, 59, 0.7);
            --bg-glass: rgba(51, 65, 85, 0.5); --text: #f1f5f9;
            --text-muted: #94a3b8; --border: rgba(148, 163, 184, 0.2);
            --input-bg: rgba(30, 41, 59, 0.5);
        }
        
        body.light-mode {
            --bg-main: #f8fafc; --bg-card: rgba(255, 255, 255, 0.9);
            --bg-glass: rgba(248, 250, 252, 0.8); --text: #0f172a;
            --text-muted: #64748b; --border: rgba(148, 163, 184, 0.3);
            --input-bg: rgba(255, 255, 255, 0.8);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text); min-height: 100vh; overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        body.dark-mode { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        body.light-mode { background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%); }
        
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%;
            width: 200%; height: 200%;
            animation: drift 20s ease-in-out infinite; pointer-events: none; z-index: 0;
        }
        
        body.dark-mode::before {
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
        }
        
        body.light-mode::before {
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
        }
        
        @keyframes drift { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(-10%, 10%) rotate(180deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes progressShimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        
        .hidden { display: none !important; }
        .app-container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 2rem; transition: margin 0.35s ease, width 0.35s ease, max-width 0.35s ease; }
        .progress-bar-container { position: fixed; top: 0; left: 0; right: 0; z-index: 4000; background: var(--bg-card); border-bottom: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); transform: translateY(-100%); transition: transform 0.3s ease; }
        .progress-bar-container.active { transform: translateY(0); }
        .progress-bar-content { padding: 1rem 2rem; display: flex; align-items: center; gap: 1rem; }
        .progress-bar-info { flex: 1; min-width: 0; }
        .progress-bar-title { font-weight: 600; color: var(--text); margin-bottom: 0.25rem; font-size: 0.95rem; }
        .progress-bar-message { font-size: 0.85rem; color: var(--text-muted); }
        .progress-bar-track { flex: 2; height: 8px; background: var(--input-bg); border-radius: 4px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); border-radius: 4px; transition: width 0.3s ease; position: relative; overflow: hidden; }
        .progress-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); animation: progressShimmer 1.5s infinite; }
        .progress-bar-percentage { font-size: 0.9rem; font-weight: 600; color: var(--text); min-width: 45px; text-align: right; }
        .progress-bar-spinner { width: 20px; height: 20px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        body.pdf-viewer-active .app-container {
            margin: 0;
            margin-left: min(var(--pdf-panel-width), var(--pdf-panel-max-width));
            width: clamp(320px, calc(100vw - min(var(--pdf-panel-width), var(--pdf-panel-max-width)) - 4rem), 1400px);
            max-width: clamp(320px, calc(100vw - min(var(--pdf-panel-width), var(--pdf-panel-max-width)) - 4rem), 1400px);
        }
        .header { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); animation: slideDown 0.6s ease-out; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem; }
        .logo-section h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .logo-section p { color: var(--text-muted); font-size: 0.95rem; }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }
        
        .theme-toggle { width: 50px; height: 50px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-glass); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: all 0.3s ease; }
        .theme-toggle:hover { transform: scale(1.1); background: var(--primary); }
        
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 12px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6); }
        .btn-secondary { background: var(--bg-glass); border: 1px solid var(--border); color: var(--text); backdrop-filter: blur(10px); }
        .btn-secondary:hover:not(:disabled) { border-color: var(--primary-light); background: rgba(99, 102, 241, 0.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.85rem; }
        
        .progress-steps { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); animation: fadeIn 0.8s ease-out 0.2s both; }
        .steps-container { display: flex; justify-content: space-between; position: relative; gap: 1rem; }
        .steps-container::before { content: ''; position: absolute; top: 30px; left: 60px; right: 60px; height: 2px; background: var(--border); z-index: 0; }
        .step { flex: 1; text-align: center; position: relative; z-index: 1; cursor: pointer; transition: transform 0.3s ease; }
        .step:hover { transform: scale(1.05); }
        .step.disabled { cursor: not-allowed; opacity: 0.5; }
        .step.disabled:hover { transform: none; }
        .step-circle { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem; transition: all 0.4s ease; background: var(--bg-card); border: 2px solid var(--border); color: var(--text-muted); }
        .step.active .step-circle { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-color: var(--primary); color: white; box-shadow: 0 0 30px rgba(99, 102, 241, 0.5); animation: pulse 2s ease-in-out infinite; }
        .step.completed .step-circle { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); border-color: var(--success); color: white; }
        .step.completed .step-circle::after { content: '‚úì'; font-size: 1.5rem; }
        .step-label { font-weight: 600; color: var(--text-muted); transition: color 0.3s ease; }
        .step.active .step-label, .step.completed .step-label { color: var(--text); }
        
        .content-card { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2.5rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.1); animation: fadeIn 0.8s ease-out 0.4s both; min-height: 400px; }
        .section-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text); }
        
        .upload-zone { border: 2px dashed var(--border); border-radius: 20px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.4s ease; background: var(--input-bg); margin: 1.5rem 0; }
        .upload-zone:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); transform: translateY(-5px); }
        .upload-zone.dragging { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); transform: scale(1.02); }
        .upload-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.6; }
        
        .file-list { margin-top: 2rem; display: grid; gap: 1rem; }
        .file-item { backdrop-filter: blur(10px); background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; animation: slideIn 0.4s ease-out; }
        .file-item:hover { border-color: var(--primary-light); transform: translateX(5px); }
        .file-info { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .file-meta { display: flex; flex-direction: column; gap: 0.25rem; flex: 1; }
        .file-actions { display: flex; gap: 0.5rem; align-items: center; }
        .remove-file { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--danger); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .remove-file:hover { background: var(--danger); color: white; }
        .preview-file { background: rgba(99, 102, 241, 0.2); border: 1px solid rgba(99, 102, 241, 0.3); color: var(--primary); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .preview-file:hover { background: var(--primary); color: white; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-size: 0.95rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.875rem 1.25rem; border: 1px solid var(--border); border-radius: 12px; background: var(--input-bg); color: var(--text); font-family: inherit; font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .form-input.error, .form-select.error, .form-textarea.error { border-color: var(--danger); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); animation: shake 0.5s ease; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-input:disabled { opacity: 0.7; cursor: not-allowed; background: var(--bg-alt); }
        .error-message { color: var(--danger); font-size: 0.85rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; animation: slideIn 0.3s ease; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .municipality-display { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .municipality-icon { font-size: 1.5rem; }
        .municipality-info { flex: 1; }
        .municipality-name { font-weight: 600; color: var(--text); font-size: 1.1rem; }
        .municipality-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem; }
        
        .key-data-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 2rem; }
        .key-data-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; transition: all 0.3s ease; }
        .key-data-item:hover { border-color: var(--primary-light); }
        .key-data-item textarea { min-height: 60px; resize: none; overflow: hidden; }

        .gurs-card { margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: stretch; padding: 1.75rem; border-radius: 20px; border: 1px solid var(--border); background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(79, 70, 229, 0.08) 100%); box-shadow: 0 20px 35px -20px rgba(79, 70, 229, 0.45); }
        body.light-mode .gurs-card { background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(165, 180, 252, 0.12) 100%); }
        .gurs-card h3 { font-size: 1.35rem; font-weight: 700; color: var(--text); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.65rem; }
        .gurs-card p { color: var(--text-muted); line-height: 1.6; font-size: 0.95rem; }
        .gurs-meta { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem; }
        .gurs-pill { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.45rem 0.95rem; border-radius: 999px; background: rgba(15, 23, 42, 0.2); color: var(--text); font-weight: 600; font-size: 0.9rem; letter-spacing: 0.01em; backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.1); }
        body.light-mode .gurs-pill { background: rgba(99, 102, 241, 0.12); border-color: rgba(99, 102, 241, 0.25); }
        .gurs-pill span { font-weight: 500; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .gurs-actions { display: flex; flex-direction: column; gap: 1rem; margin-left: auto; justify-content: center; min-width: 220px; }
        .gurs-actions .btn { width: 100%; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1rem; }
        .gurs-footnote { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; margin-top: 1rem; display: flex; align-items: flex-start; gap: 0.5rem; }
        .gurs-footnote strong { color: var(--text); font-weight: 600; }

        .spinner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(99, 102, 241, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { padding: 1.5rem; border-radius: 16px; border: 1px solid; cursor: pointer; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
        .stat-card.success { background: rgba(16, 185, 129, 0.1); border-color: var(--success); }
        .stat-card.success:hover { background: rgba(16, 185, 129, 0.15); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.2); }
        .stat-card.danger { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); }
        .stat-card.danger:hover { background: rgba(239, 68, 68, 0.15); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.2); }
        .stat-card.info { background: rgba(59, 130, 246, 0.1); border-color: var(--info); }
        .stat-card.info:hover { background: rgba(59, 130, 246, 0.15); box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        
        .results-table { width: 100%; margin-top: 2rem; border-collapse: separate; border-spacing: 0 0.5rem; }
        .results-table thead th { background: var(--bg-card); padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.85rem; }
        .results-table tbody tr { background: var(--bg-card); transition: all 0.3s ease; }
        .results-table tbody tr:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .results-table tbody td { padding: 1rem; vertical-align: top; }
        .results-table tbody td:last-child { max-width: 500px; }
        
        .editable-cell { position: relative; }
        .editable-text { min-height: 60px; width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text); font-family: inherit; font-size: 0.9rem; line-height: 1.5; resize: none; overflow: hidden; }
        .editable-text:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .status-select { padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; border: 1px solid; background: var(--input-bg); color: var(--text); cursor: pointer; }
        .status-select:focus { outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .status-badge { display: inline-block; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        .status-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .status-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .status-info { background: rgba(59, 130, 246, 0.2); color: var(--info); border: 1px solid var(--info); }
        
        .requirement-text { cursor: pointer; color: var(--primary); text-decoration: underline; }
        .requirement-text:hover { color: var(--primary-dark); }
        .truncated { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        
        .actions-bar { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem 1.5rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.2); max-width: 400px; z-index: 1001; opacity: 0; transform: translateX(100px); transition: all 0.4s ease; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }
        
        /* Modal za shranjene seje */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.3); animation: slideDown 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .modal-close { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); transition: all 0.3s ease; }
        .modal-close:hover { color: var(--danger); transform: scale(1.2); }
        .sessions-list { display: grid; gap: 1rem; }
        .session-card { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease; cursor: pointer; }
        .session-card:hover { border-color: var(--primary); transform: translateX(5px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .session-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
        .session-title { font-weight: 600; font-size: 1.1rem; color: var(--text); }
        .session-date { font-size: 0.85rem; color: var(--text-muted); }
        .session-summary { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem; }
        .session-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        
        /* Filter modal */
        .filter-modal-content { max-width: 1000px; }
        .filter-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .filter-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 600; font-size: 1rem; }
        .filter-badge.success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .filter-badge.danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .filter-badge.info { background: rgba(59, 130, 246, 0.2); color: var(--info); border: 1px solid var(--info); }
        .filter-list { display: grid; gap: 1rem; max-height: 60vh; overflow-y: auto; }
        .filter-item { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
        .filter-item-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; }
        .filter-item-id { font-weight: 700; font-size: 1rem; color: var(--primary); }
        .filter-item-title { font-weight: 600; color: var(--text); margin-bottom: 0.5rem; line-height: 1.5; }
        .filter-item-explanation { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; }
        
        /* PDF Viewer Modal */
        .pdf-viewer-modal { position: fixed; top: 0; left: 0; width: min(var(--pdf-panel-width), var(--pdf-panel-max-width)); height: 100%; background: var(--bg-card); z-index: 3000; display: flex; flex-direction: column; border-right: 1px solid var(--border); box-shadow: 12px 0 40px rgba(15, 23, 42, 0.35); transform: translateX(-100%); transition: transform 0.35s ease; }
        .pdf-viewer-modal.open { transform: translateX(0); }
        .pdf-viewer-modal.resizing { transition: none; }
        .pdf-resize-handle { position: absolute; top: 0; right: -6px; width: 12px; height: 100%; cursor: ew-resize; z-index: 10; display: block; }
        .pdf-resize-handle::after { content: ''; position: absolute; top: 50%; right: 4px; width: 2px; height: 60px; background: var(--border); border-radius: 2px; transform: translateY(-50%); }
        .pdf-viewer-header { background: var(--bg-card); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18); }
        .pdf-viewer-title { font-size: 1.1rem; font-weight: 600; color: var(--text); max-width: 50%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pdf-viewer-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .pdf-zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .pdf-zoom-value { font-size: 0.9rem; color: var(--text-muted); min-width: 60px; text-align: center; }
        .pdf-page-nav { display: flex; gap: 0.5rem; align-items: center; }
        .pdf-page-info { font-size: 0.9rem; color: var(--text-muted); min-width: 120px; text-align: center; }
        .pdf-viewer-body { flex: 1; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 2rem; background: rgba(15, 23, 42, 0.9); }
        .pdf-canvas-container { background: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); max-width: 100%; border-radius: 12px; overflow: hidden; }
        #pdfCanvas { display: block; max-width: 100%; height: auto; }
        .pdf-loading { color: white; font-size: 1.1rem; text-align: center; }

        @media (max-width: 1024px) {
            .pdf-viewer-modal { width: 100vw; max-width: 100vw; }
            body.pdf-viewer-active .app-container { margin-left: 0; max-width: 1400px; display: none; }
            .pdf-resize-handle { display: none; }
        }

        @media (max-width: 768px) {
            .app-container { padding: 1rem; }
            .header-content { flex-direction: column; text-align: center; }
            .steps-container { flex-direction: column; gap: 2rem; }
            .steps-container::before { display: none; }
            .key-data-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; padding: 1.5rem; }
            .pdf-viewer-controls { flex-direction: column; align-items: stretch; gap: 0.5rem; }
            .pdf-viewer-title { max-width: 100%; }
            .pdf-viewer-modal { width: 100vw; border-right: none; box-shadow: none; }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="progress-bar-container" id="progress-bar">
        <div class="progress-bar-content">
            <div class="progress-bar-spinner"></div>
            <div class="progress-bar-info">
                <div class="progress-bar-title" id="progress-title">Procesiranje...</div>
                <div class="progress-bar-message" id="progress-message">Pripravljam dokumente</div>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="progress-bar-percentage" id="progress-percentage">0%</div>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>üèõÔ∏è Analiza Skladnosti s PIA</h1>
                    <p>Inteligentna analiza projektne dokumentacije</p>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="app.toggleTheme()" title="Preklopi temo">
                        <span id="theme-icon">üåô</span>
                    </button>
                    <button class="btn btn-secondary" onclick="app.showSessionsModal()">üìÅ Shranjeno</button>
                    <button class="btn btn-primary" onclick="app.saveProgress()" id="save-btn" style="display: none;">üíæ Shrani napredek</button>
                </div>
            </div>
        </div>

        <div class="progress-steps">
            <div class="steps-container">
                <div class="step active" id="step-1" onclick="app.goToStep(1)">
                    <div class="step-circle">1</div>
                    <div class="step-label">Nalaganje</div>
                </div>
                <div class="step disabled" id="step-2" onclick="app.goToStep(2)">
                    <div class="step-circle">2</div>
                    <div class="step-label">Pregled</div>
                </div>
                <div class="step disabled" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Analiza</div>
                </div>
                <div class="step disabled" id="step-4" onclick="app.goToStep(4)">
                    <div class="step-circle">4</div>
                    <div class="step-label">Rezultati</div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <!-- Step 1: Upload -->
            <div id="content-step-1">
                <h2 class="section-title">üì§ Nalaganje Dokumentov</h2>
                <div class="form-group">
                    <label class="form-label">Obƒçina</label>
                    <div class="municipality-display">
                        <span class="municipality-icon">üèõÔ∏è</span>
                        <div class="municipality-info">
                            <div class="municipality-name">Obƒçina Litija</div>
                            <div class="municipality-subtitle">Izbrana obƒçina za analizo</div>
                        </div>
                    </div>
                </div>
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">üìÑ</div>
                    <h3>Povleci datoteke sem ali klikni za izbiro</h3>
                    <p style="color: var(--text-muted); margin-top: 0.5rem;">PDF, Excel ali slike ‚Ä¢ Najveƒç 50MB</p>
                    <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls,.png,.jpg,.jpeg" style="display: none" onchange="app.handleFileSelect(event)">
                </div>
                <div class="file-list" id="file-list"></div>
                <div class="actions-bar">
                    <button class="btn btn-primary" id="extract-btn" onclick="app.extractData()" disabled>üöÄ Zaƒçni Analizo</button>
                </div>
            </div>

            <!-- Step 2: Review -->
            <div id="content-step-2" class="hidden">
                <h2 class="section-title">üìã Pregled in Potrditev Podatkov</h2>
                
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.25rem;">A. EUP in Namenska Raba *</h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">* Obvezna polja - brez njih analiza ne bo mogoƒça</p>
                <div id="eup-raba-container" style="margin-bottom: 2rem;"></div>
                <div id="validation-error" class="error-message" style="display: none;">
                    <span>‚ö†Ô∏è</span>
                    <span>Prosimo izpolnite EUP in Namensko rabo za vse pare</span>
                </div>
                
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.25rem;">B. Kljuƒçni Podatki Projekta</h3>
                <div class="key-data-grid" id="key-data-grid"></div>

                <div class="gurs-card" id="gurs-card">
                    <div style="flex: 1 1 320px; min-width: 260px;">
                        <h3>üó∫Ô∏è Prostorski pregled GURS</h3>
                        <p>
                            Hitro preveri ortofoto, parcelne ≈°tevilke in namensko rabo prostora neposredno preko GURS WFS.
                            Podatki se samodejno napolnijo iz AI ekstrakcije in so pripravljeni za uradni≈°ko presojo.
                        </p>
                        <div class="gurs-meta">
                            <div class="gurs-pill" id="gurs-parcel-pill">
                                <span>Parcela</span>
                                <strong id="gurs-parcel-summary">Podatki ≈°e niso na voljo</strong>
                            </div>
                            <div class="gurs-footnote">
                                <span>‚ÑπÔ∏è</span>
                                <span id="gurs-parcel-footnote">Dodaj parcelno ≈°tevilko in katastrsko obƒçino med kljuƒçne podatke.</span>
                            </div>
                        </div>
                    </div>
                    <div class="gurs-actions">
                        <button class="btn btn-primary" id="gurs-viewer-btn" onclick="app.openGursViewer()" disabled>
                            üóñ Odpri pregled GURS
                        </button>
                        <button class="btn btn-secondary" onclick="app.updateParcelContext()" title="Osve≈æi podatke iz kljuƒçnih polj">
                            üîÅ Osve≈æi podatke
                        </button>
                    </div>
                </div>

                <div class="actions-bar">
                    <button class="btn btn-secondary" onclick="app.previousStep()">‚Üê Nazaj</button>
                    <button class="btn btn-primary" onclick="app.confirmAndAnalyze()">Potrdi in Analiziraj ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Analysis (prazno, samo loading) -->
            <div id="content-step-3" class="hidden"></div>

            <!-- Step 4: Results -->
            <div id="content-step-4" class="hidden">
                <h2 class="section-title">‚úÖ Rezultati Analize</h2>
                <div class="stats-grid">
                    <div class="stat-card success" onclick="app.showFilteredResults('compliant')">
                        <div class="stat-value" style="color: var(--success);" id="compliant-count">0</div>
                        <div style="color: var(--text-muted);">Skladnih zahtev</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">üëÜ Klikni za prikaz</div>
                    </div>
                    <div class="stat-card danger" onclick="app.showFilteredResults('non-compliant')">
                        <div class="stat-value" style="color: var(--danger);" id="non-compliant-count">0</div>
                        <div style="color: var(--text-muted);">Neskladnih zahtev</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">üëÜ Klikni za prikaz</div>
                    </div>
                    <div class="stat-card info" onclick="app.showFilteredResults('not-relevant')">
                        <div class="stat-value" style="color: var(--info);" id="not-relevant-count">0</div>
                        <div style="color: var(--text-muted);">Ni relevantno</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">üëÜ Klikni za prikaz</div>
                    </div>
                </div>
                <table class="results-table">
                    <thead><tr><th style="width: 80px;">ID</th><th style="width: 250px;">Zahteva</th><th style="width: 150px;">Status</th><th>Obrazlo≈æitev</th></tr></thead>
                    <tbody id="results-tbody"></tbody>
                </table>
                <div class="actions-bar">
                    <button class="btn btn-secondary" onclick="app.resetAnalysis()">üîÑ Nova Analiza</button>
                    <button class="btn btn-primary" onclick="app.downloadReport()">üì• Prenesi Poroƒçilo</button>
                </div>
            </div>
        </div>

        <div class="spinner-overlay hidden" id="loading-overlay">
            <div><div class="spinner"></div><div style="color: var(--text); font-size: 1.1rem; font-weight: 600; text-align: center;" id="loading-message">Nalagam...</div></div>
        </div>

        <div class="toast" id="toast">
            <div style="font-weight: 600; margin-bottom: 0.25rem;" id="toast-title"></div>
            <div style="color: var(--text-muted); font-size: 0.9rem;" id="toast-message"></div>
        </div>
        
        <!-- Modal za shranjene seje -->
        <div class="modal-overlay" id="sessions-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">üìÅ Shranjene Analize</h2>
                    <button class="modal-close" onclick="app.closeSessionsModal()">‚úï</button>
                </div>
                <div id="sessions-list-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <p>Nalagam shranjene analize...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal za filtriran prikaz zahtev -->
        <div class="modal-overlay" id="filter-modal">
            <div class="modal-content filter-modal-content">
                <div class="modal-header">
                    <div class="filter-header">
                        <h2 class="modal-title" id="filter-modal-title">Zahteve</h2>
                        <span class="filter-badge" id="filter-badge"></span>
                    </div>
                    <button class="modal-close" onclick="app.closeFilterModal()">‚úï</button>
                </div>
                <div class="filter-list" id="filter-list"></div>
            </div>
        </div>
        
        <!-- PDF Viewer Modal -->
        <div id="pdf-viewer-modal" class="pdf-viewer-modal hidden">
            <div class="pdf-resize-handle" id="pdf-resize-handle"></div>
            <div class="pdf-viewer-header">
                <div class="pdf-viewer-title" id="pdf-viewer-title">PDF Predogled</div>
                <div class="pdf-viewer-controls">
                    <div class="pdf-zoom-controls">
                        <button class="btn btn-secondary btn-small" onclick="app.pdfZoomOut()" id="pdf-zoom-out">‚àí</button>
                        <span class="pdf-zoom-value" id="pdf-zoom-value">100%</span>
                        <button class="btn btn-secondary btn-small" onclick="app.pdfZoomIn()" id="pdf-zoom-in">+</button>
                    </div>
                    <div class="pdf-page-nav" id="pdf-page-nav" style="display: none;">
                        <button class="btn btn-secondary btn-small" onclick="app.pdfPrevPage()" id="pdf-prev-page">‚Üê Prej≈°nja</button>
                        <span class="pdf-page-info" id="pdf-page-info">Stran 1 / 1</span>
                        <button class="btn btn-secondary btn-small" onclick="app.pdfNextPage()" id="pdf-next-page">Naslednja ‚Üí</button>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="app.popOutPdfViewer()" id="pdf-popout" disabled>üóñ Odpri v novem oknu</button>
                    <button class="btn btn-primary btn-small" onclick="app.closePdfViewer()">Zapri</button>
                </div>
            </div>
            <div class="pdf-viewer-body" id="pdf-viewer-body">
                <div class="pdf-loading" id="pdf-loading">Nalagam PDF dokument...</div>
                <div class="pdf-canvas-container" id="pdf-canvas-container" style="display: none;">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const KEY_DATA_LABELS = {
            glavni_objekt: 'Objekt (Opis funkcije)',
            vrsta_gradnje: 'Vrsta gradnje',
            klasifikacija_cc_si: 'CC-SI Klasifikacija',
            nezahtevni_objekti: 'Nezahtevni objekti v projektu',
            enostavni_objekti: 'Enostavni objekti v projektu',
            vzdrzevalna_dela: 'Vzdr≈æevalna dela / Manj≈°a rekonstrukcija',
            parcela_objekta: 'Gradbena parcela (≈°t.)',
            stevilke_parcel_ko: 'Vse parcele in K.O.',
            velikost_parcel: 'Skupna velikost parcel',
            velikost_obstojecega_objekta: 'Velikost obstojeƒçega objekta',
            tlorisne_dimenzije: 'Nove tlorisne dimenzije',
            gabariti_etaznost: 'Novi gabarit/Eta≈ænost',
            faktor_zazidanosti_fz: 'Faktor zazidanosti (FZ)',
            faktor_izrabe_fi: 'Faktor izrabe (FI)',
            zelene_povrsine: 'Zelene povr≈°ine (FZP/m¬≤)',
            naklon_strehe: 'Naklon strehe',
            kritina_barva: 'Kritina/Barva',
            materiali_gradnje: 'Materiali gradnje',
            smer_slemena: 'Smer slemena',
            visinske_kote: 'Vi≈°inske kote (k.p., k.s.)',
            odmiki_parcel: 'Odmiki od parcelnih mej',
            komunalni_prikljucki: 'Komunalni prikljuƒçki/Oskrba'
        };

        const app = {
            currentStep: 1,
            files: [],
            filesMeta: {},
            results: [],
            sessionId: null,
            eupRabaPairs: [],
            keyData: {},
            expandedRows: new Set(),
            hasUnsavedChanges: false,
            saveTimeout: null,
            parcelContext: null,
            parcelLocationCache: {},

            // PDF Viewer state
            pdfDoc: null,
            pdfCurrentPage: 1,
            pdfTotalPages: 0,
            pdfZoom: 1.5,
            pdfLoading: false,
            pdfCloseTimeout: null,
            currentPdfFile: null,
            pdfPopoutButton: null,
            pdfScrollTimeout: null,
            pdfWidth: 50,
            isResizing: false,

            init() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.body.className = `${savedTheme}-mode`;
                document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

                this.loadParcelCache();
                this.updateParcelSummary(this.parcelContext);

                this.pdfPopoutButton = document.getElementById('pdf-popout');
                this.setPdfPopoutEnabled(false);

                const savedPdfWidth = parseFloat(localStorage.getItem('pdfWidth') || '');
                if (!Number.isNaN(savedPdfWidth) && savedPdfWidth >= 20 && savedPdfWidth <= 80) {
                    this.pdfWidth = savedPdfWidth;
                }
                document.documentElement.style.setProperty('--pdf-panel-width', `${this.pdfWidth}vw`);

                const uploadZone = document.getElementById('upload-zone');
                uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragging'); });
                uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragging'));
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragging');
                    this.addFiles(Array.from(e.dataTransfer.files));
                });

                const pdfBody = document.getElementById('pdf-viewer-body');
                if (pdfBody) {
                    pdfBody.addEventListener('wheel', (event) => this.handlePdfScroll(event), { passive: false });
                }

                this.initPdfResize();
            },

            loadParcelCache() {
                try {
                    const raw = localStorage.getItem('gursParcelCache');
                    if (raw) {
                        const parsed = JSON.parse(raw);
                        if (parsed && typeof parsed === 'object') {
                            this.parcelLocationCache = parsed;
                        }
                    }

                    const contextRaw = localStorage.getItem('gursParcelContext');
                    if (contextRaw) {
                        const parsedContext = JSON.parse(contextRaw);
                        if (parsedContext && parsedContext.parcelNumber) {
                            this.parcelContext = parsedContext;
                        }
                    }
                } catch (error) {
                    console.warn('Ne morem prebrati GURS predpomnilnika:', error);
                    this.parcelLocationCache = {};
                }
            },

            persistParcelCache() {
                try {
                    const entries = Object.entries(this.parcelLocationCache || {})
                        .sort((a, b) => ((b[1] && b[1].timestamp) || 0) - ((a[1] && a[1].timestamp) || 0))
                        .slice(0, 5);
                    const trimmed = {};
                    entries.forEach(([key, value]) => { trimmed[key] = value; });
                    localStorage.setItem('gursParcelCache', JSON.stringify(trimmed));
                    this.parcelLocationCache = trimmed;
                } catch (error) {
                    console.warn('Ne morem shraniti GURS predpomnilnika:', error);
                }
            },

            cacheParcelLocation(key, payload) {
                if (!key || !payload) return payload;
                const enriched = { ...payload, timestamp: Date.now() };
                this.parcelLocationCache = this.parcelLocationCache || {};
                this.parcelLocationCache[key] = enriched;
                this.persistParcelCache();
                return enriched;
            },

            buildParcelCacheKey(context) {
                if (!context || !context.parcelNumber) return null;
                const parcel = context.parcelNumber.toLowerCase();
                const ko = (context.koName || '').toLowerCase();
                return `${parcel}|${ko}`.trim();
            },

            deriveParcelContext() {
                const sourceValues = [
                    this.keyData?.parcela_objekta,
                    this.keyData?.stevilke_parcel_ko
                ].filter(Boolean);

                if (sourceValues.length === 0) return null;

                let parcelNumber = null;
                let koName = null;

                const parcelRegexes = [
                    /(\d{1,5}\s*\/\s*\d{1,5})/,
                    /(\d{3,7})/
                ];
                const koRegexes = [
                    /k\.?\s*o\.?\s*[:\-]?\s*([A-Za-zƒå≈†≈Ωƒç≈°≈æ0-9\s\-]+)/i,
                    /\bKO\s*[:\-]?\s*([A-Za-zƒå≈†≈Ωƒç≈°≈æ0-9\s\-]+)/i
                ];

                sourceValues.forEach((raw) => {
                    if (!raw) return;
                    const text = String(raw).replace(/\s+/g, ' ').trim();

                    if (!parcelNumber) {
                        for (const regex of parcelRegexes) {
                            const match = text.match(regex);
                            if (match && match[1]) {
                                parcelNumber = match[1].replace(/\s*/g, '');
                                break;
                            }
                        }
                    }

                    if (!koName) {
                        for (const regex of koRegexes) {
                            const match = text.match(regex);
                            if (match && match[1]) {
                                koName = match[1].replace(/[.,;].*/, '').trim();
                                break;
                            }
                        }
                    }
                });

                if (!parcelNumber) return null;

                if (parcelNumber.includes('/')) {
                    const [main, sub] = parcelNumber.split('/').map(part => part.replace(/^0+/, '') || '0');
                    parcelNumber = `${main}/${sub}`;
                } else {
                    parcelNumber = parcelNumber.replace(/^0+/, '') || '0';
                }

                if (koName) {
                    koName = koName.replace(/\s+/g, ' ').trim();
                }

                return { parcelNumber, koName: koName || null };
            },

            updateParcelContext() {
                const context = this.deriveParcelContext();
                this.parcelContext = context;
                try {
                    if (context) {
                        localStorage.setItem('gursParcelContext', JSON.stringify(context));
                    } else {
                        localStorage.removeItem('gursParcelContext');
                    }
                } catch (error) {
                    console.warn('Ne morem shraniti podatkov o parceli:', error);
                }
                this.updateParcelSummary(context);
                return context;
            },

            updateParcelSummary(context) {
                const summaryEl = document.getElementById('gurs-parcel-summary');
                const footnoteEl = document.getElementById('gurs-parcel-footnote');
                const button = document.getElementById('gurs-viewer-btn');
                if (!summaryEl || !footnoteEl || !button) return;

                if (!context) {
                    summaryEl.textContent = 'Podatki ≈°e niso na voljo';
                    footnoteEl.textContent = 'Dodaj parcelno ≈°tevilko in katastrsko obƒçino med kljuƒçne podatke.';
                    button.disabled = true;
                    return;
                }

                const label = context.koName ? `${context.parcelNumber} (k.o. ${context.koName})` : context.parcelNumber;
                summaryEl.textContent = label;
                footnoteEl.textContent = 'Podatki so pripravljeni. Za pregled klikni na gumb ali osve≈æi po spremembi polj.';
                button.disabled = false;
            },

            async openGursViewer() {
                const context = this.parcelContext || this.updateParcelContext();
                if (!context) {
                    this.showToast('info', 'Manjkajo podatki', 'Vnesi parcelno ≈°tevilko in katastrsko obƒçino, da lahko odprem GURS pregled.');
                    return;
                }

                const cacheKey = this.buildParcelCacheKey(context);
                const summaryLabel = context.koName ? `${context.parcelNumber} (k.o. ${context.koName})` : context.parcelNumber;
                let parcelData = cacheKey ? this.parcelLocationCache?.[cacheKey] : null;

                if (parcelData && parcelData.feature) {
                    parcelData = this.cacheParcelLocation(cacheKey, parcelData);
                    this.launchGursWindow(parcelData, { context, summaryLabel, fromCache: true });
                    this.showToast('info', 'Predpomnjen prikaz', `Uporabljam zadnje shranjene podatke za ${summaryLabel}.`);
                    return;
                }

                let usedProgress = false;
                try {
                    usedProgress = true;
                    this.showProgress('Vzpostavljam GURS povezavo', `I≈°ƒçem parcelo ${summaryLabel}...`, 40);
                    const url = new URL('/gurs/parcel', window.location.origin);
                    url.searchParams.set('parcel_number', context.parcelNumber);
                    if (context.koName) url.searchParams.set('ko', context.koName);

                    const response = await fetch(url.toString(), { method: 'GET' });
                    if (!response.ok) {
                        let message = 'GURS WFS ni vrnil podatkov.';
                        try {
                            const errorData = await response.json();
                            if (errorData?.detail) message = errorData.detail;
                        } catch (_) {
                            // Ignoriramo, uporabimo privzeto sporoƒçilo
                        }
                        throw new Error(message);
                    }

                    const payload = await response.json();
                    payload.timestamp = payload.timestamp || Date.now();
                    parcelData = this.cacheParcelLocation(cacheKey, payload);
                    this.showToast('success', 'Najdena parcela', `Pripravljam prikaz za ${summaryLabel}.`);
                    this.launchGursWindow(parcelData, { context, summaryLabel, fromCache: false });
                } catch (error) {
                    console.error('Napaka pri pridobivanju GURS podatkov:', error);
                    this.showToast('error', 'GURS ni dosegljiv', error.message || 'Pri≈°lo je do napake pri pridobivanju podatkov.');
                } finally {
                    if (usedProgress) this.hideProgress();
                }
            },

            launchGursWindow(parcelData, meta = {}) {
                if (!parcelData || !parcelData.feature) {
                    this.showToast('error', 'Ni geometrije', 'GURS ni vrnil geometrije za izbrano parcelo.');
                    return;
                }

                const context = meta.context || this.parcelContext || {};
                const summaryLabel = meta.summaryLabel || (context.parcelNumber ? `${context.parcelNumber}${context.koName ? ` (k.o. ${context.koName})` : ''}` : 'Parcela');
                const viewer = window.open('', `gurs-viewer-${Date.now()}`, 'width=1280,height=900,resizable=yes,scrollbars=yes');

                if (!viewer || viewer.closed || typeof viewer.closed === 'undefined') {
                    this.showToast('error', 'Pojavno okno blokirano', 'Dovoli pojavna okna za prikaz GURS pregleda.');
                    return;
                }

                const payloadJson = JSON.stringify(parcelData).replace(/</g, '\u003c');
                const metaJson = JSON.stringify({
                    parcelNumber: context.parcelNumber || '',
                    koName: context.koName || '',
                    summaryLabel,
                    timestamp: parcelData.timestamp || Date.now(),
                }).replace(/</g, '\u003c');

                viewer.document.open();
                viewer.document.write(`<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURS Prostorski pregled</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-mn5ZkEreZV3CYUQZnIcXtNCmieYwgd0CQpZgdKzac8AjtKoa6HgMHqmpYyqn1nVbWcv16O3MH8b7ZJQf8svUKA==" crossorigin=""/>
    <style>
        :root {
            --bg: #0f172a;
            --panel: rgba(15, 23, 42, 0.85);
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.15);
            --text: #f8fafc;
            --text-muted: #cbd5f5;
            --success: #22c55e;
            --warning: #fbbf24;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.25), transparent 55%), radial-gradient(circle at 80% 0%, rgba(56, 189, 248, 0.25), transparent 60%), #0f172a;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .viewer-shell { flex: 1; display: flex; flex-direction: column; max-width: 1440px; margin: 0 auto; width: 100%; }
        .viewer-header { padding: 1.75rem 2rem 1.25rem; display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: center; justify-content: space-between; position: relative; z-index: 10; }
        .viewer-title h1 { font-size: 1.75rem; margin: 0 0 0.35rem; font-weight: 700; }
        .viewer-title p { margin: 0; color: var(--text-muted); font-size: 0.95rem; }
        .viewer-status { display: flex; gap: 1rem; align-items: center; color: var(--text-muted); font-size: 0.85rem; padding: 0 2rem 1rem; }
        .viewer-status span { color: var(--text); font-weight: 600; }
        .viewer-actions { display: flex; gap: 0.75rem; align-items: center; }
        .viewer-actions button { padding: 0.65rem 1.25rem; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.4); background: rgba(15, 23, 42, 0.55); color: var(--text); cursor: pointer; font-weight: 600; letter-spacing: 0.01em; transition: all 0.2s ease; }
        .viewer-actions button:hover { transform: translateY(-1px); border-color: var(--accent); background: rgba(99, 102, 241, 0.25); }
        #map { flex: 1; min-height: 540px; border-radius: 24px; margin: 0 2rem 1.5rem; border: 1px solid rgba(148, 163, 184, 0.25); box-shadow: 0 40px 70px -35px rgba(15, 23, 42, 0.65); overflow: hidden; }
        .viewer-footnote { padding: 0 2rem 2rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-start; justify-content: space-between; color: var(--text-muted); font-size: 0.8rem; }
        .viewer-footnote strong { color: var(--text); font-weight: 600; }
        .notice { padding: 0.75rem 1rem; border-radius: 14px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(99, 102, 241, 0.3); display: inline-flex; align-items: center; gap: 0.65rem; color: var(--text-muted); }
        .notice.success { border-color: rgba(34, 197, 94, 0.45); color: rgba(134, 239, 172, 0.95); }
        .notice.warning { border-color: rgba(251, 191, 36, 0.45); color: rgba(253, 224, 71, 0.95); }
        .leaflet-control-layers-expanded { background: rgba(15, 23, 42, 0.92); border: 1px solid rgba(99, 102, 241, 0.3); color: var(--text); box-shadow: 0 20px 40px -30px rgba(15, 23, 42, 0.9); }
        .leaflet-control-layers label { color: var(--text-muted); font-size: 0.85rem; }
        .leaflet-bar a, .leaflet-control-zoom a { background: rgba(15, 23, 42, 0.85); border-bottom: 1px solid rgba(148, 163, 184, 0.25); color: var(--text); }
        .leaflet-bar a:hover, .leaflet-control-zoom a:hover { background: rgba(99, 102, 241, 0.45); color: var(--text); }

        @media (max-width: 1024px) {
            .viewer-header { padding: 1.5rem 1.25rem 1rem; }
            .viewer-status { padding: 0 1.25rem 0.75rem; flex-wrap: wrap; }
            #map { margin: 0 1.25rem 1rem; }
            .viewer-footnote { padding: 0 1.25rem 1.5rem; }
            .viewer-actions { width: 100%; justify-content: flex-start; }
        }

        @media (max-width: 640px) {
            #map { min-height: 420px; }
            .viewer-actions button { flex: 1; }
        }
    </style>
</head>
<body>
    <div class="viewer-shell">
        <div class="viewer-header">
            <div class="viewer-title">
                <h1>GURS Prostorski pregled</h1>
                <p id="parcel-meta">${summaryLabel}</p>
            </div>
            <div class="viewer-actions">
                <button id="recenter-btn">üéØ Centrira na parcelo</button>
                <button id="copy-coords">üìå Kopiraj koordinate</button>
            </div>
        </div>
        <div class="viewer-status">
            <div>üìç Kazalec: <span id="cursor-coords">--</span></div>
            <div id="parcel-updated">Pridobljeno iz GURS WFS</div>
        </div>
        <div id="map"></div>
        <div class="viewer-footnote">
            <div class="notice" id="viewer-notice">Namig: uporabite sloje na desni za vklop namenske rabe ali parcelnih ≈°tevilk.</div>
            <div><strong>Vir:</strong> GURS WFS (parcele, namensko rabo), GURS DOF ortofoto, OpenStreetMap</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-vMN3zV9ZZgwyXR0vbJIUKGwEuITdSb9VInA36TObgGJE0E7E5Wdl66T4kLlwM651c01qmPvvrL1jAUx0xG5q5Q==" crossorigin=""></script>
    <script>
        const PARCEL_PAYLOAD = ${payloadJson};
        const PARCEL_META = ${metaJson};

        const noticeEl = document.getElementById('viewer-notice');
        function setNotice(message, type = 'info') {
            if (!noticeEl) return;
            noticeEl.textContent = message;
            noticeEl.classList.remove('success', 'warning');
            if (type === 'success') noticeEl.classList.add('success');
            if (type === 'warning') noticeEl.classList.add('warning');
        }

        const map = L.map('map', { zoomControl: false, attributionControl: true });
        const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap' });
        const ortho = L.tileLayer.wms('https://prostor.gov.si/ows/DOF/ows', {
            layers: 'DOF050',
            format: 'image/png',
            transparent: false,
            attribution: '&copy; GURS DOF'
        });
        const parcelsLayer = L.tileLayer.wms('https://prostor.gov.si/ows/PK_GURS_DPB/ows', {
            layers: 'PK_GURS_DPB:Parcele',
            format: 'image/png',
            transparent: true,
            attribution: '&copy; GURS Parcele',
            styles: ''
        });
        const namenskoLayer = L.tileLayer.wms('https://prostor.gov.si/ows/PNR/ows', {
            layers: 'PNR:NamenskaRaba',
            format: 'image/png',
            transparent: true,
            attribution: '&copy; PNR',
            styles: ''
        });

        ortho.on('tileerror', () => setNotice('Ortofoto sloj trenutno ni na voljo (GURS DOF).', 'warning'));
        parcelsLayer.on('tileerror', () => setNotice('Parcele WMS sloj ni na voljo ali je blokiran.', 'warning'));
        namenskoLayer.on('tileerror', () => setNotice('Namenska raba ni na voljo za izbrano obmoƒçje.', 'warning'));

        const baseLayers = {
            'GURS Ortofoto': ortho,
            'OpenStreetMap': osm
        };
        const overlayLayers = {
            'Parcelne ≈°tevilke (WMS)': parcelsLayer,
            'Namenska raba (ƒçe je na voljo)': namenskoLayer
        };

        ortho.addTo(map);
        parcelsLayer.addTo(map);

        const parcelStyle = {
            color: '#f97316',
            weight: 3,
            opacity: 0.9,
            fillColor: '#f97316',
            fillOpacity: 0.15
        };

        const parcelLayer = L.geoJSON(PARCEL_PAYLOAD.feature, { style: parcelStyle }).addTo(map);
        let centroidMarker = null;
        if (PARCEL_PAYLOAD.centroid) {
            centroidMarker = L.circleMarker([PARCEL_PAYLOAD.centroid[1], PARCEL_PAYLOAD.centroid[0]], {
                radius: 6,
                color: '#38bdf8',
                fillColor: '#0ea5e9',
                fillOpacity: 0.85,
                weight: 2
            }).addTo(map);
        }

        const bounds = parcelLayer.getBounds();
        if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [60, 60] });
        } else if (PARCEL_PAYLOAD.centroid) {
            map.setView([PARCEL_PAYLOAD.centroid[1], PARCEL_PAYLOAD.centroid[0]], 18);
        } else {
            map.setView([46.05, 14.5], 13);
        }

        L.control.layers(baseLayers, overlayLayers, { collapsed: false, sortLayers: true }).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.control.scale({ metric: true, imperial: false }).addTo(map);

        const coordsLabel = document.getElementById('cursor-coords');
        map.on('mousemove', (event) => {
            if (!coordsLabel) return;
            const lat = event.latlng.lat.toFixed(6);
            const lng = event.latlng.lng.toFixed(6);
            coordsLabel.textContent = `${lat}, ${lng}`;
        });

        const updatedEl = document.getElementById('parcel-updated');
        if (updatedEl && PARCEL_META.timestamp) {
            const date = new Date(PARCEL_META.timestamp);
            updatedEl.textContent = `Posodobljeno: ${date.toLocaleString('sl-SI')}`;
        }

        document.getElementById('recenter-btn').addEventListener('click', () => {
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [60, 60] });
                setNotice('Parcela je centrirana.', 'success');
            }
        });

        document.getElementById('copy-coords').addEventListener('click', async () => {
            if (!PARCEL_PAYLOAD.centroid) {
                setNotice('Koordinat ni mogoƒçe kopirati ‚Äì manjkajo centroidni podatki.', 'warning');
                return;
            }
            const lat = PARCEL_PAYLOAD.centroid[1].toFixed(6);
            const lng = PARCEL_PAYLOAD.centroid[0].toFixed(6);
            const value = `${lat}, ${lng}`;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(value);
                    setNotice('Koordinate so kopirane v odlo≈æi≈°ƒçe.', 'success');
                } else {
                    throw new Error('Clipboard API ni na voljo');
                }
            } catch (err) {
                setNotice('Koordinat ni bilo mogoƒçe kopirati. Kopiraj roƒçno: ' + value, 'warning');
            }
        });

        setTimeout(() => setNotice('Povezava s GURS je vzpostavljena. Vkljuƒçite sloje po potrebi.'), 1500);
    </script>
</body>
</html>`);
                viewer.document.close();
            },

            getPdfPopoutButton() {
                if (!this.pdfPopoutButton || !document.body.contains(this.pdfPopoutButton)) {
                    this.pdfPopoutButton = document.getElementById('pdf-popout');
                }
                return this.pdfPopoutButton;
            },

            setPdfPopoutEnabled(isEnabled) {
                const button = this.getPdfPopoutButton();
                if (button) {
                    button.disabled = !isEnabled;
                }
            },

            initPdfResize() {
                const resizeHandle = document.getElementById('pdf-resize-handle');
                const pdfModal = document.getElementById('pdf-viewer-modal');
                if (!resizeHandle || !pdfModal) return;

                resizeHandle.addEventListener('mousedown', (event) => {
                    if (window.innerWidth <= 1024) return;
                    event.preventDefault();
                    this.isResizing = true;
                    pdfModal.classList.add('resizing');
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                });

                document.addEventListener('mousemove', (event) => {
                    if (!this.isResizing) return;
                    const newWidth = (event.clientX / window.innerWidth) * 100;
                    if (newWidth >= 20 && newWidth <= 80) {
                        this.pdfWidth = newWidth;
                        document.documentElement.style.setProperty('--pdf-panel-width', `${newWidth}vw`);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (!this.isResizing) return;
                    this.isResizing = false;
                    pdfModal.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    localStorage.setItem('pdfWidth', String(this.pdfWidth));
                });
            },

            handlePdfScroll(event) {
                if (!this.pdfDoc || this.pdfLoading) return;
                event.preventDefault();
                if (this.pdfScrollTimeout) clearTimeout(this.pdfScrollTimeout);
                const direction = event.deltaY;
                this.pdfScrollTimeout = setTimeout(() => {
                    if (direction > 0 && this.pdfCurrentPage < this.pdfTotalPages) {
                        this.renderPdfPage(this.pdfCurrentPage + 1);
                    } else if (direction < 0 && this.pdfCurrentPage > 1) {
                        this.renderPdfPage(this.pdfCurrentPage - 1);
                    }
                }, 150);
            },

            updatePdfButtons() {
                const zoomOut = document.getElementById('pdf-zoom-out');
                const zoomIn = document.getElementById('pdf-zoom-in');
                const prev = document.getElementById('pdf-prev-page');
                const next = document.getElementById('pdf-next-page');
                const hasDocument = !!this.pdfDoc;
                if (zoomOut) zoomOut.disabled = !hasDocument || this.pdfZoom <= 0.5 || this.pdfLoading;
                if (zoomIn) zoomIn.disabled = !hasDocument || this.pdfZoom >= 3 || this.pdfLoading;
                if (prev) prev.disabled = !hasDocument || this.pdfCurrentPage <= 1 || this.pdfLoading;
                if (next) next.disabled = !hasDocument || this.pdfCurrentPage >= this.pdfTotalPages || this.pdfLoading;
            },

            toggleTheme() {
                const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.body.className = `${newTheme}-mode`;
                document.getElementById('theme-icon').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
                localStorage.setItem('theme', newTheme);
                this.showToast('success', 'Tema spremenjena', `Aktivirana ${newTheme === 'dark' ? 'temna' : 'svetla'} tema`);
            },

            goToStep(step) {
                if (step === 3) return;
                const stepEl = document.getElementById(`step-${step}`);
                if (stepEl.classList.contains('disabled')) return;
                this.currentStep = step;
                this.updateUI();
            },

            previousStep() { 
                if (this.currentStep > 1) { 
                    this.currentStep--; 
                    this.updateUI(); 
                } 
            },
            
            nextStep() { 
                if (this.currentStep < 4) { 
                    this.currentStep++; 
                    this.updateStepAccess();
                    this.updateUI(); 
                } 
            },

            updateStepAccess() {
                const step2 = document.getElementById('step-2');
                if (this.sessionId) {
                    step2.classList.remove('disabled');
                } else {
                    step2.classList.add('disabled');
                }
                
                const step4 = document.getElementById('step-4');
                if (this.results.length > 0) {
                    step4.classList.remove('disabled');
                } else {
                    step4.classList.add('disabled');
                }
            },

            updateUI() {
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`content-step-${i}`).classList.add('hidden');
                    const stepEl = document.getElementById(`step-${i}`);
                    stepEl.classList.remove('active', 'completed');
                    if (i < this.currentStep) stepEl.classList.add('completed');
                    if (i === this.currentStep) stepEl.classList.add('active');
                }
                document.getElementById(`content-step-${this.currentStep}`).classList.remove('hidden');
            },

            handleFileSelect(event) { this.addFiles(Array.from(event.target.files)); },

            addFiles(newFiles) {
                const validFiles = newFiles.filter(file => {
                    const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                                      'application/vnd.ms-excel', 'image/png', 'image/jpeg', 'image/jpg'];
                    const maxSize = 50 * 1024 * 1024;
                    if (!validTypes.includes(file.type)) { this.showToast('error', 'Napaka', `${file.name} ni podprt format`); return false; }
                    if (file.size > maxSize) { this.showToast('error', 'Napaka', `${file.name} je prevelik (max 50MB)`); return false; }
                    return true;
                });
                this.files.push(...validFiles);
                validFiles.forEach(file => { this.filesMeta[file.name] = { name: file.name, pages: '' }; });
                this.renderFileList();
                if (validFiles.length > 0) {
                    this.showToast('success', 'Datoteke dodane', `Dodanih ${validFiles.length} datotek`);
                    document.getElementById('extract-btn').disabled = false;
                }
            },

            removeFile(index) {
                const fileName = this.files[index].name;
                delete this.filesMeta[fileName];
                this.files.splice(index, 1);
                this.renderFileList();
                this.showToast('info', 'Datoteka odstranjena', fileName);
                if (this.files.length === 0) document.getElementById('extract-btn').disabled = true;
            },

            updatePages(fileName, pages) { if (this.filesMeta[fileName]) this.filesMeta[fileName].pages = pages; },

            renderFileList() {
                const container = document.getElementById('file-list');
                if (this.files.length === 0) { container.innerHTML = ''; return; }
                container.innerHTML = this.files.map((file, index) => `
                    <div class="file-item">
                        <div class="file-info">
                            <span style="font-size: 1.5rem;">üìÑ</span>
                            <div class="file-meta">
                                <div style="font-weight: 600;">${file.name}</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">${this.formatFileSize(file.size)}</div>
                                ${file.type === 'application/pdf' ? `<input type="text" placeholder="Strani (npr. 1-3, 5)" style="margin-top: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 0.85rem;" onchange="app.updatePages('${file.name}', this.value)">` : ''}
                            </div>
                        </div>
                        <div class="file-actions">
                            ${file.type === 'application/pdf' ? `<button class="preview-file" onclick="app.openPdfViewer(${index})">üëÅÔ∏è Predogled</button>` : ''}
                            <button class="remove-file" onclick="app.removeFile(${index})">‚úï</button>
                        </div>
                    </div>
                `).join('');
            },

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            },

            // PDF Viewer Methods
            async openPdfViewer(fileIndex) {
                const file = this.files[fileIndex];
                if (!file || file.type !== 'application/pdf') return;

                this.currentPdfFile = file;
                this.pdfCurrentPage = 1;
                this.pdfZoom = 1.5;
                this.pdfLoading = true;
                this.updatePdfButtons();

                const viewerModal = document.getElementById('pdf-viewer-modal');
                this.setPdfPopoutEnabled(false);
                if (this.pdfCloseTimeout) {
                    clearTimeout(this.pdfCloseTimeout);
                    this.pdfCloseTimeout = null;
                }
                document.documentElement.style.setProperty('--pdf-panel-width', `${this.pdfWidth}vw`);
                if (viewerModal) {
                    viewerModal.classList.remove('hidden');
                    requestAnimationFrame(() => viewerModal.classList.add('open'));
                }
                document.body.classList.add('pdf-viewer-active');
                document.getElementById('pdf-viewer-title').textContent = file.name;
                document.getElementById('pdf-loading').style.display = 'block';
                document.getElementById('pdf-canvas-container').style.display = 'none';

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    this.pdfDoc = pdf;
                    this.pdfTotalPages = pdf.numPages;
                    
                    document.getElementById('pdf-page-nav').style.display = this.pdfTotalPages > 1 ? 'flex' : 'none';

                    await this.renderPdfPage(1);
                    this.pdfLoading = false;
                    document.getElementById('pdf-loading').style.display = 'none';
                    document.getElementById('pdf-canvas-container').style.display = 'block';
                    this.setPdfPopoutEnabled(true);
                } catch (error) {
                    console.error('Napaka pri nalaganju PDF:', error);
                    this.showToast('error', 'Napaka', 'Ni mogoƒçe nalo≈æiti PDF dokumenta');
                    this.closePdfViewer();
                }
            },

            async renderPdfPage(pageNum) {
                if (!this.pdfDoc || pageNum < 1 || pageNum > this.pdfTotalPages) return;

                this.pdfLoading = true;
                this.updatePdfButtons();

                try {
                    const page = await this.pdfDoc.getPage(pageNum);
                    const canvas = document.getElementById('pdfCanvas');
                    const context = canvas.getContext('2d');
                    
                    const viewport = page.getViewport({ scale: this.pdfZoom });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    this.pdfCurrentPage = pageNum;
                    document.getElementById('pdf-page-info').textContent = `Stran ${this.pdfCurrentPage} / ${this.pdfTotalPages}`;
                    document.getElementById('pdf-zoom-value').textContent = `${Math.round(this.pdfZoom * 100)}%`;

                    this.pdfLoading = false;
                    this.updatePdfButtons();
                } catch (error) {
                    console.error('Napaka pri prikazu strani:', error);
                    this.showToast('error', 'Napaka', 'Ni mogoƒçe prikazati strani');
                    this.pdfLoading = false;
                    this.updatePdfButtons();
                }
            },

            closePdfViewer() {
                const viewerModal = document.getElementById('pdf-viewer-modal');
                if (viewerModal) {
                    viewerModal.classList.remove('open');
                    viewerModal.classList.remove('resizing');
                    this.pdfCloseTimeout = setTimeout(() => {
                        viewerModal.classList.add('hidden');
                        this.pdfCloseTimeout = null;
                    }, 350);
                }
                document.body.classList.remove('pdf-viewer-active');
                this.setPdfPopoutEnabled(false);
                this.isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                if (this.pdfScrollTimeout) {
                    clearTimeout(this.pdfScrollTimeout);
                    this.pdfScrollTimeout = null;
                }
                const pageNav = document.getElementById('pdf-page-nav');
                if (pageNav) {
                    pageNav.style.display = 'none';
                }
                this.pdfDoc = null;
                this.pdfCurrentPage = 1;
                this.pdfTotalPages = 0;
                this.pdfZoom = 1.5;
                this.currentPdfFile = null;
                this.pdfLoading = false;
                this.updatePdfButtons();
            },

            popOutPdfViewer() {
                if (!this.currentPdfFile) {
                    this.showToast('info', 'Ni dokumenta', 'Najprej odprite PDF predogled');
                    return;
                }

                const fileUrl = URL.createObjectURL(this.currentPdfFile);
                const popout = window.open(
                    fileUrl,
                    '_blank',
                    'width=1200,height=900,menubar=yes,toolbar=yes,location=yes,status=yes,resizable=yes,scrollbars=yes'
                );

                if (!popout || popout.closed || typeof popout.closed === 'undefined') {
                    this.showPopupBlockedModal(fileUrl);
                    setTimeout(() => URL.revokeObjectURL(fileUrl), 60000);
                    return;
                }

                this.closePdfViewer();
                this.showToast('success', 'Odprto', 'PDF je odprt v novem oknu');
                setTimeout(() => URL.revokeObjectURL(fileUrl), 60000);
            },

            pdfPrevPage() {
                if (this.pdfCurrentPage > 1 && !this.pdfLoading) {
                    this.renderPdfPage(this.pdfCurrentPage - 1);
                }
            },

            pdfNextPage() {
                if (this.pdfCurrentPage < this.pdfTotalPages && !this.pdfLoading) {
                    this.renderPdfPage(this.pdfCurrentPage + 1);
                }
            },

            pdfZoomIn() {
                if (this.pdfZoom < 3 && !this.pdfLoading) {
                    this.pdfZoom += 0.25;
                    this.renderPdfPage(this.pdfCurrentPage);
                }
            },

            pdfZoomOut() {
                if (this.pdfZoom > 0.5 && !this.pdfLoading) {
                    this.pdfZoom -= 0.25;
                    this.renderPdfPage(this.pdfCurrentPage);
                }
            },

            async extractData() {
                if (this.files.length === 0) return;
                this.showProgress('Ekstrahiram podatke', 'Pripravljam dokumente...', 10);
                document.getElementById('extract-btn').disabled = true;

                try {
                    const formData = new FormData();
                    this.files.forEach(file => formData.append('pdf_files', file));
                    formData.append('municipality_slug', 'litija');
                    formData.append('files_meta_json', JSON.stringify(Object.values(this.filesMeta)));
                    this.updateProgress('Ekstrahiram podatke', 'Po≈°iljam dokumente na stre≈ænik...', 35);
                    const response = await fetch('/extract-data', { method: 'POST', body: formData });
                    this.updateProgress('Ekstrahiram podatke', 'Analiziram vsebino...', 65);
                    if (!response.ok) throw new Error('API napaka');
                    const data = await response.json();
                    this.updateProgress('Ekstrahiram podatke', 'Pripravljam rezultate...', 85);

                    this.sessionId = data.session_id;
                    this.eupRabaPairs = (data.eup || []).map((eup, i) => ({ eup, raba: (data.namenska_raba || [])[i] || '' }));
                    if (this.eupRabaPairs.length === 0) this.eupRabaPairs = [{ eup: '', raba: '' }];

                    this.keyData = {};
                    Object.keys(KEY_DATA_LABELS).forEach(key => {
                        this.keyData[key] = data[key] || 'Ni podatka v dokumentaciji';
                    });

                    this.renderEupRabaPairs();
                    this.renderKeyData();
                    this.updateProgress('Ekstrahiram podatke', 'Dokonƒçano!', 100);
                    setTimeout(() => {
                        this.hideProgress();
                        this.showToast('success', 'Podatki ekstrahirani', 'AI je uspe≈°no ekstrahiral kljuƒçne podatke');
                    }, 500);
                    this.updateStepAccess();
                    this.nextStep();
                    document.getElementById('extract-btn').disabled = false;
                } catch (error) {
                    this.hideProgress();
                    this.showToast('error', 'Napaka', error.message);
                    if (this.files.length > 0) {
                        document.getElementById('extract-btn').disabled = false;
                    }
                }
            },

            renderEupRabaPairs() {
                const container = document.getElementById('eup-raba-container');
                container.innerHTML = this.eupRabaPairs.map((pair, index) => `
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">EUP ${index + 1} *</label>
                            <input type="text" class="form-input" id="eup-input-${index}" value="${pair.eup}" onchange="app.eupRabaPairs[${index}].eup = this.value; app.clearValidationError();" placeholder="npr. LI-08">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Namenska raba ${index + 1} *</label>
                            <input type="text" class="form-input" id="raba-input-${index}" value="${pair.raba}" onchange="app.eupRabaPairs[${index}].raba = this.value; app.clearValidationError();" placeholder="npr. SSe">
                        </div>
                        ${this.eupRabaPairs.length > 1 ? `<button class="btn btn-secondary" onclick="app.removeEupRabaPair(${index})">‚úï</button>` : '<div></div>'}
                    </div>
                `).join('') + '<button class="btn btn-secondary" style="margin-bottom: 1.5rem;" onclick="app.addEupRabaPair()">+ Dodaj EUP/Rabo</button>';
            },

            validateEupRaba() {
                let isValid = true;
                const validationError = document.getElementById('validation-error');
                
                this.eupRabaPairs.forEach((pair, index) => {
                    const eupInput = document.getElementById(`eup-input-${index}`);
                    const rabaInput = document.getElementById(`raba-input-${index}`);
                    
                    if (!pair.eup || !pair.eup.trim()) {
                        if (eupInput) eupInput.classList.add('error');
                        isValid = false;
                    } else {
                        if (eupInput) eupInput.classList.remove('error');
                    }
                    
                    if (!pair.raba || !pair.raba.trim()) {
                        if (rabaInput) rabaInput.classList.add('error');
                        isValid = false;
                    } else {
                        if (rabaInput) rabaInput.classList.remove('error');
                    }
                });
                
                if (!isValid) {
                    validationError.style.display = 'flex';
                    validationError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    validationError.style.display = 'none';
                }
                
                return isValid;
            },

            clearValidationError() {
                document.getElementById('validation-error').style.display = 'none';
                this.eupRabaPairs.forEach((pair, index) => {
                    const eupInput = document.getElementById(`eup-input-${index}`);
                    const rabaInput = document.getElementById(`raba-input-${index}`);
                    if (eupInput) eupInput.classList.remove('error');
                    if (rabaInput) rabaInput.classList.remove('error');
                });
            },

            handleKeyDataChange(key, value) {
                if (!key) return;
                this.keyData[key] = value;
                if (key === 'parcela_objekta' || key === 'stevilke_parcel_ko') {
                    this.updateParcelContext();
                }
                this.markAsChanged();
            },

            renderKeyData() {
                const container = document.getElementById('key-data-grid');
                container.innerHTML = Object.keys(KEY_DATA_LABELS).map((key, index) => `
                    <div class="key-data-item">
                        <label class="form-label">${KEY_DATA_LABELS[key]}</label>
                        <textarea class="form-input" id="keydata-textarea-${index}" oninput="app.autoResizeTextarea(this)" onchange="app.handleKeyDataChange('${key}', this.value)">${this.keyData[key]}</textarea>
                    </div>
                `).join('');

                setTimeout(() => {
                    Object.keys(KEY_DATA_LABELS).forEach((_, index) => {
                        const textarea = document.getElementById(`keydata-textarea-${index}`);
                        if (textarea) this.autoResizeTextarea(textarea);
                    });
                }, 10);

                this.updateParcelContext();
            },

            addEupRabaPair() { this.eupRabaPairs.push({ eup: '', raba: '' }); this.renderEupRabaPairs(); },
            removeEupRabaPair(index) { this.eupRabaPairs.splice(index, 1); this.renderEupRabaPairs(); },

            async confirmAndAnalyze() {
                if (!this.validateEupRaba()) {
                    this.showToast('error', 'Manjkajoƒçi podatki', 'Prosimo izpolnite EUP in Namensko rabo');
                    return;
                }
                
                this.showLoading('Analiziram skladnost z AI...');
                this.currentStep = 3;
                this.updateUI();
                
                try {
                    const payload = {
                        session_id: this.sessionId,
                        final_eup_list: this.eupRabaPairs.map(p => p.eup).filter(e => e.trim()),
                        final_raba_list: this.eupRabaPairs.map(p => p.raba).filter(r => r.trim()),
                        key_data: this.keyData,
                        selected_ids: [],
                        existing_results_map: {}
                    };
                    
                    const response = await fetch('/analyze-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Napaka pri analizi');
                    const data = await response.json();
                    
                    const resultsMap = data.results_map || {};
                    this.results = (data.zahteve || []).map(req => {
                        const result = resultsMap[req.id] || {};
                        const skladnost = (result.skladnost || '').toLowerCase();
                        
                        return {
                            id: req.id,
                            requirement: req.naslov || 'Neznana zahteva',
                            compliant: skladnost.includes('skladno') && !skladnost.includes('neskladno'),
                            notRelevant: skladnost.includes('ni relevantno'),
                            explanation: result.obrazlozitev || 'Ni obrazlo≈æitve',
                            evidence: result.evidence || '',
                            skladnost: result.skladnost || 'Neskladno'
                        };
                    });
                    
                    this.renderResults();
                    this.hideLoading();
                    this.updateStepAccess();
                    
                    const compliantCount = this.results.filter(r => r.compliant).length;
                    const nonCompliantCount = this.results.filter(r => !r.compliant && !r.notRelevant).length;
                    const notRelevantCount = this.results.filter(r => r.notRelevant).length;
                    this.showToast('success', 'Analiza konƒçana', 
                        `${compliantCount} skladnih, ${nonCompliantCount} neskladnih, ${notRelevantCount} ni relevantno`);
                    this.nextStep();
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri analizi', error.message);
                    this.currentStep = 2;
                    this.updateUI();
                }
            },

            renderResults() {
                const compliantCount = this.results.filter(r => r.compliant).length;
                const nonCompliantCount = this.results.filter(r => !r.compliant && !r.notRelevant).length;
                const notRelevantCount = this.results.filter(r => r.notRelevant).length;
                
                document.getElementById('compliant-count').textContent = compliantCount;
                document.getElementById('non-compliant-count').textContent = nonCompliantCount;
                document.getElementById('not-relevant-count').textContent = notRelevantCount;
                
                const tbody = document.getElementById('results-tbody');
                tbody.innerHTML = this.results.map((result, index) => {
                    const isExpanded = this.expandedRows.has(index);
                    const truncatedText = result.requirement.length > 100 ? result.requirement.substring(0, 100) + '...' : result.requirement;
                    
                    return `
                    <tr>
                        <td style="font-weight: 600;">${result.id}</td>
                        <td>
                            <span class="requirement-text" onclick="app.toggleRequirement(${index})" title="Klikni za celoten tekst">
                                ${isExpanded ? result.requirement : truncatedText}
                            </span>
                        </td>
                        <td>
                            <select class="status-select" onchange="app.updateStatus(${index}, this.value)">
                                <option value="Skladno" ${result.compliant ? 'selected' : ''}>Skladno</option>
                                <option value="Neskladno" ${!result.compliant && !result.notRelevant ? 'selected' : ''}>Neskladno</option>
                                <option value="Ni relevantno" ${result.notRelevant ? 'selected' : ''}>Ni relevantno</option>
                            </select>
                        </td>
                        <td class="editable-cell">
                            <textarea class="editable-text" id="textarea-${index}" oninput="app.autoResizeTextarea(this)" onchange="app.updateExplanation(${index}, this.value)">${result.explanation}</textarea>
                        </td>
                    </tr>
                `}).join('');
                
                setTimeout(() => {
                    this.results.forEach((_, index) => {
                        const textarea = document.getElementById(`textarea-${index}`);
                        if (textarea) this.autoResizeTextarea(textarea);
                    });
                }, 10);
            },

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight + 4) + 'px';
            },

            toggleRequirement(index) {
                if (this.expandedRows.has(index)) {
                    this.expandedRows.delete(index);
                } else {
                    this.expandedRows.add(index);
                }
                this.renderResults();
            },

            updateStatus(index, newStatus) {
                this.results[index].skladnost = newStatus;
                this.results[index].compliant = newStatus === 'Skladno';
                this.results[index].notRelevant = newStatus === 'Ni relevantno';
                this.renderResults();
                this.markAsChanged();
                this.showToast('info', 'Status posodobljen', `Zahteva ${this.results[index].id}`);
            },

            updateExplanation(index, newExplanation) {
                this.results[index].explanation = newExplanation;
                this.markAsChanged();
                this.showToast('info', 'Obrazlo≈æitev posodobljena', `Zahteva ${this.results[index].id}`);
            },

            markAsChanged() {
                this.hasUnsavedChanges = true;
                this.showSaveButton();
                
                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.autoSaveProgress();
                }, 3000);
            },

            showSaveButton() {
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) saveBtn.style.display = 'inline-block';
            },

            hideSaveButton() {
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) saveBtn.style.display = 'none';
            },

            async saveProgress() {
                if (!this.sessionId) return;
                
                this.showLoading('Shranjujem spremembe...');
                
                try {
                    const sessionData = {
                        results_map: {},
                        zahteve: this.results.map(r => ({
                            id: r.id,
                            naslov: r.requirement
                        })),
                        metadata: {},
                        key_data: this.keyData,
                        eup: this.eupRabaPairs.map(p => p.eup),
                        namenska_raba: this.eupRabaPairs.map(p => p.raba)
                    };
                    
                    this.results.forEach(r => {
                        sessionData.results_map[r.id] = {
                            skladnost: r.skladnost,
                            obrazlozitev: r.explanation,
                            evidence: r.evidence || ''
                        };
                    });
                    
                    const payload = {
                        session_id: this.sessionId,
                        data: sessionData,
                        project_name: `Analiza ${new Date().toLocaleDateString('sl-SI')}`,
                        summary: `${this.results.length} zahtev analiziranih`
                    };
                    
                    const response = await fetch('/save-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Napaka pri shranjevanju');
                    
                    this.hasUnsavedChanges = false;
                    this.hideSaveButton();
                    this.hideLoading();
                    this.showToast('success', 'Shranjeno', 'Spremembe so bile uspe≈°no shranjene');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri shranjevanju', error.message);
                }
            },

            async autoSaveProgress() {
                if (!this.hasUnsavedChanges || !this.sessionId) return;
                await this.saveProgress();
            },

            resetAnalysis() {
                this.currentStep = 1;
                this.files = [];
                this.filesMeta = {};
                this.results = [];
                this.sessionId = null;
                this.eupRabaPairs = [];
                this.keyData = {};
                this.parcelContext = null;
                try { localStorage.removeItem('gursParcelContext'); } catch (_) {}
                this.updateParcelSummary(null);
                this.expandedRows.clear();
                document.getElementById('file-input').value = '';
                this.renderFileList();
                this.updateStepAccess();
                this.updateUI();
                document.getElementById('extract-btn').disabled = true;
                this.showToast('info', 'Resetirano', 'Zaƒçni novo analizo');
            },

            async downloadReport() {
                if (!this.sessionId) {
                    this.showToast('error', 'Napaka', 'Seja ni aktivna');
                    return;
                }
                
                if (this.hasUnsavedChanges) {
                    await this.saveProgress();
                }
                
                this.showLoading('Pripravljam poroƒçilo z va≈°imi spremembami...');
                
                try {
                    const updatedResults = {};
                    this.results.forEach(result => {
                        updatedResults[String(result.id)] = {
                            skladnost: result.skladnost,
                            obrazlozitev: result.explanation || '',
                            evidence: result.evidence || ''
                        };
                    });

                    const payload = {
                        session_id: this.sessionId,
                        excluded_ids: [],
                        updated_results_map: updatedResults,
                        updated_key_data: this.keyData
                    };
                    
                    const response = await fetch('/confirm-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Napaka pri generiranju poroƒçila');
                    const data = await response.json();
                    
                    if (data.docx_path) {
                        const docxResponse = await fetch(`/${data.docx_path}`);
                        const blob = await docxResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.docx_path.split('/').pop();
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                    
                    if (data.xlsx_path) {
                        setTimeout(async () => {
                            const xlsxResponse = await fetch(`/${data.xlsx_path}`);
                            const blob = await xlsxResponse.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = data.xlsx_path.split('/').pop();
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 1000);
                    }
                    
                    this.hideLoading();
                    this.showToast('success', 'Poroƒçilo pripravljeno', 'Word dokument vkljuƒçuje vse va≈°e spremembe');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri prenosu', error.message);
                }
            },

            async showSessionsModal() {
                document.getElementById('sessions-modal').classList.add('show');
                await this.loadSessions();
            },

            closeSessionsModal() {
                document.getElementById('sessions-modal').classList.remove('show');
            },

            showFilteredResults(filterType) {
                let filteredResults = [];
                let title = '';
                let badgeClass = '';
                let badgeText = '';
                
                if (filterType === 'compliant') {
                    filteredResults = this.results.filter(r => r.compliant);
                    title = 'Skladne Zahteve';
                    badgeClass = 'success';
                    badgeText = `${filteredResults.length} Skladnih`;
                } else if (filterType === 'non-compliant') {
                    filteredResults = this.results.filter(r => !r.compliant && !r.notRelevant);
                    title = 'Neskladne Zahteve';
                    badgeClass = 'danger';
                    badgeText = `${filteredResults.length} Neskladnih`;
                } else if (filterType === 'not-relevant') {
                    filteredResults = this.results.filter(r => r.notRelevant);
                    title = 'Zahteve - Ni Relevantno';
                    badgeClass = 'info';
                    badgeText = `${filteredResults.length} Ni Relevantno`;
                }
                
                document.getElementById('filter-modal-title').textContent = title;
                const badge = document.getElementById('filter-badge');
                badge.className = `filter-badge ${badgeClass}`;
                badge.textContent = badgeText;
                
                const filterList = document.getElementById('filter-list');
                if (filteredResults.length === 0) {
                    filterList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>Ni zahtev v tej kategoriji</p></div>';
                } else {
                    filterList.innerHTML = filteredResults.map(result => `
                        <div class="filter-item">
                            <div class="filter-item-header">
                                <span class="filter-item-id">${result.id}</span>
                                <span class="status-badge status-${badgeClass}">${result.skladnost}</span>
                            </div>
                            <div class="filter-item-title">${result.requirement}</div>
                            <div class="filter-item-explanation">${result.explanation}</div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('filter-modal').classList.add('show');
            },

            closeFilterModal() {
                document.getElementById('filter-modal').classList.remove('show');
            },

            async loadSessions() {
                const container = document.getElementById('sessions-list-container');
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÇ</div><p>Nalagam shranjene analize...</p></div>';
                
                try {
                    const response = await fetch('/saved-sessions');
                    if (!response.ok) throw new Error('Napaka pri nalaganju sej');
                    const data = await response.json();
                    
                    if (data.sessions && data.sessions.length > 0) {
                        container.innerHTML = '<div class="sessions-list">' + 
                            data.sessions.map(session => `
                                <div class="session-card">
                                    <div class="session-header">
                                        <div class="session-title">${session.project_name || 'Neimenovan projekt'}</div>
                                        <div class="session-date">${this.formatDate(session.updated_at)}</div>
                                    </div>
                                    <div class="session-summary">${session.summary || 'Brez povzetka'}</div>
                                    <div class="session-actions">
                                        <button class="btn btn-primary btn-small" onclick="app.loadSession('${session.session_id}')">üìÇ Odpri</button>
                                        <button class="btn btn-secondary btn-small" onclick="app.deleteSession('${session.session_id}')">üóëÔ∏è Izbri≈°i</button>
                                    </div>
                                </div>
                            `).join('') + '</div>';
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÇ</div><p>Trenutno ni shranjenih analiz</p></div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Napaka pri nalaganju: ' + error.message + '</p></div>';
                }
            },

            async loadSession(sessionId) {
                this.closeSessionsModal();
                this.showLoading('Nalagam shranjeno analizo...');
                
                try {
                    const response = await fetch(`/saved-sessions/${sessionId}`);
                    if (!response.ok) throw new Error('Seja ne obstaja');
                    const data = await response.json();
                    
                    this.sessionId = sessionId;
                    const sessionData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;
                    
                    this.eupRabaPairs = (sessionData.eup || []).map((eup, i) => ({
                        eup,
                        raba: (sessionData.namenska_raba || [])[i] || ''
                    }));
                    if (this.eupRabaPairs.length === 0) this.eupRabaPairs = [{ eup: '', raba: '' }];
                    
                    this.keyData = sessionData.key_data || {};
                    
                    const resultsMap = sessionData.results_map || {};
                    this.results = (sessionData.zahteve || []).map(req => {
                        const result = resultsMap[req.id] || {};
                        const skladnost = (result.skladnost || '').toLowerCase();
                        
                        return {
                            id: req.id,
                            requirement: req.naslov || 'Neznana zahteva',
                            compliant: skladnost.includes('skladno') && !skladnost.includes('neskladno'),
                            notRelevant: skladnost.includes('ni relevantno'),
                            explanation: result.obrazlozitev || 'Ni obrazlo≈æitve',
                            evidence: result.evidence || '',
                            skladnost: result.skladnost || 'Neskladno'
                        };
                    });
                    
                    this.renderEupRabaPairs();
                    this.renderKeyData();
                    this.renderResults();
                    this.updateStepAccess();
                    
                    this.currentStep = 4;
                    this.updateUI();
                    
                    this.hideLoading();
                    this.showToast('success', 'Analiza nalo≈æena', 'Lahko nadaljujete z urejanjem');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri nalaganju', error.message);
                }
            },

            async deleteSession(sessionId) {
                if (!confirm('Ali ste prepriƒçani, da ≈æelite izbrisati to analizo?')) return;
                
                try {
                    const response = await fetch(`/saved-sessions/${sessionId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Napaka pri brisanju');
                    
                    this.showToast('success', 'Izbrisano', 'Analiza je bila izbrisana');
                    await this.loadSessions();
                } catch (error) {
                    this.showToast('error', 'Napaka pri brisanju', error.message);
                }
            },

            formatDate(dateString) {
                if (!dateString) return 'Neznano';
                const date = new Date(dateString);
                return date.toLocaleDateString('sl-SI', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            showProgress(title, message, percentage) {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar) return;
                const safePercentage = Math.max(0, Math.min(percentage, 100));
                document.getElementById('progress-title').textContent = title;
                document.getElementById('progress-message').textContent = message;
                document.getElementById('progress-fill').style.width = `${safePercentage}%`;
                document.getElementById('progress-percentage').textContent = `${safePercentage}%`;
                progressBar.classList.add('active');
            },

            updateProgress(title, message, percentage) {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar || !progressBar.classList.contains('active')) {
                    this.showProgress(title, message, percentage);
                    return;
                }
                const safePercentage = Math.max(0, Math.min(percentage, 100));
                document.getElementById('progress-title').textContent = title;
                document.getElementById('progress-message').textContent = message;
                document.getElementById('progress-fill').style.width = `${safePercentage}%`;
                document.getElementById('progress-percentage').textContent = `${safePercentage}%`;
            },

            hideProgress() {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar) return;
                progressBar.classList.remove('active');
            },

            showPopupBlockedModal(fileUrl) {
                const modalHtml = `
                    <div class="modal-overlay show" id="popup-blocked-modal" style="z-index: 10000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; opacity: 1; pointer-events: all;">
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text);">üö´ Blokirano pojavno okno</h2>
                                <button onclick="app.closePopupBlockedModal()" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">‚úï</button>
                            </div>
                            <div style="padding: 1rem 0;">
                                <p style="margin-bottom: 1rem; color: var(--text);">Va≈° brskalnik je blokiral odpiranje PDF-ja v novem oknu.</p>
                                <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">Kliknite na spodnji gumb za odpiranje:</p>
                                <a href="${fileUrl}" target="_blank" class="btn btn-primary" style="display: block; text-align: center; text-decoration: none; margin-bottom: 1rem;" onclick="app.closePopupBlockedModal()">üìÑ Odpri PDF v novem oknu</a>
                                <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-top: 1rem;">
                                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;"><strong>üí° Nasvet:</strong></p>
                                    <p style="font-size: 0.85rem; color: var(--text-muted); margin: 0;">ƒåe ≈æelite omogoƒçiti samodejno odpiranje, dovolite pojavna okna za to stran v nastavitvah brskalnika.</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                const temp = document.createElement('div');
                temp.innerHTML = modalHtml.trim();
                document.body.appendChild(temp.firstChild);
            },

            closePopupBlockedModal() {
                const modal = document.getElementById('popup-blocked-modal');
                if (modal) {
                    modal.remove();
                }
            },

            showLoading(message) {
                document.getElementById('loading-message').textContent = message;
                document.getElementById('loading-overlay').classList.remove('hidden');
            },

            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            },

            showToast(type, title, message) {
                const toast = document.getElementById('toast');
                toast.className = `toast toast-${type}`;
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-message').textContent = message;
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => toast.classList.remove('show'), 4000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>