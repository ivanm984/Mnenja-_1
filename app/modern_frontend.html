<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiza Skladnosti s PIA</title>
    
    <!-- PDF.js knjižnica -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Light/Dark Mode Variables */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --pdf-panel-width: 50vw;
            --pdf-panel-max-width: 900px;
        }
        
        body.dark-mode {
            --bg-main: #0f172a; --bg-card: rgba(30, 41, 59, 0.7);
            --bg-glass: rgba(51, 65, 85, 0.5); --text: #f1f5f9;
            --text-muted: #94a3b8; --border: rgba(148, 163, 184, 0.2);
            --input-bg: rgba(30, 41, 59, 0.5);
        }
        
        body.light-mode {
            --bg-main: #f8fafc; --bg-card: rgba(255, 255, 255, 0.9);
            --bg-glass: rgba(248, 250, 252, 0.8); --text: #0f172a;
            --text-muted: #64748b; --border: rgba(148, 163, 184, 0.3);
            --input-bg: rgba(255, 255, 255, 0.8);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text); min-height: 100vh; overflow-x: hidden;
            transition: all 0.3s ease;
        }
        
        body.dark-mode { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        body.light-mode { background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%); }
        
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%;
            width: 200%; height: 200%;
            animation: drift 20s ease-in-out infinite; pointer-events: none; z-index: 0;
        }
        
        body.dark-mode::before {
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
        }
        
        body.light-mode::before {
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
        }
        
        @keyframes drift { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(-10%, 10%) rotate(180deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes processing-pulse { 0%, 100% { box-shadow: 0 0 30px rgba(99, 102, 241, 0.6), 0 0 60px rgba(99, 102, 241, 0.3); } 50% { box-shadow: 0 0 40px rgba(99, 102, 241, 0.8), 0 0 80px rgba(99, 102, 241, 0.5); } }
        @keyframes processing-spin { 0% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.08) rotate(180deg); } 100% { transform: scale(1) rotate(360deg); } }
        @keyframes progressShimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        
        .hidden { display: none !important; }
        .app-container { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 2rem; transition: margin 0.35s ease, width 0.35s ease, max-width 0.35s ease; }
        .progress-bar-container { position: fixed; top: 0; left: 0; right: 0; z-index: 4000; background: var(--bg-card); border-bottom: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); transform: translateY(-100%); transition: transform 0.3s ease; }
        .progress-bar-container.active { transform: translateY(0); }
        .progress-bar-content { padding: 1rem 2rem; display: flex; align-items: center; gap: 1rem; }
        .progress-bar-info { flex: 1; min-width: 0; }
        .progress-bar-title { font-weight: 600; color: var(--text); margin-bottom: 0.25rem; font-size: 0.95rem; }
        .progress-bar-message { font-size: 0.85rem; color: var(--text-muted); }
        .progress-bar-track { flex: 2; height: 8px; background: var(--input-bg); border-radius: 4px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); border-radius: 4px; transition: width 0.3s ease; position: relative; overflow: hidden; }
        .progress-bar-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent); animation: progressShimmer 1.5s infinite; }
        .progress-bar-percentage { font-size: 0.9rem; font-weight: 600; color: var(--text); min-width: 45px; text-align: right; }
        .progress-bar-spinner { width: 20px; height: 20px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        body.pdf-viewer-active .app-container {
            margin: 0;
            margin-left: min(var(--pdf-panel-width), var(--pdf-panel-max-width));
            width: clamp(320px, calc(100vw - min(var(--pdf-panel-width), var(--pdf-panel-max-width)) - 4rem), 1400px);
            max-width: clamp(320px, calc(100vw - min(var(--pdf-panel-width), var(--pdf-panel-max-width)) - 4rem), 1400px);
        }
        .header { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); animation: slideDown 0.6s ease-out; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem; }
        .logo-section h1 { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; }
        .logo-section p { color: var(--text-muted); font-size: 0.95rem; }
        .header-actions { display: flex; gap: 0.75rem; align-items: center; }
        
        .theme-toggle { width: 50px; height: 50px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-glass); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: all 0.3s ease; }
        .theme-toggle:hover { transform: scale(1.1); background: var(--primary); }
        
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 12px; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; font-family: inherit; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6); }
        .btn-secondary { background: var(--bg-glass); border: 1px solid var(--border); color: var(--text); backdrop-filter: blur(10px); }
        .btn-secondary:hover:not(:disabled) { border-color: var(--primary-light); background: rgba(99, 102, 241, 0.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.85rem; }
        
        .progress-steps { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); animation: fadeIn 0.8s ease-out 0.2s both; }
        .steps-container { display: flex; justify-content: space-between; position: relative; gap: 1rem; }
        .steps-container::before { content: ''; position: absolute; top: 30px; left: 60px; right: 60px; height: 2px; background: var(--border); z-index: 0; }
        .step { flex: 1; text-align: center; position: relative; z-index: 1; cursor: pointer; transition: transform 0.3s ease; }
        .step:hover { transform: scale(1.05); }
        .step.disabled { cursor: not-allowed; opacity: 0.5; }
        .step.disabled:hover { transform: none; }
        .step-circle { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem; transition: all 0.4s ease; background: var(--bg-card); border: 2px solid var(--border); color: var(--text-muted); }
        .step.active .step-circle { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); border-color: var(--primary); color: white; box-shadow: 0 0 30px rgba(99, 102, 241, 0.5); animation: pulse 2s ease-in-out infinite; }
        .step.completed .step-circle { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); border-color: var(--success); color: white; }
        .step.completed .step-circle::after { content: '✓'; font-size: 1.5rem; }
        .step-circle.processing { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border: 3px solid var(--primary); color: white; box-shadow: 0 0 30px rgba(99, 102, 241, 0.6), 0 0 60px rgba(99, 102, 241, 0.3); animation: processing-pulse 1.5s ease-in-out infinite, processing-spin 3s linear infinite; position: relative; }
        .step-circle.processing::before { content: ''; position: absolute; top: -3px; left: -3px; right: -3px; bottom: -3px; border-radius: 50%; border: 3px solid transparent; border-top-color: var(--primary-light); border-right-color: var(--primary-light); animation: spin 1s linear infinite; }
        .step-circle.processing::after { content: '⚡'; font-size: 1.5rem; animation: pulse 0.8s ease-in-out infinite; }
        .step-label { font-weight: 600; color: var(--text-muted); transition: color 0.3s ease; }
        .step.active .step-label, .step.completed .step-label { color: var(--text); }
        
        .content-card { backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 24px; padding: 2.5rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.1); animation: fadeIn 0.8s ease-out 0.4s both; min-height: 400px; }
        .section-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; color: var(--text); }
        
        .upload-zone { border: 2px dashed var(--border); border-radius: 20px; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.4s ease; background: var(--input-bg); margin: 1.5rem 0; }
        .upload-zone:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); transform: translateY(-5px); }
        .upload-zone.dragging { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); transform: scale(1.02); }
        .upload-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.6; }
        
        .file-list { margin-top: 2rem; display: grid; gap: 1rem; }
        .file-item { backdrop-filter: blur(10px); background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; animation: slideIn 0.4s ease-out; }
        .file-item:hover { border-color: var(--primary-light); transform: translateX(5px); }
        .file-info { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .file-meta { display: flex; flex-direction: column; gap: 0.25rem; flex: 1; }
        .file-actions { display: flex; gap: 0.5rem; align-items: center; }
        .remove-file { background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); color: var(--danger); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .remove-file:hover { background: var(--danger); color: white; }
        .preview-file { background: rgba(99, 102, 241, 0.2); border: 1px solid rgba(99, 102, 241, 0.3); color: var(--primary); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .preview-file:hover { background: var(--primary); color: white; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text); font-size: 0.95rem; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.875rem 1.25rem; border: 1px solid var(--border); border-radius: 12px; background: var(--input-bg); color: var(--text); font-family: inherit; font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .form-input.error, .form-select.error, .form-textarea.error { border-color: var(--danger); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); animation: shake 0.5s ease; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-input:disabled { opacity: 0.7; cursor: not-allowed; background: var(--bg-alt); }
        .error-message { color: var(--danger); font-size: 0.85rem; margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem; animation: slideIn 0.3s ease; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .municipality-display { display: flex; align-items: center; gap: 0.75rem; padding: 1rem 1.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .municipality-icon { font-size: 1.5rem; }
        .municipality-info { flex: 1; }
        .municipality-name { font-weight: 600; color: var(--text); font-size: 1.1rem; }
        .municipality-subtitle { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem; }
        
        .key-data-grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); margin-bottom: 2rem; }
        .key-data-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; transition: all 0.3s ease; }
        .key-data-item:hover { border-color: var(--primary-light); }
        .key-data-item textarea { min-height: 60px; resize: none; overflow: hidden; }
        
        .spinner-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(99, 102, 241, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem; }

        .analysis-status-description { color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem; }
        .analysis-status-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; display: flex; flex-direction: column; gap: 1.5rem; box-shadow: 0 20px 40px -20px rgb(15 23 42 / 0.45); }
        .analysis-status-header { display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap; }
        .analysis-status-spinner { width: 56px; height: 56px; border-radius: 50%; border: 4px solid rgba(99, 102, 241, 0.25); border-top-color: var(--primary); animation: spin 1s linear infinite; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.35rem; color: var(--primary); }
        .analysis-status-spinner.completed { animation: none; border-color: rgba(16, 185, 129, 0.25); border-top-color: var(--success); color: var(--success); }
        .analysis-status-spinner.completed::after { content: '✓'; }
        .analysis-status-spinner.error { animation: none; border-color: rgba(239, 68, 68, 0.25); border-top-color: var(--danger); color: var(--danger); }
        .analysis-status-spinner.error::after { content: '⚠'; }
        .analysis-status-title { font-size: 1.3rem; font-weight: 700; color: var(--text); }
        .analysis-status-message { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.25rem; }
        .analysis-status-progress { display: flex; align-items: center; gap: 1rem; }
        .analysis-progress-bar { flex: 1; height: 8px; background: var(--input-bg); border-radius: 4px; overflow: hidden; position: relative; }
        .analysis-progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--primary-light)); border-radius: 4px; transition: width 0.3s ease; }
        .analysis-progress-percentage { font-weight: 700; font-size: 0.95rem; min-width: 45px; text-align: right; color: var(--text); }
        .analysis-status-history { display: flex; flex-direction: column; gap: 1rem; }
        .analysis-status-subtitle { font-weight: 600; color: var(--text); font-size: 1rem; }
        .analysis-status-log { list-style: none; display: none; flex-direction: column; gap: 0.75rem; margin: 0; padding: 0; max-height: 220px; overflow-y: auto; }
        .analysis-status-log-item { display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; padding: 0.85rem 1rem; border-radius: 14px; border: 1px solid var(--border); background: var(--bg-card); }
        .analysis-status-log-message { flex: 1; font-size: 0.9rem; color: var(--text); line-height: 1.4; }
        .analysis-status-log-time { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; }
        .analysis-status-empty { border: 1px dashed var(--border); border-radius: 12px; padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.9rem; }

        @media (max-width: 768px) {
            .analysis-status-card { padding: 1.5rem; }
            .analysis-status-spinner { width: 48px; height: 48px; }
            .analysis-status-header { gap: 1rem; }
        }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { padding: 1.5rem; border-radius: 16px; border: 1px solid; cursor: pointer; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
        .stat-card.success { background: rgba(16, 185, 129, 0.1); border-color: var(--success); }
        .stat-card.success:hover { background: rgba(16, 185, 129, 0.15); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.2); }
        .stat-card.danger { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); }
        .stat-card.danger:hover { background: rgba(239, 68, 68, 0.15); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.2); }
        .stat-card.info { background: rgba(59, 130, 246, 0.1); border-color: var(--info); }
        .stat-card.info:hover { background: rgba(59, 130, 246, 0.15); box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        
        .results-table { width: 100%; margin-top: 2rem; border-collapse: separate; border-spacing: 0 0.5rem; }
        .results-table thead th { background: var(--bg-card); padding: 1rem; text-align: left; font-weight: 600; color: var(--text-muted); text-transform: uppercase; font-size: 0.85rem; }
        .results-table tbody tr { background: var(--bg-card); transition: all 0.3s ease; }
        .results-table tbody tr:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .results-table tbody td { padding: 1rem; vertical-align: top; }
        .results-table tbody td:last-child { max-width: 500px; }
        
        .editable-cell { position: relative; }
        .editable-text { min-height: 60px; width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); color: var(--text); font-family: inherit; font-size: 0.9rem; line-height: 1.5; resize: none; overflow: hidden; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .editable-text:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .editable-text.modified { border: 2px solid #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        
        .status-select { padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; border: 1px solid; background: var(--input-bg); color: var(--text); cursor: pointer; }
        .status-select:focus { outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        
        .status-badge { display: inline-block; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        .status-success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .status-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .status-info { background: rgba(59, 130, 246, 0.2); color: var(--info); border: 1px solid var(--info); }
        
        .requirement-text { cursor: pointer; color: var(--primary); text-decoration: underline; }
        .requirement-text:hover { color: var(--primary-dark); }
        .truncated { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        
        .actions-bar { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; align-items: center; }

        /* PDF Dropdown */
        .pdf-dropdown { position: relative; display: inline-block; }
        .pdf-dropdown-btn { display: flex; align-items: center; gap: 0.5rem; }
        .pdf-dropdown-content { display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 0.5rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); min-width: 280px; max-width: 400px; z-index: 1000; max-height: 300px; overflow-y: auto; }
        .pdf-dropdown.open .pdf-dropdown-content { display: block; animation: slideUp 0.2s ease-out; }
        .pdf-dropdown-item { padding: 0.75rem 1rem; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid var(--border); }
        .pdf-dropdown-item:last-child { border-bottom: none; }
        .pdf-dropdown-item:hover { background: rgba(99, 102, 241, 0.1); }
        .pdf-dropdown-item-icon { font-size: 1.2rem; }
        .pdf-dropdown-item-text { flex: 1; }
        .pdf-dropdown-item-name { font-weight: 600; color: var(--text); font-size: 0.9rem; }
        .pdf-dropdown-item-size { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.15rem; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast { position: fixed; bottom: 2rem; right: 2rem; backdrop-filter: blur(20px); background: var(--bg-glass); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem 1.5rem; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.2); max-width: 400px; z-index: 1001; opacity: 0; transform: translateX(100px); transition: all 0.4s ease; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }
        
        /* Modal za shranjene seje */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.3); animation: slideDown 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .modal-close { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); transition: all 0.3s ease; }
        .modal-close:hover { color: var(--danger); transform: scale(1.2); }
        .sessions-list { display: grid; gap: 1rem; }
        .session-card { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; transition: all 0.3s ease; cursor: pointer; }
        .session-card:hover { border-color: var(--primary); transform: translateX(5px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2); }
        .session-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
        .session-title { font-weight: 600; font-size: 1.1rem; color: var(--text); }
        .session-date { font-size: 0.85rem; color: var(--text-muted); }
        .session-summary { color: var(--text-muted); font-size: 0.95rem; margin-top: 0.5rem; }
        .session-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
        
        /* Filter modal */
        .filter-modal-content { max-width: 1000px; }
        .filter-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .filter-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 600; font-size: 1rem; }
        .filter-badge.success { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .filter-badge.danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .filter-badge.info { background: rgba(59, 130, 246, 0.2); color: var(--info); border: 1px solid var(--info); }
        .filter-list { display: grid; gap: 1rem; max-height: 60vh; overflow-y: auto; }
        .filter-item { background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
        .filter-item-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; }
        .filter-item-id { font-weight: 700; font-size: 1rem; color: var(--primary); }
        .filter-item-title { font-weight: 600; color: var(--text); margin-bottom: 0.5rem; line-height: 1.5; }
        .filter-item-explanation { color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; }
        
        /* PDF Viewer Modal */
        .pdf-viewer-modal { position: fixed; top: 0; left: 0; width: min(var(--pdf-panel-width), var(--pdf-panel-max-width)); height: 100%; background: var(--bg-card); z-index: 3000; display: flex; flex-direction: column; border-right: 1px solid var(--border); box-shadow: 12px 0 40px rgba(15, 23, 42, 0.35); transform: translateX(-100%); transition: transform 0.35s ease; }
        .pdf-viewer-modal.open { transform: translateX(0); }
        .pdf-viewer-modal.resizing { transition: none; }
        .pdf-resize-handle { position: absolute; top: 0; right: -6px; width: 12px; height: 100%; cursor: ew-resize; z-index: 10; display: block; }
        .pdf-resize-handle::after { content: ''; position: absolute; top: 50%; right: 4px; width: 2px; height: 60px; background: var(--border); border-radius: 2px; transform: translateY(-50%); }
        .pdf-viewer-header { background: var(--bg-card); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18); }
        .pdf-viewer-title { font-size: 1.1rem; font-weight: 600; color: var(--text); max-width: 50%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pdf-viewer-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .pdf-zoom-controls { display: flex; gap: 0.5rem; align-items: center; }
        .pdf-zoom-value { font-size: 0.9rem; color: var(--text-muted); min-width: 60px; text-align: center; }
        .pdf-page-nav { display: flex; gap: 0.5rem; align-items: center; }
        .pdf-page-info { font-size: 0.9rem; color: var(--text-muted); min-width: 120px; text-align: center; }
        .pdf-viewer-body { flex: 1; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 2rem; background: rgba(15, 23, 42, 0.9); }
        .pdf-viewer-body.pan-mode { cursor: grab; }
        .pdf-viewer-body.pan-mode.dragging { cursor: grabbing; }
        .pdf-canvas-container { background: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); max-width: 100%; border-radius: 12px; overflow: hidden; }
        #pdfCanvas { display: block; max-width: 100%; height: auto; }
        .pdf-loading { color: white; font-size: 1.1rem; text-align: center; }

        @media (max-width: 1024px) {
            .pdf-viewer-modal { width: 100vw; max-width: 100vw; }
            body.pdf-viewer-active .app-container { margin-left: 0; max-width: 1400px; display: none; }
            .pdf-resize-handle { display: none; }
        }

        @media (max-width: 768px) {
            .app-container { padding: 1rem; }
            .header-content { flex-direction: column; text-align: center; }
            .steps-container { flex-direction: column; gap: 2rem; }
            .steps-container::before { display: none; }
            .key-data-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; padding: 1.5rem; }
            .pdf-viewer-controls { flex-direction: column; align-items: stretch; gap: 0.5rem; }
            .pdf-viewer-title { max-width: 100%; }
            .pdf-viewer-modal { width: 100vw; border-right: none; box-shadow: none; }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="progress-bar-container" id="progress-bar">
        <div class="progress-bar-content">
            <div class="progress-bar-spinner"></div>
            <div class="progress-bar-info">
                <div class="progress-bar-title" id="progress-title">Procesiranje...</div>
                <div class="progress-bar-message" id="progress-message">Pripravljam dokumente</div>
            </div>
            <div class="progress-bar-track">
                <div class="progress-bar-fill" id="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="progress-bar-percentage" id="progress-percentage">0%</div>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>🏛️ Analiza Skladnosti s PIA</h1>
                    <p>Inteligentna analiza projektne dokumentacije</p>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="app.toggleTheme()" title="Preklopi temo">
                        <span id="theme-icon">🌙</span>
                    </button>
                    <button class="btn btn-secondary" onclick="app.showSessionsModal()">📁 Shranjeno</button>
                </div>
            </div>
        </div>

        <div class="progress-steps">
            <div class="steps-container">
                <div class="step active" id="step-1" onclick="app.goToStep(1)">
                    <div class="step-circle">1</div>
                    <div class="step-label">Nalaganje</div>
                </div>
                <div class="step disabled" id="step-2" onclick="app.goToStep(2)">
                    <div class="step-circle">2</div>
                    <div class="step-label">Pregled</div>
                </div>
                <div class="step disabled" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Analiza</div>
                </div>
                <div class="step disabled" id="step-4" onclick="app.goToStep(4)">
                    <div class="step-circle">4</div>
                    <div class="step-label">Rezultati</div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <!-- Step 1: Upload -->
            <div id="content-step-1">
                <h2 class="section-title">📤 Nalaganje Dokumentov</h2>
                <div class="form-group">
                    <label class="form-label">Občina</label>
                    <div class="municipality-display">
                        <span class="municipality-icon">🏛️</span>
                        <div class="municipality-info">
                            <div class="municipality-name">Občina Litija</div>
                            <div class="municipality-subtitle">Izbrana občina za analizo</div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Številka zadeve (opcijsko)</label>
                    <input type="text" id="stevilka-zadeve" class="form-input" placeholder="npr. 351-123/2024">
                </div>
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">📄</div>
                    <h3>Povleci datoteke sem ali klikni za izbiro</h3>
                    <p style="color: var(--text-muted); margin-top: 0.5rem;">PDF, Excel ali slike • Največ 50MB</p>
                    <input type="file" id="file-input" multiple accept=".pdf,.xlsx,.xls,.png,.jpg,.jpeg" style="display: none" onchange="app.handleFileSelect(event)">
                </div>
                <div class="file-list" id="file-list"></div>
                <div class="actions-bar">
                    <div class="pdf-dropdown" id="pdf-dropdown" style="display: none;">
                        <button class="btn btn-secondary pdf-dropdown-btn" id="pdf-preview-btn" onclick="app.togglePdfDropdown()">
                            <span id="pdf-dropdown-arrow">▼</span>
                        </button>
                        <div class="pdf-dropdown-content" id="pdf-dropdown-content"></div>
                    </div>
                    <button class="btn btn-primary" id="extract-btn" onclick="app.extractData()" disabled>🚀 Začni Analizo</button>
                </div>
            </div>

            <!-- Step 2: Review -->
            <div id="content-step-2" class="hidden">
                <h2 class="section-title">📋 Pregled in Potrditev Podatkov</h2>
                
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.25rem;">A. EUP in Namenska Raba *</h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">* Obvezna polja - brez njih analiza ne bo mogoča</p>
                <div id="eup-raba-container" style="margin-bottom: 2rem;"></div>
                <div id="validation-error" class="error-message" style="display: none;">
                    <span>⚠️</span>
                    <span>Prosimo izpolnite EUP in Namensko rabo za vse pare</span>
                </div>
                
                <h3 style="margin-bottom: 1rem; color: var(--text); font-size: 1.25rem;">B. Ključni Podatki Projekta</h3>
                <div class="key-data-grid" id="key-data-grid"></div>
                
                <div class="actions-bar">
                    <button class="btn btn-secondary" onclick="app.goToStep(2)">← Uredi Podatke</button>
                    <button class="btn btn-secondary" onclick="app.openGursMap()">🗺️ Prikaz na Zemljevidu</button>
                    <button class="btn btn-primary" onclick="app.confirmAndAnalyze()">Generiraj Poročilo</button>
                </div>
            </div>

            <!-- Step 3: Analysis progress -->
            <div id="content-step-3" class="hidden">
                <h2 class="section-title">🔄 Analiza v teku</h2>
                <p class="analysis-status-description">Napredna AI analiza pregleda vse izbrane pogoje in sproti posodablja napredek. Stran ostane aktivna, zato lahko spremljate ključne korake brez prekinitev.</p>

                <div class="analysis-status-card">
                    <div class="analysis-status-header">
                        <div class="analysis-status-spinner" id="analysis-status-spinner"></div>
                        <div>
                            <div class="analysis-status-title" id="analysis-status-title">Analiza ni zagnana</div>
                            <div class="analysis-status-message" id="analysis-status-message">Dokončajte pripravo podatkov in zaženite postopek.</div>
                        </div>
                    </div>

                    <div class="analysis-status-progress">
                        <div class="analysis-progress-bar">
                            <div class="analysis-progress-fill" id="analysis-progress-fill" style="width: 0%;"></div>
                        </div>
                        <div class="analysis-progress-percentage" id="analysis-progress-percentage">0%</div>
                    </div>

                    <div class="analysis-status-history">
                        <div class="analysis-status-subtitle">Zgodovina korakov</div>
                        <ul class="analysis-status-log" id="analysis-status-log"></ul>
                        <div class="analysis-status-empty" id="analysis-status-empty">Čakam na prve podatke o poteku analize.</div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div id="content-step-4" class="hidden">
                <h2 class="section-title">✅ Rezultati Analize</h2>
                <div class="stats-grid">
                    <div class="stat-card success" onclick="app.showFilteredResults('compliant')">
                        <div class="stat-value" style="color: var(--success);" id="compliant-count">0</div>
                        <div style="color: var(--text-muted);">Skladnih zahtev</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">👆 Klikni za prikaz</div>
                    </div>
                    <div class="stat-card danger" onclick="app.showFilteredResults('non-compliant')">
                        <div class="stat-value" style="color: var(--danger);" id="non-compliant-count">0</div>
                        <div style="color: var(--text-muted);">Neskladnih zahtev</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">👆 Klikni za prikaz</div>
                    </div>
                    <div class="stat-card info" onclick="app.showFilteredResults('not-relevant')">
                        <div class="stat-value" style="color: var(--info);" id="not-relevant-count">0</div>
                        <div style="color: var(--text-muted);">Ni relevantno</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">👆 Klikni za prikaz</div>
                    </div>
                </div>
                <table class="results-table">
                    <thead><tr><th style="width: 80px;">ID</th><th style="width: 250px;">Zahteva</th><th style="width: 150px;">Status</th><th>Obrazložitev</th></tr></thead>
                    <tbody id="results-tbody"></tbody>
                </table>
                <div class="actions-bar">
                    <button class="btn btn-secondary" onclick="app.resetAnalysis()">🔄 Nova Analiza</button>
                    <button class="btn btn-primary" onclick="app.saveProgress()" id="save-btn" style="display: none;">💾 Shrani sejo</button>
                    <div style="display: flex; align-items: center; gap: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem 1.25rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="report-format-summary" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: 600; font-size: 0.9rem;">Skrajšana verzija (samo naslovi členov)</span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="app.downloadReport()">📥 Prenesi Poročilo</button>
                </div>
            </div>
        </div>

        <div class="spinner-overlay hidden" id="loading-overlay">
            <div><div class="spinner"></div><div style="color: var(--text); font-size: 1.1rem; font-weight: 600; text-align: center;" id="loading-message">Nalagam...</div></div>
        </div>

        <div class="toast" id="toast">
            <div style="font-weight: 600; margin-bottom: 0.25rem;" id="toast-title"></div>
            <div style="color: var(--text-muted); font-size: 0.9rem;" id="toast-message"></div>
        </div>
        
        <!-- Modal za shranjene seje -->
        <div class="modal-overlay" id="sessions-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">📁 Shranjene Analize</h2>
                    <button class="modal-close" onclick="app.closeSessionsModal()">✕</button>
                </div>
                <div id="sessions-list-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">📂</div>
                        <p>Nalagam shranjene analize...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal za filtriran prikaz zahtev -->
        <div class="modal-overlay" id="filter-modal">
            <div class="modal-content filter-modal-content">
                <div class="modal-header">
                    <div class="filter-header">
                        <h2 class="modal-title" id="filter-modal-title">Zahteve</h2>
                        <span class="filter-badge" id="filter-badge"></span>
                    </div>
                    <button class="modal-close" onclick="app.closeFilterModal()">✕</button>
                </div>
                <div class="filter-list" id="filter-list"></div>
            </div>
        </div>
        
        <!-- PDF Viewer Modal -->
        <div id="pdf-viewer-modal" class="pdf-viewer-modal hidden">
            <div class="pdf-resize-handle" id="pdf-resize-handle"></div>
            <div class="pdf-viewer-header">
                <div class="pdf-viewer-title" id="pdf-viewer-title">PDF Predogled</div>
                <div class="pdf-viewer-controls">
                    <button class="btn btn-secondary btn-small" onclick="app.togglePanMode()" id="pdf-pan-btn" title="Premikanje po dokumentu">✋ Pan</button>
                    <div class="pdf-zoom-controls">
                        <button class="btn btn-secondary btn-small" onclick="app.pdfZoomOut()" id="pdf-zoom-out">−</button>
                        <span class="pdf-zoom-value" id="pdf-zoom-value">100%</span>
                        <button class="btn btn-secondary btn-small" onclick="app.pdfZoomIn()" id="pdf-zoom-in">+</button>
                    </div>
                    <div class="pdf-page-nav" id="pdf-page-nav" style="display: none;">
                        <button class="btn btn-secondary btn-small" onclick="app.pdfPrevPage()" id="pdf-prev-page">← Prejšnja</button>
                        <span class="pdf-page-info" id="pdf-page-info">Stran 1 / 1</span>
                        <button class="btn btn-secondary btn-small" onclick="app.pdfNextPage()" id="pdf-next-page">Naslednja →</button>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="app.printPdf()" id="pdf-print-btn" title="Natisni dokument">🖨️ Print</button>
                    <button class="btn btn-secondary btn-small" onclick="app.popOutPdfViewer()" id="pdf-popout" disabled>🗖 Odpri v novem oknu</button>
                    <button class="btn btn-primary btn-small" onclick="app.closePdfViewer()">Zapri</button>
                </div>
            </div>
            <div class="pdf-viewer-body" id="pdf-viewer-body">
                <div class="pdf-loading" id="pdf-loading">Nalagam PDF dokument...</div>
                <div class="pdf-canvas-container" id="pdf-canvas-container" style="display: none;">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const KEY_DATA_LABELS = {
            glavni_objekt: 'Objekt (Opis funkcije)',
            vrsta_gradnje: 'Vrsta gradnje',
            klasifikacija_cc_si: 'CC-SI Klasifikacija',
            nezahtevni_objekti: 'Nezahtevni objekti v projektu',
            enostavni_objekti: 'Enostavni objekti v projektu',
            vzdrzevalna_dela: 'Vzdrževalna dela / Manjša rekonstrukcija',
            parcela_objekta: 'Gradbena parcela (št.)',
            stevilke_parcel_ko: 'Vse parcele in K.O.',
            velikost_parcel: 'Skupna velikost parcel',
            velikost_obstojecega_objekta: 'Velikost obstoječega objekta',
            tlorisne_dimenzije: 'Nove tlorisne dimenzije',
            gabariti_etaznost: 'Novi gabarit/Etažnost',
            faktor_zazidanosti_fz: 'Faktor zazidanosti (FZ)',
            faktor_izrabe_fi: 'Faktor izrabe (FI)',
            zelene_povrsine: 'Zelene površine (FZP/m²)',
            naklon_strehe: 'Naklon strehe',
            kritina_barva: 'Kritina/Barva',
            materiali_gradnje: 'Materiali gradnje',
            smer_slemena: 'Smer slemena',
            visinske_kote: 'Višinske kote (k.p., k.s.)',
            odmiki_parcel: 'Odmiki od parcelnih mej',
            komunalni_prikljucki: 'Komunalni priključki/Oskrba'
        };

    const app = {
        currentStep: 1,
        files: [],
        filesMeta: {},
        results: [],
        sessionId: null,
        eupRabaPairs: [],
        keyData: {},
        expandedRows: new Set(),
        hasUnsavedChanges: false,
        isSaving: false,
        saveTimeout: null,

        // PDF Viewer state
        pdfDoc: null,
        pdfCurrentPage: 1,
        pdfTotalPages: 0,
        pdfZoom: 1.5,
        pdfLoading: false,
        pdfCloseTimeout: null,
        currentPdfFile: null,
        pdfPopoutButton: null,
        pdfScrollTimeout: null,
        pdfWidth: 50,
        isResizing: false,
        panMode: false,
        isDragging: false,
        dragStartX: 0,
        dragStartY: 0,
        scrollStartX: 0,
        scrollStartY: 0,
        originalTextareaValues: new Map(),

        // Progress tracking state
        progressInterval: null,
        currentProgress: null,
        progressContext: null,
        analysisStatusLog: [],
        lastProgressMessage: null,

        // ⭐ DODAJ TO FUNKCIJO TUKAJ ⭐
        openGursMap() {
            if (!this.sessionId) {
                this.showToast('error', 'Napaka', 'Najprej je potrebno izvesti ekstrakcijo podatkov');
                return;
            }
            const mapUrl = `/api/gurs/map?session_id=${this.sessionId}`;
            window.open(mapUrl, '_blank', 'width=1400,height=900');
        },

            init() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.body.className = `${savedTheme}-mode`;
                document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '🌙' : '☀️';

                this.pdfPopoutButton = document.getElementById('pdf-popout');
                this.setPdfPopoutEnabled(false);

                const savedPdfWidth = parseFloat(localStorage.getItem('pdfWidth') || '');
                if (!Number.isNaN(savedPdfWidth) && savedPdfWidth >= 20 && savedPdfWidth <= 80) {
                    this.pdfWidth = savedPdfWidth;
                }
                document.documentElement.style.setProperty('--pdf-panel-width', `${this.pdfWidth}vw`);

                const uploadZone = document.getElementById('upload-zone');
                uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragging'); });
                uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragging'));
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragging');
                    this.addFiles(Array.from(e.dataTransfer.files));
                });

                const pdfBody = document.getElementById('pdf-viewer-body');
                if (pdfBody) {
                    pdfBody.addEventListener('wheel', (event) => this.handlePdfScroll(event), { passive: false });
                }

                this.initPdfResize();
                this.initKeyboardShortcuts();
                this.updateSaveButtonState();
            },

            initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Escape - Close PDF viewer if open
                    if (e.key === 'Escape') {
                        if (this.pdfDoc) {
                            this.closePdfViewer();
                        }
                    }

                    // Arrow keys for PDF navigation
                    if (this.pdfDoc && !this.pdfLoading) {
                        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                            e.preventDefault();
                            this.pdfPrevPage();
                        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                            e.preventDefault();
                            this.pdfNextPage();
                        }
                    }
                });
            },

            getPdfPopoutButton() {
                if (!this.pdfPopoutButton || !document.body.contains(this.pdfPopoutButton)) {
                    this.pdfPopoutButton = document.getElementById('pdf-popout');
                }
                return this.pdfPopoutButton;
            },

            setPdfPopoutEnabled(isEnabled) {
                const button = this.getPdfPopoutButton();
                if (button) {
                    button.disabled = !isEnabled;
                }
            },

            initPdfResize() {
                const resizeHandle = document.getElementById('pdf-resize-handle');
                const pdfModal = document.getElementById('pdf-viewer-modal');
                if (!resizeHandle || !pdfModal) return;

                resizeHandle.addEventListener('mousedown', (event) => {
                    if (window.innerWidth <= 1024) return;
                    event.preventDefault();
                    this.isResizing = true;
                    pdfModal.classList.add('resizing');
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                });

                document.addEventListener('mousemove', (event) => {
                    if (!this.isResizing) return;
                    const newWidth = (event.clientX / window.innerWidth) * 100;
                    if (newWidth >= 20 && newWidth <= 80) {
                        this.pdfWidth = newWidth;
                        document.documentElement.style.setProperty('--pdf-panel-width', `${newWidth}vw`);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (!this.isResizing) return;
                    this.isResizing = false;
                    pdfModal.classList.remove('resizing');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    localStorage.setItem('pdfWidth', String(this.pdfWidth));
                });
            },

            handlePdfScroll(event) {
                if (!this.pdfDoc || this.pdfLoading || this.pdfTotalPages <= 1) return;

                // Clear existing timeout
                if (this.pdfScrollTimeout) {
                    clearTimeout(this.pdfScrollTimeout);
                }

                // Debounce scroll events
                this.pdfScrollTimeout = setTimeout(() => {
                    if (event.deltaY > 0) {
                        // Scroll down - next page
                        if (this.pdfCurrentPage < this.pdfTotalPages) {
                            this.renderPdfPage(this.pdfCurrentPage + 1);
                        }
                    } else if (event.deltaY < 0) {
                        // Scroll up - previous page
                        if (this.pdfCurrentPage > 1) {
                            this.renderPdfPage(this.pdfCurrentPage - 1);
                        }
                    }
                }, 150); // 150ms debounce

                event.preventDefault();
            },

            updatePdfButtons() {
                const zoomOut = document.getElementById('pdf-zoom-out');
                const zoomIn = document.getElementById('pdf-zoom-in');
                const prev = document.getElementById('pdf-prev-page');
                const next = document.getElementById('pdf-next-page');
                const hasDocument = !!this.pdfDoc;
                if (zoomOut) zoomOut.disabled = !hasDocument || this.pdfZoom <= 0.5 || this.pdfLoading;
                if (zoomIn) zoomIn.disabled = !hasDocument || this.pdfZoom >= 3 || this.pdfLoading;
                if (prev) prev.disabled = !hasDocument || this.pdfCurrentPage <= 1 || this.pdfLoading;
                if (next) next.disabled = !hasDocument || this.pdfCurrentPage >= this.pdfTotalPages || this.pdfLoading;
            },

            toggleTheme() {
                const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.body.className = `${newTheme}-mode`;
                document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '🌙' : '☀️';
                localStorage.setItem('theme', newTheme);
                this.showToast('success', 'Tema spremenjena', `Aktivirana ${newTheme === 'dark' ? 'temna' : 'svetla'} tema`);
            },

            goToStep(step) {
                if (step === 3) return;
                const stepEl = document.getElementById(`step-${step}`);
                if (stepEl.classList.contains('disabled')) return;
                this.currentStep = step;
                this.updateUI();
            },

            previousStep() { 
                if (this.currentStep > 1) { 
                    this.currentStep--; 
                    this.updateUI(); 
                } 
            },
            
            nextStep() {
                if (this.currentStep < 4) {
                    this.currentStep++;
                    this.updateStepAccess();
                    this.updateUI();
                }
            },

            updateStepAccess() {
                const step2 = document.getElementById('step-2');
                if (this.sessionId) {
                    step2.classList.remove('disabled');
                } else {
                    step2.classList.add('disabled');
                }
                
                const step4 = document.getElementById('step-4');
                if (this.results.length > 0) {
                    step4.classList.remove('disabled');
                } else {
                    step4.classList.add('disabled');
                }
            },

            updateUI() {
                for (let i = 1; i <= 4; i++) {
                    document.getElementById(`content-step-${i}`).classList.add('hidden');
                    const stepEl = document.getElementById(`step-${i}`);
                    stepEl.classList.remove('active', 'completed');
                    if (i < this.currentStep) stepEl.classList.add('completed');
                    if (i === this.currentStep) stepEl.classList.add('active');
                }
                document.getElementById(`content-step-${this.currentStep}`).classList.remove('hidden');
                this.updateSaveButtonState();
            },

            handleFileSelect(event) { this.addFiles(Array.from(event.target.files)); },

            addFiles(newFiles) {
                const validFiles = newFiles.filter(file => {
                    const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                      'application/vnd.ms-excel', 'image/png', 'image/jpeg', 'image/jpg'];
                    const maxSize = 50 * 1024 * 1024;
                    if (!validTypes.includes(file.type)) { this.showToast('error', 'Napaka', `${file.name} ni podprt format`); return false; }
                    if (file.size > maxSize) { this.showToast('error', 'Napaka', `${file.name} je prevelik (max 50MB)`); return false; }
                    return true;
                });
                this.files.push(...validFiles);
                validFiles.forEach(file => { this.filesMeta[file.name] = { name: file.name, pages: '' }; });
                this.renderFileList();
                this.updatePdfPreviewButton();
                if (validFiles.length > 0) {
                    this.showToast('success', 'Datoteke dodane', `Dodanih ${validFiles.length} datotek`);
                    document.getElementById('extract-btn').disabled = false;
                }
            },

            removeFile(index) {
                const fileName = this.files[index].name;
                delete this.filesMeta[fileName];
                this.files.splice(index, 1);
                this.renderFileList();
                this.updatePdfPreviewButton();
                this.showToast('info', 'Datoteka odstranjena', fileName);
                if (this.files.length === 0) document.getElementById('extract-btn').disabled = true;
            },

            updatePdfPreviewButton() {
                const pdfDropdown = document.getElementById('pdf-dropdown');
                const pdfPreviewBtn = document.getElementById('pdf-preview-btn');
                const pdfDropdownArrow = document.getElementById('pdf-dropdown-arrow');
                const pdfFiles = this.files.filter(file => file.type === 'application/pdf');

                if (pdfDropdown) {
                    if (pdfFiles.length > 0) {
                        pdfDropdown.style.display = 'inline-block';

                        // Update button text based on number of PDFs
                        if (pdfFiles.length === 1) {
                            if (pdfPreviewBtn) {
                                pdfPreviewBtn.innerHTML = '👁️ Predogled';
                                pdfPreviewBtn.title = 'Odpri PDF predogled';
                            }
                        } else {
                            if (pdfPreviewBtn && pdfDropdownArrow) {
                                pdfPreviewBtn.innerHTML = `👁️ Predogled (${pdfFiles.length}) <span id="pdf-dropdown-arrow">▼</span>`;
                                pdfPreviewBtn.title = 'Izberi PDF za predogled';
                            }
                        }

                        this.renderPdfDropdown();
                    } else {
                        pdfDropdown.style.display = 'none';
                    }
                }
            },

            togglePdfDropdown() {
                const pdfFiles = this.files
                    .map((file, index) => ({ file, index }))
                    .filter(item => item.file.type === 'application/pdf');

                // If only one PDF, open it directly
                if (pdfFiles.length === 1) {
                    this.openPdfViewer(pdfFiles[0].index);
                    return;
                }

                // If multiple PDFs, show dropdown
                const dropdown = document.getElementById('pdf-dropdown');
                const isOpen = dropdown.classList.contains('open');

                if (isOpen) {
                    this.closePdfDropdown();
                } else {
                    dropdown.classList.add('open');
                    // Zapri dropdown če klikneš kjerkoli drugje
                    setTimeout(() => {
                        document.addEventListener('click', this.handleOutsideClick.bind(this), { once: true });
                    }, 100);
                }
            },

            closePdfDropdown() {
                const dropdown = document.getElementById('pdf-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('open');
                }
            },

            handleOutsideClick(event) {
                const dropdown = document.getElementById('pdf-dropdown');
                if (dropdown && !dropdown.contains(event.target)) {
                    this.closePdfDropdown();
                }
            },

            renderPdfDropdown() {
                const content = document.getElementById('pdf-dropdown-content');
                if (!content) return;

                const pdfFiles = this.files
                    .map((file, index) => ({ file, index }))
                    .filter(item => item.file.type === 'application/pdf');

                if (pdfFiles.length === 0) {
                    content.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">Ni PDF dokumentov</div>';
                    return;
                }

                content.innerHTML = pdfFiles.map(({ file, index }) => `
                    <div class="pdf-dropdown-item" onclick="app.selectPdfFromDropdown(${index}); event.stopPropagation();">
                        <div class="pdf-dropdown-item-icon">📄</div>
                        <div class="pdf-dropdown-item-text">
                            <div class="pdf-dropdown-item-name" title="${file.name}">${file.name.length > 35 ? file.name.substring(0, 35) + '...' : file.name}</div>
                            <div class="pdf-dropdown-item-size">${this.formatFileSize(file.size)}</div>
                        </div>
                    </div>
                `).join('');
            },

            selectPdfFromDropdown(index) {
                this.closePdfDropdown();
                this.openPdfViewer(index);
            },

            updatePages(fileName, pages) { if (this.filesMeta[fileName]) this.filesMeta[fileName].pages = pages; },

            renderFileList() {
                const container = document.getElementById('file-list');
                if (this.files.length === 0) { container.innerHTML = ''; return; }
                container.innerHTML = this.files.map((file, index) => `
                    <div class="file-item">
                        <div class="file-info">
                            <span style="font-size: 1.5rem;">📄</span>
                            <div class="file-meta">
                                <div style="font-weight: 600;">${file.name}</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">${this.formatFileSize(file.size)}</div>
                                ${file.type === 'application/pdf' ? `<input type="text" placeholder="Strani (npr. 1-3, 5)" style="margin-top: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); font-size: 0.85rem;" onchange="app.updatePages('${file.name}', this.value)">` : ''}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="remove-file" onclick="app.removeFile(${index})">✕</button>
                        </div>
                    </div>
                `).join('');
            },

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
            },

            // PDF Viewer Methods
            async openPdfViewer(fileIndex) {
                const file = this.files[fileIndex];
                if (!file || file.type !== 'application/pdf') return;

                this.currentPdfFile = file;
                this.pdfCurrentPage = 1;
                this.pdfZoom = 1.5;
                this.pdfLoading = true;
                this.updatePdfButtons();

                const viewerModal = document.getElementById('pdf-viewer-modal');
                this.setPdfPopoutEnabled(false);
                if (this.pdfCloseTimeout) {
                    clearTimeout(this.pdfCloseTimeout);
                    this.pdfCloseTimeout = null;
                }
                document.documentElement.style.setProperty('--pdf-panel-width', `${this.pdfWidth}vw`);
                if (viewerModal) {
                    viewerModal.classList.remove('hidden');
                    requestAnimationFrame(() => viewerModal.classList.add('open'));
                }
                document.body.classList.add('pdf-viewer-active');
                document.getElementById('pdf-viewer-title').textContent = file.name;
                document.getElementById('pdf-loading').style.display = 'block';
                document.getElementById('pdf-canvas-container').style.display = 'none';

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    this.pdfDoc = pdf;
                    this.pdfTotalPages = pdf.numPages;
                    
                    document.getElementById('pdf-page-nav').style.display = this.pdfTotalPages > 1 ? 'flex' : 'none';

                    await this.renderPdfPage(1);
                    this.pdfLoading = false;
                    document.getElementById('pdf-loading').style.display = 'none';
                    document.getElementById('pdf-canvas-container').style.display = 'block';
                    this.setPdfPopoutEnabled(true);
                } catch (error) {
                    console.error('Napaka pri nalaganju PDF:', error);
                    this.showToast('error', 'Napaka', 'Ni mogoče naložiti PDF dokumenta');
                    this.closePdfViewer();
                }
            },

            async renderPdfPage(pageNum) {
                if (!this.pdfDoc || pageNum < 1 || pageNum > this.pdfTotalPages) return;

                this.pdfLoading = true;
                this.updatePdfButtons();

                try {
                    const page = await this.pdfDoc.getPage(pageNum);
                    const canvas = document.getElementById('pdfCanvas');
                    const context = canvas.getContext('2d');
                    
                    const viewport = page.getViewport({ scale: this.pdfZoom });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    this.pdfCurrentPage = pageNum;
                    document.getElementById('pdf-page-info').textContent = `Stran ${this.pdfCurrentPage} / ${this.pdfTotalPages}`;
                    document.getElementById('pdf-zoom-value').textContent = `${Math.round(this.pdfZoom * 100)}%`;

                    this.pdfLoading = false;
                    this.updatePdfButtons();
                } catch (error) {
                    console.error('Napaka pri prikazu strani:', error);
                    this.showToast('error', 'Napaka', 'Ni mogoče prikazati strani');
                    this.pdfLoading = false;
                    this.updatePdfButtons();
                }
            },

            closePdfViewer() {
                const viewerModal = document.getElementById('pdf-viewer-modal');
                if (viewerModal) {
                    viewerModal.classList.remove('open');
                    viewerModal.classList.remove('resizing');
                    this.pdfCloseTimeout = setTimeout(() => {
                        viewerModal.classList.add('hidden');
                        this.pdfCloseTimeout = null;
                    }, 350);
                }
                document.body.classList.remove('pdf-viewer-active');
                this.setPdfPopoutEnabled(false);
                this.isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                if (this.pdfScrollTimeout) {
                    clearTimeout(this.pdfScrollTimeout);
                    this.pdfScrollTimeout = null;
                }
                const pageNav = document.getElementById('pdf-page-nav');
                if (pageNav) {
                    pageNav.style.display = 'none';
                }
                this.pdfDoc = null;
                this.pdfCurrentPage = 1;
                this.pdfTotalPages = 0;
                this.pdfZoom = 1.5;
                this.currentPdfFile = null;
                this.pdfLoading = false;
                this.updatePdfButtons();
            },

            popOutPdfViewer() {
                if (!this.currentPdfFile) {
                    this.showToast('info', 'Ni dokumenta', 'Najprej odprite PDF predogled');
                    return;
                }

                const fileUrl = URL.createObjectURL(this.currentPdfFile);
                const popout = window.open(
                    fileUrl,
                    '_blank',
                    'width=1200,height=900,menubar=yes,toolbar=yes,location=yes,status=yes,resizable=yes,scrollbars=yes'
                );

                if (!popout || popout.closed || typeof popout.closed === 'undefined') {
                    this.showPopupBlockedModal(fileUrl);
                    setTimeout(() => URL.revokeObjectURL(fileUrl), 60000);
                    return;
                }

                this.closePdfViewer();
                this.showToast('success', 'Odprto', 'PDF je odprt v novem oknu');
                setTimeout(() => URL.revokeObjectURL(fileUrl), 60000);
            },

            pdfPrevPage() {
                if (this.pdfCurrentPage > 1 && !this.pdfLoading) {
                    this.renderPdfPage(this.pdfCurrentPage - 1);
                }
            },

            pdfNextPage() {
                if (this.pdfCurrentPage < this.pdfTotalPages && !this.pdfLoading) {
                    this.renderPdfPage(this.pdfCurrentPage + 1);
                }
            },

            pdfZoomIn() {
                if (this.pdfZoom < 3 && !this.pdfLoading) {
                    this.pdfZoom += 0.25;
                    this.renderPdfPage(this.pdfCurrentPage);
                }
            },

            pdfZoomOut() {
                if (this.pdfZoom > 0.5 && !this.pdfLoading) {
                    this.pdfZoom -= 0.25;
                    this.renderPdfPage(this.pdfCurrentPage);
                }
            },

            togglePanMode() {
                this.panMode = !this.panMode;
                const pdfBody = document.getElementById('pdf-viewer-body');
                const panBtn = document.getElementById('pdf-pan-btn');

                if (this.panMode) {
                    pdfBody.classList.add('pan-mode');
                    if (panBtn) panBtn.style.background = 'var(--primary)';
                    this.initPanListeners();
                } else {
                    pdfBody.classList.remove('pan-mode', 'dragging');
                    if (panBtn) panBtn.style.background = '';
                    this.removePanListeners();
                }
            },

            initPanListeners() {
                const pdfBody = document.getElementById('pdf-viewer-body');
                if (!pdfBody) return;

                pdfBody.addEventListener('mousedown', this.handlePanStart.bind(this));
                pdfBody.addEventListener('mousemove', this.handlePanMove.bind(this));
                pdfBody.addEventListener('mouseup', this.handlePanEnd.bind(this));
                pdfBody.addEventListener('mouseleave', this.handlePanEnd.bind(this));
            },

            removePanListeners() {
                const pdfBody = document.getElementById('pdf-viewer-body');
                if (!pdfBody) return;

                pdfBody.removeEventListener('mousedown', this.handlePanStart.bind(this));
                pdfBody.removeEventListener('mousemove', this.handlePanMove.bind(this));
                pdfBody.removeEventListener('mouseup', this.handlePanEnd.bind(this));
                pdfBody.removeEventListener('mouseleave', this.handlePanEnd.bind(this));
            },

            handlePanStart(e) {
                if (!this.panMode) return;
                const pdfBody = document.getElementById('pdf-viewer-body');

                this.isDragging = true;
                this.dragStartX = e.clientX;
                this.dragStartY = e.clientY;
                this.scrollStartX = pdfBody.scrollLeft;
                this.scrollStartY = pdfBody.scrollTop;

                pdfBody.classList.add('dragging');
                e.preventDefault();
            },

            handlePanMove(e) {
                if (!this.isDragging || !this.panMode) return;
                const pdfBody = document.getElementById('pdf-viewer-body');

                const dx = e.clientX - this.dragStartX;
                const dy = e.clientY - this.dragStartY;

                pdfBody.scrollLeft = this.scrollStartX - dx;
                pdfBody.scrollTop = this.scrollStartY - dy;

                e.preventDefault();
            },

            handlePanEnd(e) {
                if (!this.panMode) return;
                const pdfBody = document.getElementById('pdf-viewer-body');

                this.isDragging = false;
                pdfBody.classList.remove('dragging');
            },

            printPdf() {
                if (!this.currentPdfFile) {
                    this.showToast('error', 'Ni dokumenta', 'Najprej odprite PDF predogled');
                    return;
                }

                const fileUrl = URL.createObjectURL(this.currentPdfFile);
                const printWindow = window.open(fileUrl, '_blank');

                if (printWindow) {
                    printWindow.addEventListener('load', () => {
                        printWindow.print();
                        setTimeout(() => URL.revokeObjectURL(fileUrl), 1000);
                    });
                    this.showToast('success', 'Printanje', 'PDF je pripravljen za tiskanje');
                } else {
                    this.showToast('error', 'Napaka', 'Ni mogoče odpreti tiskalnika');
                    URL.revokeObjectURL(fileUrl);
                }
            },

            async extractData() {
                if (this.files.length === 0) return;

                document.getElementById('extract-btn').disabled = true;
                this.showLoading('Inicializacija ekstrakcije...');

                try {
                    const formData = new FormData();
                    this.files.forEach(file => formData.append('pdf_files', file));
                    formData.append('municipality_slug', 'litija');
                    formData.append('files_meta_json', JSON.stringify(Object.values(this.filesMeta)));

                    // Klic API-ja za začetek procesiranja
                    console.log('[Upload] Pošiljam zahtevo za ekstrakcijo podatkov');
                    const response = await fetch('/extract-data', { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('API napaka');

                    const initData = await response.json();
                    this.sessionId = initData.session_id;
                    console.log('[Upload] Prejet session ID:', this.sessionId);

                    // Start progress polling with actual session ID
                    this.startProgressPolling(this.sessionId, 'extract');
                    this.hideLoading();

                    // Polling za rezultate
                    const resultData = await this.pollForExtractResult(this.sessionId);

                    if (resultData.status === 'error') {
                        throw new Error(resultData.message || 'Napaka pri procesiranju');
                    }

                    const data = resultData.data;
                    this.eupRabaPairs = (data.eup || []).map((eup, i) => ({ eup, raba: (data.namenska_raba || [])[i] || '' }));
                    if (this.eupRabaPairs.length === 0) this.eupRabaPairs = [{ eup: '', raba: '' }];

                    this.keyData = {};
                    Object.keys(KEY_DATA_LABELS).forEach(key => {
                        this.keyData[key] = data[key] || 'Ni podatka v dokumentaciji';
                    });

                    this.renderEupRabaPairs();
                    this.renderKeyData();

                    this.showToast('success', 'Podatki ekstrahirani', 'AI je uspešno ekstrahiral ključne podatke');
                    this.updateStepAccess();
                    this.nextStep();
                    document.getElementById('extract-btn').disabled = false;
                } catch (error) {
                    console.error('[Upload] Napaka:', error);
                    this.hideLoading();
                    this.stopProgressPolling();
                    this.showToast('error', 'Napaka', error.message);
                    if (this.files.length > 0) {
                        document.getElementById('extract-btn').disabled = false;
                    }
                }
            },

            renderEupRabaPairs() {
                const container = document.getElementById('eup-raba-container');
                container.innerHTML = this.eupRabaPairs.map((pair, index) => `
                    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">EUP ${index + 1} *</label>
                            <input type="text" class="form-input" id="eup-input-${index}" value="${pair.eup}" onchange="app.eupRabaPairs[${index}].eup = this.value; app.clearValidationError();" placeholder="npr. LI-08">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Namenska raba ${index + 1} *</label>
                            <input type="text" class="form-input" id="raba-input-${index}" value="${pair.raba}" onchange="app.eupRabaPairs[${index}].raba = this.value; app.clearValidationError();" placeholder="npr. SSe">
                        </div>
                        ${this.eupRabaPairs.length > 1 ? `<button class="btn btn-secondary" onclick="app.removeEupRabaPair(${index})">✕</button>` : '<div></div>'}
                    </div>
                `).join('') + '<button class="btn btn-secondary" style="margin-bottom: 1.5rem;" onclick="app.addEupRabaPair()">+ Dodaj EUP/Rabo</button>';
            },

            validateEupRaba() {
                let isValid = true;
                const validationError = document.getElementById('validation-error');
                
                this.eupRabaPairs.forEach((pair, index) => {
                    const eupInput = document.getElementById(`eup-input-${index}`);
                    const rabaInput = document.getElementById(`raba-input-${index}`);
                    
                    if (!pair.eup || !pair.eup.trim()) {
                        if (eupInput) eupInput.classList.add('error');
                        isValid = false;
                    } else {
                        if (eupInput) eupInput.classList.remove('error');
                    }
                    
                    if (!pair.raba || !pair.raba.trim()) {
                        if (rabaInput) rabaInput.classList.add('error');
                        isValid = false;
                    } else {
                        if (rabaInput) rabaInput.classList.remove('error');
                    }
                });
                
                if (!isValid) {
                    validationError.style.display = 'flex';
                    validationError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    validationError.style.display = 'none';
                }
                
                return isValid;
            },

            clearValidationError() {
                document.getElementById('validation-error').style.display = 'none';
                this.eupRabaPairs.forEach((pair, index) => {
                    const eupInput = document.getElementById(`eup-input-${index}`);
                    const rabaInput = document.getElementById(`raba-input-${index}`);
                    if (eupInput) eupInput.classList.remove('error');
                    if (rabaInput) rabaInput.classList.remove('error');
                });
            },

            renderKeyData() {
                const container = document.getElementById('key-data-grid');
                container.innerHTML = Object.keys(KEY_DATA_LABELS).map((key, index) => `
                    <div class="key-data-item">
                        <label class="form-label">${KEY_DATA_LABELS[key]}</label>
                        <textarea class="form-input editable-text" id="keydata-textarea-${index}" oninput="app.autoResizeTextarea(this)" onchange="app.updateKeyData('${key}', ${index}, this.value)">${this.keyData[key]}</textarea>
                    </div>
                `).join('');

                setTimeout(() => {
                    Object.keys(KEY_DATA_LABELS).forEach((key, index) => {
                        const textarea = document.getElementById(`keydata-textarea-${index}`);
                        if (textarea) {
                            this.autoResizeTextarea(textarea);
                            // Shrani originalno vrednost
                            this.originalTextareaValues.set(`keydata-textarea-${index}`, this.keyData[key]);
                        }
                    });
                }, 10);
            },

            updateKeyData(key, index, newValue) {
                this.keyData[key] = newValue;

                // Dodaj "modified" klas če se je vsebina spremenila
                const textarea = document.getElementById(`keydata-textarea-${index}`);
                if (textarea) {
                    const originalValue = this.originalTextareaValues.get(`keydata-textarea-${index}`) || '';
                    if (newValue !== originalValue) {
                        textarea.classList.add('modified');
                    } else {
                        textarea.classList.remove('modified');
                    }
                }
            },

            addEupRabaPair() { this.eupRabaPairs.push({ eup: '', raba: '' }); this.renderEupRabaPairs(); },
            removeEupRabaPair(index) { this.eupRabaPairs.splice(index, 1); this.renderEupRabaPairs(); },

            async confirmAndAnalyze() {
                if (!this.validateEupRaba()) {
                    this.showToast('error', 'Manjkajoči podatki', 'Prosimo izpolnite EUP in Namensko rabo');
                    return;
                }

                this.currentStep = 3;
                this.updateUI();

                this.resetAnalysisStatus('Pripravljam AI analizo', 'Pošiljam podatke na strežnik...');
                this.setAnalysisStatus('Pripravljam AI analizo', 'Pošiljam podatke na strežnik...', 5);
                this.appendAnalysisLog('Pošiljam podatke na strežnik...');
                this.lastProgressMessage = 'Pošiljam podatke na strežnik...';
                this.showProgress('AI analiza', 'Pošiljam podatke na strežnik...', 5);

                try {
                    const payload = {
                        session_id: this.sessionId,
                        final_eup_list: this.eupRabaPairs.map(p => p.eup).filter(e => e.trim()),
                        final_raba_list: this.eupRabaPairs.map(p => p.raba).filter(r => r.trim()),
                        key_data: this.keyData,
                        selected_ids: [],
                        existing_results_map: {}
                    };

                    console.log('[Analyze] Pošiljam zahtevo za analizo');
                    const response = await fetch('/analyze-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error('Napaka pri analizi');
                    const initData = await response.json();
                    console.log('[Analyze] Analiza se začne, session ID:', initData.session_id);

                    this.appendAnalysisLog('Analiza je bila uspešno zagnana.');
                    this.lastProgressMessage = 'Analiza je bila uspešno zagnana.';
                    this.setAnalysisStatus('Analiza v teku', 'Analiza je zagnana. Čakam na posodobitve strežnika...', 10);
                    this.updateProgress('AI analiza', 'Analiza je zagnana. Čakam na posodobitve strežnika...', 10);

                    // Start progress polling
                    this.startProgressPolling(this.sessionId, 'analysis');

                    // Polling za rezultate analize
                    const resultData = await this.pollForAnalyzeResult(this.sessionId);

                    if (resultData.status === 'error') {
                        throw new Error(resultData.message || 'Napaka pri analizi');
                    }

                    const data = resultData.data;
                    const resultsMap = data.results_map || {};
                    this.results = (data.zahteve || []).map(req => {
                        const result = resultsMap[req.id] || {};
                        const skladnost = (result.skladnost || '').toLowerCase();

                        return {
                            id: req.id,
                            requirement: req.naslov || 'Neznana zahteva',
                            compliant: skladnost.includes('skladno') && !skladnost.includes('neskladno'),
                            notRelevant: skladnost.includes('ni relevantno'),
                            explanation: result.obrazlozitev || 'Ni obrazložitve',
                            evidence: result.evidence || '',
                            skladnost: result.skladnost || 'Neskladno'
                        };
                    });

                    this.stopProgressPolling();
                    this.updateStepAccess();

                    this.setAnalysisStatus('Analiza zaključena', 'Rezultati so pripravljeni za pregled.', 100);
                    this.setAnalysisSpinnerState('completed');
                    this.appendAnalysisLog('Analiza zaključena. Rezultati so pripravljeni.');
                    this.lastProgressMessage = 'Analiza zaključena. Rezultati so pripravljeni.';
                    this.updateProgress('AI analiza', 'Analiza zaključena. Rezultati so pripravljeni.', 100);

                    const compliantCount = this.results.filter(r => r.compliant).length;
                    const nonCompliantCount = this.results.filter(r => !r.compliant && !r.notRelevant).length;
                    const notRelevantCount = this.results.filter(r => r.notRelevant).length;
                    this.showToast('success', 'Analiza končana',
                        `${compliantCount} skladnih, ${nonCompliantCount} neskladnih, ${notRelevantCount} ni relevantno`);
                    this.nextStep();

                    // Render results AFTER moving to step 4
                    setTimeout(() => {
                        this.renderResults();
                    }, 0);
                } catch (error) {
                    console.error('[Analyze] Napaka:', error);
                    this.stopProgressPolling();
                    this.hideLoading();
                    this.setAnalysisStatus('Analiza neuspešna', error.message || 'Napaka pri analizi.', this.currentProgress?.percentage ?? 0);
                    this.setAnalysisSpinnerState('error');
                    this.appendAnalysisLog(`Napaka: ${error.message || 'Neznana napaka'}`);
                    this.lastProgressMessage = error.message || 'Napaka';
                    this.hideProgressBar();
                    this.showToast('error', 'Napaka pri analizi', error.message);
                    this.currentStep = 2;
                    this.updateUI();
                }
            },

            renderResults() {
                const compliantCount = this.results.filter(r => r.compliant).length;
                const nonCompliantCount = this.results.filter(r => !r.compliant && !r.notRelevant).length;
                const notRelevantCount = this.results.filter(r => r.notRelevant).length;
                
                document.getElementById('compliant-count').textContent = compliantCount;
                document.getElementById('non-compliant-count').textContent = nonCompliantCount;
                document.getElementById('not-relevant-count').textContent = notRelevantCount;
                
                const tbody = document.getElementById('results-tbody');
                tbody.innerHTML = this.results.map((result, index) => {
                    const isExpanded = this.expandedRows.has(index);
                    const truncatedText = result.requirement.length > 100 ? result.requirement.substring(0, 100) + '...' : result.requirement;
                    
                    return `
                    <tr>
                        <td style="font-weight: 600;">${result.id}</td>
                        <td>
                            <span class="requirement-text" onclick="app.toggleRequirement(${index})" title="Klikni za celoten tekst">
                                ${isExpanded ? result.requirement : truncatedText}
                            </span>
                        </td>
                        <td>
                            <select class="status-select" onchange="app.updateStatus(${index}, this.value)">
                                <option value="Skladno" ${result.compliant ? 'selected' : ''}>Skladno</option>
                                <option value="Neskladno" ${!result.compliant && !result.notRelevant ? 'selected' : ''}>Neskladno</option>
                                <option value="Ni relevantno" ${result.notRelevant ? 'selected' : ''}>Ni relevantno</option>
                            </select>
                        </td>
                        <td class="editable-cell">
                            <textarea class="editable-text" id="textarea-${index}" oninput="app.autoResizeTextarea(this)" onchange="app.updateExplanation(${index}, this.value)">${result.explanation}</textarea>
                        </td>
                    </tr>
                `}).join('');
                
                setTimeout(() => {
                    this.results.forEach((result, index) => {
                        const textarea = document.getElementById(`textarea-${index}`);
                        if (textarea) {
                            this.autoResizeTextarea(textarea);
                            // Shrani originalno vrednost
                            this.originalTextareaValues.set(`textarea-${index}`, result.explanation);
                        }
                    });
                }, 10);
            },

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = (textarea.scrollHeight + 4) + 'px';
            },

            toggleRequirement(index) {
                if (this.expandedRows.has(index)) {
                    this.expandedRows.delete(index);
                } else {
                    this.expandedRows.add(index);
                }
                this.renderResults();
            },

            updateStatus(index, newStatus) {
                this.results[index].skladnost = newStatus;
                this.results[index].compliant = newStatus === 'Skladno';
                this.results[index].notRelevant = newStatus === 'Ni relevantno';
                this.renderResults();
                this.markAsChanged();
                this.showToast('info', 'Status posodobljen', `Zahteva ${this.results[index].id}`);
            },

            updateExplanation(index, newExplanation) {
                this.results[index].explanation = newExplanation;
                this.markAsChanged();

                // Dodaj "modified" klas če se je vsebina spremenila
                const textarea = document.getElementById(`textarea-${index}`);
                if (textarea) {
                    const originalValue = this.originalTextareaValues.get(`textarea-${index}`) || '';
                    if (newExplanation !== originalValue) {
                        textarea.classList.add('modified');
                    } else {
                        textarea.classList.remove('modified');
                    }
                }

                this.showToast('info', 'Obrazložitev posodobljena', `Zahteva ${this.results[index].id}`);
            },

            markAsChanged() {
                this.hasUnsavedChanges = true;
                this.updateSaveButtonState();

                if (this.saveTimeout) clearTimeout(this.saveTimeout);
                this.saveTimeout = setTimeout(() => {
                    this.autoSaveProgress();
                }, 3000);
            },

            showSaveButton() {
                this.updateSaveButtonState();
            },

            hideSaveButton() {
                this.updateSaveButtonState();
            },

            updateSaveButtonState() {
                const saveBtn = document.getElementById('save-btn');
                if (!saveBtn) return;

                const shouldShow = !!this.sessionId && this.currentStep === 4;
                saveBtn.style.display = shouldShow ? 'inline-flex' : 'none';

                if (!shouldShow) {
                    return;
                }

                saveBtn.disabled = this.isSaving;
                saveBtn.textContent = this.isSaving ? '💾 Shranjevanje...' : '💾 Shrani sejo';
            },

            async saveProgress() {
                if (!this.sessionId || this.isSaving) return;

                this.isSaving = true;
                this.updateSaveButtonState();
                this.showLoading('Shranjujem sejo...');

                try {
                    const sessionData = {
                        results_map: {},
                        zahteve: this.results.map(r => ({
                            id: r.id,
                            naslov: r.requirement
                        })),
                        metadata: {},
                        key_data: this.keyData,
                        eup: this.eupRabaPairs.map(p => p.eup),
                        namenska_raba: this.eupRabaPairs.map(p => p.raba),
                        stevilka_zadeve: document.getElementById('stevilka-zadeve')?.value?.trim() || ''
                    };

                    this.results.forEach(r => {
                        sessionData.results_map[r.id] = {
                            skladnost: r.skladnost,
                            obrazlozitev: r.explanation,
                            evidence: r.evidence || ''
                        };
                    });

                    sessionData.resultsMap = sessionData.results_map;

                    const compliantCount = this.results.filter(r => r.compliant).length;
                    const nonCompliantCount = this.results.filter(r => !r.compliant && !r.notRelevant).length;
                    const notRelevantCount = this.results.filter(r => r.notRelevant).length;

                    const payload = {
                        session_id: this.sessionId,
                        data: sessionData,
                        project_name: `Analiza ${new Date().toLocaleDateString('sl-SI')}`,
                        summary: `${this.results.length} zahtev: ${compliantCount} skladnih, ${nonCompliantCount} neskladnih, ${notRelevantCount} ni relevantno`
                    };

                    const response = await fetch('/save-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error('Napaka pri shranjevanju');

                    this.hasUnsavedChanges = false;
                    this.updateSaveButtonState();
                    this.hideLoading();
                    this.showToast('success', 'Shranjeno', 'Spremembe so bile uspešno shranjene');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri shranjevanju', error.message);
                } finally {
                    this.isSaving = false;
                    this.updateSaveButtonState();
                }
            },

            async autoSaveProgress() {
                if (!this.hasUnsavedChanges || !this.sessionId) return;
                await this.saveProgress();
            },

            resetAnalysis() {
                this.currentStep = 1;
                this.files = [];
                this.filesMeta = {};
                this.results = [];
                this.sessionId = null;
                this.eupRabaPairs = [];
                this.keyData = {};
                this.expandedRows.clear();
                this.resetAnalysisStatus('Analiza ni zagnana', 'Dokončajte pripravo podatkov in zaženite postopek.');
                this.hideProgressBar();
                this.hideProgress();
                document.getElementById('file-input').value = '';
                this.renderFileList();
                this.updateStepAccess();
                this.updateUI();
                document.getElementById('extract-btn').disabled = true;
                this.showToast('info', 'Resetirano', 'Začni novo analizo');
            },

            async downloadReport() {
                if (!this.sessionId) {
                    this.showToast('error', 'Napaka', 'Seja ni aktivna');
                    return;
                }

                if (this.hasUnsavedChanges) {
                    await this.saveProgress();
                }

                this.showLoading('Pripravljam poročilo z vašimi spremembami...');

                try {
                    const updatedResults = {};
                    this.results.forEach(result => {
                        updatedResults[String(result.id)] = {
                            skladnost: result.skladnost,
                            obrazlozitev: result.explanation || '',
                            evidence: result.evidence || ''
                        };
                    });

                    // Preberi izbiro formata poročila
                    const isSummary = document.getElementById('report-format-summary')?.checked || false;
                    const reportFormat = isSummary ? 'summary' : 'full';

                    // Preberi številko zadeve
                    const stevilkaZadeve = document.getElementById('stevilka-zadeve')?.value?.trim() || null;

                    const payload = {
                        session_id: this.sessionId,
                        excluded_ids: [],
                        updated_results_map: updatedResults,
                        updated_key_data: this.keyData,
                        report_format: reportFormat,
                        stevilka_zadeve: stevilkaZadeve
                    };
                    
                    const response = await fetch('/confirm-report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Napaka pri generiranju poročila');
                    const data = await response.json();
                    
                    if (data.docx_path) {
                        const docxResponse = await fetch(`/${data.docx_path}`);
                        const blob = await docxResponse.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.docx_path.split('/').pop();
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }
                    
                    if (data.xlsx_path) {
                        setTimeout(async () => {
                            const xlsxResponse = await fetch(`/${data.xlsx_path}`);
                            const blob = await xlsxResponse.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = data.xlsx_path.split('/').pop();
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 1000);
                    }
                    
                    this.hideLoading();
                    this.showToast('success', 'Poročilo pripravljeno', 'Word dokument vključuje vse vaše spremembe');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri prenosu', error.message);
                }
            },

            async showSessionsModal() {
                document.getElementById('sessions-modal').classList.add('show');
                await this.loadSessions();
            },

            closeSessionsModal() {
                document.getElementById('sessions-modal').classList.remove('show');
            },

            showFilteredResults(filterType) {
                let filteredResults = [];
                let title = '';
                let badgeClass = '';
                let badgeText = '';
                
                if (filterType === 'compliant') {
                    filteredResults = this.results.filter(r => r.compliant);
                    title = 'Skladne Zahteve';
                    badgeClass = 'success';
                    badgeText = `${filteredResults.length} Skladnih`;
                } else if (filterType === 'non-compliant') {
                    filteredResults = this.results.filter(r => !r.compliant && !r.notRelevant);
                    title = 'Neskladne Zahteve';
                    badgeClass = 'danger';
                    badgeText = `${filteredResults.length} Neskladnih`;
                } else if (filterType === 'not-relevant') {
                    filteredResults = this.results.filter(r => r.notRelevant);
                    title = 'Zahteve - Ni Relevantno';
                    badgeClass = 'info';
                    badgeText = `${filteredResults.length} Ni Relevantno`;
                }
                
                document.getElementById('filter-modal-title').textContent = title;
                const badge = document.getElementById('filter-badge');
                badge.className = `filter-badge ${badgeClass}`;
                badge.textContent = badgeText;
                
                const filterList = document.getElementById('filter-list');
                if (filteredResults.length === 0) {
                    filterList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📋</div><p>Ni zahtev v tej kategoriji</p></div>';
                } else {
                    filterList.innerHTML = filteredResults.map(result => `
                        <div class="filter-item">
                            <div class="filter-item-header">
                                <span class="filter-item-id">${result.id}</span>
                                <span class="status-badge status-${badgeClass}">${result.skladnost}</span>
                            </div>
                            <div class="filter-item-title">${result.requirement}</div>
                            <div class="filter-item-explanation">${result.explanation}</div>
                        </div>
                    `).join('');
                }
                
                document.getElementById('filter-modal').classList.add('show');
            },

            closeFilterModal() {
                document.getElementById('filter-modal').classList.remove('show');
            },

            async loadSessions() {
                const container = document.getElementById('sessions-list-container');
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📂</div><p>Nalagam shranjene analize...</p></div>';
                
                try {
                    const response = await fetch('/saved-sessions');
                    if (!response.ok) throw new Error('Napaka pri nalaganju sej');
                    const data = await response.json();
                    
                    if (data.sessions && data.sessions.length > 0) {
                        container.innerHTML = '<div class="sessions-list">' + 
                            data.sessions.map(session => `
                                <div class="session-card">
                                    <div class="session-header">
                                        <div class="session-title">${session.project_name || 'Neimenovan projekt'}</div>
                                        <div class="session-date">${this.formatDate(session.updated_at)}</div>
                                    </div>
                                    <div class="session-summary">${session.summary || 'Brez povzetka'}</div>
                                    <div class="session-actions">
                                        <button class="btn btn-primary btn-small" onclick="app.loadSession('${session.session_id}')">📂 Odpri</button>
                                        <button class="btn btn-secondary btn-small" onclick="app.deleteSession('${session.session_id}')">🗑️ Izbriši</button>
                                    </div>
                                </div>
                            `).join('') + '</div>';
                    } else {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📂</div><p>Trenutno ni shranjenih analiz</p></div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><p>Napaka pri nalaganju: ' + error.message + '</p></div>';
                }
            },

            async loadSession(sessionId) {
                this.closeSessionsModal();
                this.showLoading('Nalagam shranjeno analizo...');
                
                try {
                    const response = await fetch(`/saved-sessions/${sessionId}`);
                    if (!response.ok) throw new Error('Seja ne obstaja');
                    const data = await response.json();
                    
                    this.sessionId = sessionId;
                    const sessionData = typeof data.data === 'string' ? JSON.parse(data.data) : data.data;

                    this.eupRabaPairs = (sessionData.eup || []).map((eup, i) => ({
                        eup,
                        raba: (sessionData.namenska_raba || [])[i] || ''
                    }));
                    if (this.eupRabaPairs.length === 0) this.eupRabaPairs = [{ eup: '', raba: '' }];

                    this.keyData = sessionData.key_data || {};

                    const resultsMap = sessionData.results_map || {};
                    this.results = (sessionData.zahteve || []).map(req => {
                        const result = resultsMap[req.id] || {};
                        const skladnost = (result.skladnost || '').toLowerCase();

                        return {
                            id: req.id,
                            requirement: req.naslov || 'Neznana zahteva',
                            compliant: skladnost.includes('skladno') && !skladnost.includes('neskladno'),
                            notRelevant: skladnost.includes('ni relevantno'),
                            explanation: result.obrazlozitev || 'Ni obrazložitve',
                            evidence: result.evidence || '',
                            skladnost: result.skladnost || 'Neskladno'
                        };
                    });

                    console.log('[LoadSession] Loaded', this.results.length, 'results');
                    console.log('[LoadSession] Results map:', resultsMap);
                    console.log('[LoadSession] Zahteve:', sessionData.zahteve);

                    this.renderEupRabaPairs();
                    this.renderKeyData();
                    this.updateStepAccess();

                    this.currentStep = 4;
                    this.updateUI();

                    // Render results AFTER UI is updated and step 4 is visible
                    setTimeout(() => {
                        this.renderResults();
                        console.log('[LoadSession] Results rendered');
                    }, 0);

                    const caseInput = document.getElementById('stevilka-zadeve');
                    if (caseInput) {
                        caseInput.value = sessionData.stevilka_zadeve || '';
                    }

                    this.hasUnsavedChanges = false;
                    this.updateSaveButtonState();

                    this.hideLoading();
                    this.showToast('success', 'Analiza naložena', 'Lahko nadaljujete z urejanjem');
                } catch (error) {
                    this.hideLoading();
                    this.showToast('error', 'Napaka pri nalaganju', error.message);
                }
            },

            async deleteSession(sessionId) {
                if (!confirm('Ali ste prepričani, da želite izbrisati to analizo?')) return;
                
                try {
                    const response = await fetch(`/saved-sessions/${sessionId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Napaka pri brisanju');
                    
                    this.showToast('success', 'Izbrisano', 'Analiza je bila izbrisana');
                    await this.loadSessions();
                } catch (error) {
                    this.showToast('error', 'Napaka pri brisanju', error.message);
                }
            },

            formatDate(dateString) {
                if (!dateString) return 'Neznano';
                const date = new Date(dateString);
                return date.toLocaleDateString('sl-SI', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            resetAnalysisStatus(title = 'Analiza v teku', message = 'Pripravljam sistem za analizo...') {
                this.analysisStatusLog = [];
                this.lastProgressMessage = null;

                const logEl = document.getElementById('analysis-status-log');
                const emptyEl = document.getElementById('analysis-status-empty');

                if (logEl) {
                    logEl.innerHTML = '';
                    logEl.style.display = 'none';
                }
                if (emptyEl) {
                    emptyEl.style.display = 'block';
                }

                this.setAnalysisSpinnerState('active');
                this.setAnalysisStatus(title, message, 0);
            },

            setAnalysisStatus(title, message, percentage = null) {
                const titleEl = document.getElementById('analysis-status-title');
                const messageEl = document.getElementById('analysis-status-message');
                const fillEl = document.getElementById('analysis-progress-fill');
                const percentageEl = document.getElementById('analysis-progress-percentage');

                if (titleEl && title) titleEl.textContent = title;
                if (messageEl && message) messageEl.textContent = message;

                if (typeof percentage === 'number' && !Number.isNaN(percentage)) {
                    const clamped = Math.max(0, Math.min(100, Math.round(percentage)));
                    if (fillEl) fillEl.style.width = `${clamped}%`;
                    if (percentageEl) percentageEl.textContent = `${clamped}%`;
                }
            },

            setAnalysisSpinnerState(state = 'active') {
                const spinner = document.getElementById('analysis-status-spinner');
                if (!spinner) return;

                spinner.classList.remove('completed', 'error');
                if (state === 'completed') {
                    spinner.classList.add('completed');
                } else if (state === 'error') {
                    spinner.classList.add('error');
                }
            },

            appendAnalysisLog(message) {
                if (!message) return;

                const timestamp = new Date().toLocaleTimeString('sl-SI', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                this.analysisStatusLog.unshift({ message, timestamp });
                if (this.analysisStatusLog.length > 8) {
                    this.analysisStatusLog.pop();
                }

                this.refreshAnalysisLogUI();
            },

            refreshAnalysisLogUI() {
                const listEl = document.getElementById('analysis-status-log');
                const emptyEl = document.getElementById('analysis-status-empty');
                if (!listEl) return;

                listEl.innerHTML = '';

                if (this.analysisStatusLog.length === 0) {
                    listEl.style.display = 'none';
                    if (emptyEl) emptyEl.style.display = 'block';
                    return;
                }

                listEl.style.display = 'flex';
                if (emptyEl) emptyEl.style.display = 'none';

                this.analysisStatusLog.forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'analysis-status-log-item';

                    const messageSpan = document.createElement('span');
                    messageSpan.className = 'analysis-status-log-message';
                    messageSpan.textContent = entry.message;

                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'analysis-status-log-time';
                    timeSpan.textContent = entry.timestamp;

                    li.appendChild(messageSpan);
                    li.appendChild(timeSpan);
                    listEl.appendChild(li);
                });
            },

            handleAnalysisProgress(progressData) {
                const { step, total_steps, message, percentage, completed } = progressData;
                const title = step && total_steps ? `Korak ${step}/${total_steps}` : 'Analiza v teku';
                const resolvedPercentage = typeof percentage === 'number'
                    ? percentage
                    : (completed ? 100 : (this.currentProgress?.percentage ?? 0));

                this.setAnalysisStatus(title, message || 'Procesiranje v teku...', resolvedPercentage);

                if (message && message !== this.lastProgressMessage) {
                    this.appendAnalysisLog(message);
                    this.lastProgressMessage = message;
                }

                if (completed || resolvedPercentage >= 100) {
                    this.setAnalysisSpinnerState('completed');
                }
            },

            showProgress(title, message, percentage) {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar) return;
                const safePercentage = Math.max(0, Math.min(percentage, 100));
                document.getElementById('progress-title').textContent = title;
                document.getElementById('progress-message').textContent = message;
                document.getElementById('progress-fill').style.width = `${safePercentage}%`;
                document.getElementById('progress-percentage').textContent = `${safePercentage}%`;
                progressBar.classList.add('active');
            },

            updateProgress(title, message, percentage) {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar || !progressBar.classList.contains('active')) {
                    this.showProgress(title, message, percentage);
                    return;
                }
                const safePercentage = Math.max(0, Math.min(percentage, 100));
                document.getElementById('progress-title').textContent = title;
                document.getElementById('progress-message').textContent = message;
                document.getElementById('progress-fill').style.width = `${safePercentage}%`;
                document.getElementById('progress-percentage').textContent = `${safePercentage}%`;
            },

            hideProgress() {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar) return;
                progressBar.classList.remove('active');
            },

            showPopupBlockedModal(fileUrl) {
                const modalHtml = `
                    <div class="modal-overlay show" id="popup-blocked-modal" style="z-index: 10000; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; opacity: 1; pointer-events: all;">
                        <div style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="font-size: 1.5rem; font-weight: 700; color: var(--text);">🚫 Blokirano pojavno okno</h2>
                                <button onclick="app.closePopupBlockedModal()" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">✕</button>
                            </div>
                            <div style="padding: 1rem 0;">
                                <p style="margin-bottom: 1rem; color: var(--text);">Vaš brskalnik je blokiral odpiranje PDF-ja v novem oknu.</p>
                                <p style="margin-bottom: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">Kliknite na spodnji gumb za odpiranje:</p>
                                <a href="${fileUrl}" target="_blank" class="btn btn-primary" style="display: block; text-align: center; text-decoration: none; margin-bottom: 1rem;" onclick="app.closePopupBlockedModal()">📄 Odpri PDF v novem oknu</a>
                                <div style="background: var(--bg-glass); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-top: 1rem;">
                                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;"><strong>💡 Nasvet:</strong></p>
                                    <p style="font-size: 0.85rem; color: var(--text-muted); margin: 0;">Če želite omogočiti samodejno odpiranje, dovolite pojavna okna za to stran v nastavitvah brskalnika.</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                const temp = document.createElement('div');
                temp.innerHTML = modalHtml.trim();
                document.body.appendChild(temp.firstChild);
            },

            closePopupBlockedModal() {
                const modal = document.getElementById('popup-blocked-modal');
                if (modal) {
                    modal.remove();
                }
            },

            // Progress tracking methods
            startProgressPolling(sessionId, context = 'analysis') {
                this.stopProgressPolling(); // Stop any existing polling
                this.progressContext = context;

                this.showProgressBar();
                console.log(`[Progress] Started polling for session: ${sessionId} (context: ${context})`);

                this.progressInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/progress/${sessionId}`);
                        if (!response.ok) {
                            console.warn('[Progress] Failed to fetch progress, status:', response.status);
                            return;
                        }

                        const progressData = await response.json();
                        console.log('[Progress] Received data:', progressData);
                        this.currentProgress = progressData;
                        this.updateProgressBar(progressData);

                        // Stop polling when completed
                        if (progressData.completed) {
                            console.log('[Progress] Completed, stopping polling');
                            this.stopProgressPolling();
                        }
                    } catch (error) {
                        console.error('[Progress] Polling error:', error);
                    }
                }, 800); // Poll every 800ms
            },

            stopProgressPolling() {
                if (this.progressInterval) {
                    clearInterval(this.progressInterval);
                    this.progressInterval = null;
                    console.log('[Progress] Stopped polling');
                }

                this.progressContext = null;

                // Hide progress bar after a short delay to show completion
                setTimeout(() => {
                    console.log('[Progress] Hiding progress bar');
                    this.hideProgressBar();
                }, 2000);
            },

            updateProgressBar(progressData) {
                const { step, total_steps, message, percentage } = progressData;
                console.log('[Progress] Updating bar:', { step, total_steps, message, percentage });

                const titleEl = document.querySelector('.progress-bar-title');
                const messageEl = document.querySelector('.progress-bar-message');
                const fillEl = document.querySelector('.progress-bar-fill');
                const percentageEl = document.querySelector('.progress-bar-percentage');

                if (titleEl) titleEl.textContent = `Korak ${step}/${total_steps}`;
                if (messageEl) messageEl.textContent = message || 'Procesiranje...';
                if (fillEl) fillEl.style.width = `${percentage || 0}%`;
                if (percentageEl) percentageEl.textContent = `${percentage || 0}%`;

                if (this.progressContext === 'analysis') {
                    this.handleAnalysisProgress(progressData);
                }
            },

            showProgressBar() {
                const progressBar = document.querySelector('.progress-bar-container');
                if (progressBar) {
                    progressBar.classList.add('active');
                    console.log('[Progress] Progress bar shown, classes:', progressBar.className);
                } else {
                    console.error('[Progress] Progress bar container not found!');
                }
            },

            hideProgressBar() {
                const progressBar = document.querySelector('.progress-bar-container');
                if (progressBar) {
                    progressBar.classList.remove('active');
                    console.log('[Progress] Progress bar hidden');
                } else {
                    console.error('[Progress] Progress bar container not found!');
                }
            },

            async pollForExtractResult(sessionId) {
                console.log('[Polling] Začenjam polling za rezultate ekstrakcije:', sessionId);
                let attempts = 0;
                const maxAttempts = 300; // 5 minut (1s interval)

                while (attempts < maxAttempts) {
                    try {
                        const response = await fetch(`/extract-data/result/${sessionId}`);
                        if (!response.ok) {
                            console.error('[Polling] Napaka pri pridobivanju rezultata:', response.status);
                            throw new Error('Napaka pri pridobivanju rezultata');
                        }

                        const result = await response.json();
                        console.log('[Polling] Rezultat:', result);

                        if (result.status === 'completed') {
                            console.log('[Polling] Proces končan, vračam rezultate');
                            return result;
                        } else if (result.status === 'error') {
                            console.error('[Polling] Napaka pri procesiranju:', result.message);
                            return result;
                        }

                        // Status je še vedno "processing", čakaj malo in poskusi ponovno
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        attempts++;
                    } catch (error) {
                        console.error('[Polling] Napaka:', error);
                        throw error;
                    }
                }

                throw new Error('Timeout - procesiranje traja predolgo');
            },

            async pollForAnalyzeResult(sessionId) {
                console.log('[Polling] Začenjam polling za rezultate analize:', sessionId);
                let attempts = 0;
                const maxAttempts = 300; // 5 minut (1s interval)

                while (attempts < maxAttempts) {
                    try {
                        const response = await fetch(`/analyze-report/result/${sessionId}`);
                        if (!response.ok) {
                            console.error('[Polling] Napaka pri pridobivanju rezultata analize:', response.status);
                            throw new Error('Napaka pri pridobivanju rezultata');
                        }

                        const result = await response.json();
                        console.log('[Polling] Rezultat analize:', result);

                        if (result.status === 'completed') {
                            console.log('[Polling] Analiza končana, vračam rezultate');
                            return result;
                        } else if (result.status === 'error') {
                            console.error('[Polling] Napaka pri analizi:', result.message);
                            return result;
                        }

                        // Status je še vedno "processing", čakaj malo in poskusi ponovno
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        attempts++;
                    } catch (error) {
                        console.error('[Polling] Napaka:', error);
                        throw error;
                    }
                }

                throw new Error('Timeout - analiza traja predolgo');
            },

            showLoading(message) {
                // Ne prikazuj overlay-ja z blur efektom, ampak dodaj processing indikator na Step 2
                const step2Circle = document.querySelector('#step-2 .step-circle');
                if (step2Circle) {
                    step2Circle.classList.add('processing');
                }
                // Loading message lahko še vedno shranimo (za debugging ali future use)
                document.getElementById('loading-message').textContent = message;
            },

            hideLoading() {
                // Odstrani processing indikator iz Step 2
                const step2Circle = document.querySelector('#step-2 .step-circle');
                if (step2Circle) {
                    step2Circle.classList.remove('processing');
                }
            },

            showToast(type, title, message) {
                const toast = document.getElementById('toast');
                toast.className = `toast toast-${type}`;
                document.getElementById('toast-title').textContent = title;
                document.getElementById('toast-message').textContent = message;
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => toast.classList.remove('show'), 4000);
            },

            // Local Session Management
            async saveSession() {
                try {
                    // Convert files to base64 for storage
                    const filesData = await Promise.all(this.files.map(async (file) => {
                        const arrayBuffer = await file.arrayBuffer();
                        const bytes = new Uint8Array(arrayBuffer);
                        let binary = '';
                        for (let i = 0; i < bytes.byteLength; i++) {
                            binary += String.fromCharCode(bytes[i]);
                        }
                        return {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: btoa(binary)
                        };
                    }));

                    const sessionData = {
                        files: filesData,
                        filesMeta: this.filesMeta,
                        currentStep: this.currentStep,
                        stevilkaZadeve: document.getElementById('stevilka-zadeve')?.value || '',
                        eupRabaPairs: this.eupRabaPairs,
                        keyData: this.keyData,
                        results: this.results,
                        sessionId: this.sessionId,
                        timestamp: new Date().toISOString()
                    };

                    localStorage.setItem('mnenja_local_session', JSON.stringify(sessionData));
                    this.showToast('success', 'Seja shranjena', 'Lokalna seja je bila uspešno shranjena');
                } catch (error) {
                    console.error('Napaka pri shranjevanju seje:', error);
                    this.showToast('error', 'Napaka', 'Ni bilo mogoče shraniti seje');
                }
            },

            async loadSession() {
                // Check if there's a local session
                if (!this.hasLocalSession()) {
                    this.showToast('info', 'Ni seje', 'Ni shranjene lokalne seje');
                    return;
                }

                if (this.files.length > 0 && !confirm('Ali želite naložiti shranjeno sejo? Trenutne datoteke bodo zamenjane.')) {
                    return;
                }

                try {
                    const sessionData = JSON.parse(localStorage.getItem('mnenja_local_session'));

                    // Restore files from base64
                    this.files = await Promise.all(sessionData.files.map(async (fileData) => {
                        const binary = atob(fileData.data);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) {
                            bytes[i] = binary.charCodeAt(i);
                        }
                        return new File([bytes], fileData.name, { type: fileData.type });
                    }));

                    this.filesMeta = sessionData.filesMeta || {};
                    this.currentStep = sessionData.currentStep || 1;
                    this.eupRabaPairs = sessionData.eupRabaPairs || [];
                    this.keyData = sessionData.keyData || {};
                    this.results = sessionData.results || [];
                    this.sessionId = sessionData.sessionId || null;

                    // Restore UI
                    if (sessionData.stevilkaZadeve) {
                        document.getElementById('stevilka-zadeve').value = sessionData.stevilkaZadeve;
                    }

                    this.renderFileList();
                    this.updatePdfPreviewButton();

                    if (this.currentStep >= 2) {
                        this.renderEupRabaPairs();
                        this.renderKeyData();
                    }

                    if (this.currentStep >= 3) {
                        this.renderResults();
                    }

                    this.updateUI();
                    this.updateStepAccess();

                    const timestamp = new Date(sessionData.timestamp).toLocaleString('sl-SI');
                    this.showToast('success', 'Seja naložena', `Seja iz ${timestamp} je bila naložena`);
                } catch (error) {
                    console.error('Napaka pri nalaganju seje:', error);
                    this.showToast('error', 'Napaka', 'Ni bilo mogoče naložiti seje');
                }
            },

            clearLocalSession() {
                localStorage.removeItem('mnenja_local_session');
                this.showToast('info', 'Seja izbrisana', 'Lokalna seja je bila izbrisana');
            },

            hasLocalSession() {
                return localStorage.getItem('mnenja_local_session') !== null;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>